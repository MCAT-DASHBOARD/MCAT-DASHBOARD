<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dr. Bob's MCAT v5.15 · Live</title>
<style>
/*
 * ═══════════════════════════════════════════════════════════════
 * GLOBAL READABILITY RULES — APPLY TO ALL COMPONENTS
 * ═══════════════════════════════════════════════════════════════
 * Labels/keys:       #00ccdd (cyan), 11px+, bold
 * Section titles:    #ffffff (bright white), 15px+, bold
 * Body text:         #b0b0bc on cards, #d0d0d8 in tooltips/popups
 * Tooltip titles:    #00ccdd (cyan), 14px+, bold
 * Tooltip body:      #d0d0d8 (bright grey), 13px+, line-height 1.5
 * MINIMUM font size: 12px for anything the user needs to read
 * NEVER use dim grey (#888, #999, <#b0b0bc) for readable content
 * Tooltips:          min-width 280px, padding 14px+, allow wrapping
 * ═══════════════════════════════════════════════════════════════
 */
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400&display=swap');
:root{
  --bg:#141414;--bg2:#1c1c1c;--bg3:#242424;--bg4:#2e2e2e;
  --border:#2e2e2e;--text:#f0ece4;--sub:#8a8a9a;--label:#a09080;--dim:#1e1e1e;
  --green:#00dd88;--amber:#ffaa00;--red:#ff5050;
  --blue:#5599ff;--purple:#b088ff;--cyan:#00ccdd;--hot:#ff6b35;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;}

/* HEADER */
header{padding:14px 24px;background:var(--bg2);border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;
  position:sticky;top:0;z-index:100;}
.logo{display:flex;align-items:center;gap:12px;}
.logo-box{width:42px;height:42px;border-radius:8px;background:linear-gradient(135deg,#2a1f00,#3d2e00);
  border:1px solid rgba(255,170,0,0.3);display:flex;align-items:center;justify-content:center;
  font-family:'Space Mono',monospace;font-size:10px;font-weight:700;color:var(--amber);}
.logo-text h1{font-size:17px;font-weight:800;letter-spacing:-0.3px;}
.logo-text h1 span{color:var(--amber);}
.logo-text .sub{font-size:10px;font-family:'Space Mono',monospace;color:var(--sub);margin-top:2px;}
.vb{font-size:8px;background:rgba(255,170,0,0.12);color:var(--amber);padding:2px 6px;
  border-radius:3px;margin-left:6px;font-family:'Space Mono',monospace;vertical-align:middle;}
.hdr-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.status-pill{display:flex;align-items:center;gap:6px;background:var(--bg3);
  border:1px solid var(--border);border-radius:6px;padding:6px 12px;}
.status-dot{width:7px;height:7px;border-radius:50%;}
.status-dot.live{background:var(--green);box-shadow:0 0 8px var(--green);animation:pulse 2s infinite;}
.status-dot.fetching{background:var(--amber);animation:pulse .5s infinite;}
.status-dot.stale{background:var(--amber);}
.status-dot.error{background:var(--red);}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.status-text{font-size:10px;font-family:'Space Mono',monospace;color:var(--sub);}
.refresh-btn{display:flex;align-items:center;gap:6px;background:var(--bg3);border:1px solid var(--border);
  border-radius:6px;padding:6px 14px;cursor:pointer;font-size:11px;font-family:'Space Mono',monospace;
  color:var(--text);transition:all .15s;}
.refresh-btn:hover{border-color:var(--amber);color:var(--amber);}
.settings-btn{display:flex;align-items:center;gap:6px;background:rgba(0,204,221,0.08);
  border:1px solid rgba(0,204,221,0.25);border-radius:6px;padding:6px 14px;
  cursor:pointer;font-size:11px;font-family:'Space Mono',monospace;
  color:var(--cyan);transition:all .15s;}
.settings-btn:hover{border-color:var(--cyan);background:rgba(0,204,221,0.16);}
.settings-btn .gear{font-size:13px;line-height:1;transition:transform .4s;}
.settings-btn:hover .gear{transform:rotate(60deg);}
@keyframes spin{to{transform:rotate(360deg)}}
.spinning{animation:spin .8s linear infinite;display:inline-block;}

/* GUIDE BAR */
.guide-wrap{position:relative;}
.guide-bar{padding:9px 24px;background:linear-gradient(90deg,rgba(85,153,255,0.18),rgba(85,153,255,0.03));
  border-bottom:1px solid var(--border);border-left:4px solid var(--blue);
  display:flex;align-items:center;gap:10px;cursor:pointer;user-select:none;}
.guide-bar:hover{background:linear-gradient(90deg,rgba(85,153,255,0.26),rgba(85,153,255,0.05));}
.guide-label{font-size:9px;font-family:'Space Mono',monospace;color:#88aaff;letter-spacing:2px;}
.guide-hint{font-size:10px;color:#88aaff;margin-left:auto;opacity:.6;}
.guide-panel{display:none;position:absolute;top:100%;left:0;right:0;z-index:90;
  background:#1a1a1a;border-bottom:2px solid rgba(255,170,0,0.4);
  padding:20px 24px;box-shadow:0 8px 32px rgba(0,0,0,0.5);}
.guide-bar:hover .guide-panel{display:block;}
.guide-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;}
.guide-section{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:14px 16px;}
.guide-section h4{font-size:9px;font-family:'Space Mono',monospace;letter-spacing:1.5px;margin-bottom:10px;}
.guide-row{display:flex;gap:8px;margin-bottom:8px;align-items:flex-start;font-size:11px;line-height:1.55;color:#b0b0bc;}
.gk{font-family:'Space Mono',monospace;font-size:8px;padding:3px 7px;border-radius:3px;flex-shrink:0;margin-top:2px;white-space:nowrap;}

/* GATE */
.gate{margin:14px 24px;background:var(--bg2);border:1px solid #3a3020;
  border-left:4px solid var(--amber);border-radius:10px;overflow:visible;}
.gate-top{padding:12px 18px;background:rgba(255,170,0,0.05);border-bottom:1px solid rgba(255,170,0,0.12);
  display:flex;align-items:center;gap:12px;flex-wrap:wrap;overflow:visible;position:relative;}
.gate-led{width:9px;height:9px;border-radius:50%;flex-shrink:0;}
.gate-led.open{background:var(--green);box-shadow:0 0 10px var(--green);animation:pulse 2s infinite;}
.gate-led.closed{background:var(--sub);}
.gate-led.warning{background:var(--red);box-shadow:0 0 10px var(--red);animation:pulse 1s infinite;}
/* ── Global Macro Strip ── */
.macro-strip{display:flex;align-items:center;gap:0;padding:9px 24px;
  background:#141422;border-bottom:1px solid rgba(255,255,255,0.06);
  position:sticky;top:0;z-index:100;font-family:'Space Mono',monospace;
  flex-wrap:wrap;min-height:44px;}
.ms-tier{position:relative;cursor:help;margin-right:6px;}
.ms-tier-badge{padding:5px 16px;border-radius:4px;font-size:15px;font-weight:800;letter-spacing:1.5px;}
.ms-green{background:rgba(0,221,136,0.2);color:var(--green);border:1px solid rgba(0,221,136,0.4);}
.ms-amber{background:rgba(255,170,0,0.15);color:var(--amber);border:1px solid rgba(255,170,0,0.35);}
.ms-red{background:rgba(255,80,80,0.15);color:var(--red);border:1px solid rgba(255,80,80,0.35);}
.ms-capitulation{background:rgba(176,136,255,0.2);color:var(--purple);border:1px solid rgba(176,136,255,0.4);animation:badge-pulse 2s ease-in-out infinite;}
.ms-tier-tooltip{display:none;position:absolute;top:110%;left:0;background:#1e1e32;border:1px solid var(--border);
  border-radius:8px;padding:14px 18px;font-size:11px;color:#b0b0bc;z-index:101;
  box-shadow:0 4px 12px rgba(0,0,0,0.4);line-height:1.6;min-width:320px;max-width:480px;white-space:normal;}
/* GLOBAL TOOLTIP TEXT RULE: cyan titles 14px+, body text #b0b0bc→#d0d0d8 for contrast, min 12px. Never below 12px in any tooltip. */
.ms-tier-tooltip .ms-tt-rule{color:#00ccdd;font-weight:700;font-size:14px;margin-bottom:6px;}
.ms-tier-tooltip .ms-tt-plain{color:#d0d0d8;font-size:13px;line-height:1.5;}
.ms-tier:hover .ms-tier-tooltip{display:block;}
.ms-title{font-size:13px;color:#00ccdd;font-weight:700;letter-spacing:1.5px;white-space:nowrap;}
.ms-title.flash{animation:ms-flash 4s ease-out;}
@keyframes ms-flash{
  0%{color:#ffaa00;text-shadow:0 0 20px rgba(255,170,0,0.9),0 0 40px rgba(255,170,0,0.4);transform:scale(1.15);}
  15%{color:#ffffff;text-shadow:0 0 14px rgba(0,204,221,0.7);transform:scale(1.08);}
  100%{color:#00ccdd;text-shadow:none;transform:scale(1);}
}
.ms-sep{width:1px;height:20px;background:rgba(255,255,255,0.1);margin:0 14px;}
.ms-item{display:flex;align-items:center;gap:6px;}
.ms-label{font-size:11px;color:#00ccdd;letter-spacing:1px;font-weight:700;}
.ms-val{font-size:15px;color:var(--text);font-weight:600;}
.ms-val-green{color:var(--green);}
.ms-val-red{color:var(--red);}
.ms-val-amber{color:var(--amber);}
.ms-val-dim{color:#b0b0bc;}
.ms-val-purple{color:var(--purple);}
.ms-boundary{font-size:10px;color:var(--amber);margin-left:4px;opacity:0.8;}

.gate-eyebrow{font-size:18px;font-family:'Space Mono',monospace;color:#ffffff;letter-spacing:2px;font-weight:800;}

/* Gate status with tooltip */
.gate-status-wrap{position:relative;display:inline-block;}
.gate-status{font-size:17px;font-weight:800;cursor:help;border-bottom:1px dashed rgba(255,255,255,0.2);}
.gate-tooltip{display:none;position:absolute;top:calc(100% + 12px);left:-50px;z-index:200;
  background:#141420;border:1px solid rgba(255,255,255,0.12);border-radius:10px;
  padding:18px 22px;width:400px;box-shadow:0 10px 32px rgba(0,0,0,0.7);font-size:12px;line-height:1.7;}
.gate-status-wrap:hover .gate-tooltip{display:block;}
.gate-status-wrap::after{content:'';position:absolute;top:100%;left:0;width:100%;height:14px;}
.gt-row{display:flex;gap:10px;margin-bottom:10px;align-items:flex-start;color:#b0b0bc;font-size:12px;line-height:1.6;}
.gt-key{font-family:'Space Mono',monospace;font-size:9px;padding:3px 8px;border-radius:4px;
  flex-shrink:0;margin-top:2px;white-space:nowrap;font-weight:700;}

.gate-body{padding:14px 18px;display:flex;align-items:flex-start;gap:20px;flex-wrap:wrap;}
.gate-desc{font-size:12px;line-height:1.7;max-width:500px;flex:1;min-width:200px;color:#b0b0bc;}
.gate-readings{display:flex;gap:12px;flex-shrink:0;flex-wrap:wrap;}
.reading{background:var(--bg3);border:1px solid var(--border);border-radius:8px;
  padding:12px 16px;text-align:center;min-width:82px;}
.reading-label{font-size:11px;font-family:'Space Mono',monospace;color:#00ccdd;letter-spacing:1px;margin-bottom:6px;font-weight:700;}
.reading-val{font-size:28px;font-weight:800;font-family:'Space Mono',monospace;line-height:1;}
.reading-trend{font-size:22px;font-weight:700;margin-top:4px;line-height:1;}
.reading-sub{font-size:9px;font-family:'Space Mono',monospace;margin-top:5px;padding:2px 6px;
  border-radius:3px;display:inline-block;}
.rsub-floor{background:rgba(0,221,136,0.12);color:var(--green);}
.rsub-low{background:rgba(255,170,0,0.12);color:var(--amber);}
.rsub-mid{background:rgba(85,153,255,0.12);color:var(--blue);}
.rsub-high{background:rgba(255,80,80,0.12);color:var(--red);}
.rsub-peak{background:rgba(255,80,80,0.2);color:var(--red);font-weight:700;}

/* SECTION BARS */
.sec-bar{padding:0;border-top:2px solid transparent;border-bottom:1px solid var(--border);
  display:flex;align-items:stretch;flex-wrap:wrap;position:relative;}
.sec-bar-inner{display:flex;align-items:center;gap:10px;flex:1;padding:11px 20px;flex-wrap:wrap;}
.sec-tag{font-size:10px;font-family:'Space Mono',monospace;font-weight:700;
  padding:3px 10px;border-radius:4px;letter-spacing:1px;white-space:nowrap;}
/* HOT */
.sec-bar-hot{background:linear-gradient(90deg,rgba(255,107,53,0.18),rgba(255,107,53,0.04));border-top-color:var(--hot);}
.sec-tag-hot{background:rgba(255,107,53,0.25);color:var(--hot);}
.sec-bar-hot .sec-tickers{color:rgba(255,107,53,0.6);}
/* REFERENCE */
.sec-bar-ref{background:linear-gradient(90deg,rgba(200,190,175,0.12),rgba(200,190,175,0.02));border-top-color:#c8bfaf;}
.sec-tag-ref{background:rgba(200,190,175,0.15);color:#c8bfaf;}
.sec-bar-ref .sec-tickers{color:rgba(200,190,175,0.6);}
/* CORE */
.sec-bar-core{background:linear-gradient(90deg,rgba(255,170,0,0.15),rgba(255,170,0,0.03));border-top-color:var(--amber);}
.sec-tag-core{background:rgba(255,170,0,0.22);color:var(--amber);}
.sec-bar-core .sec-tickers{color:rgba(255,170,0,0.65);}
/* TIER 1 */
.sec-bar-t1{background:linear-gradient(90deg,rgba(85,153,255,0.14),rgba(85,153,255,0.03));border-top-color:var(--blue);}
.sec-tag-t1{background:rgba(85,153,255,0.2);color:var(--blue);}
.sec-bar-t1 .sec-tickers{color:rgba(85,153,255,0.6);}
/* TIER 2 */
.sec-bar-t2{background:linear-gradient(90deg,rgba(0,204,221,0.12),rgba(0,204,221,0.02));border-top-color:var(--cyan);}
.sec-tag-t2{background:rgba(0,204,221,0.18);color:var(--cyan);}
.sec-bar-t2 .sec-tickers{color:rgba(0,204,221,0.6);}
/* WATCHLIST */
.sec-bar-watch{background:linear-gradient(90deg,rgba(176,136,255,0.14),rgba(176,136,255,0.03));border-top-color:var(--purple);}
.sec-tag-watch{background:rgba(176,136,255,0.2);color:var(--purple);}
.sec-bar-watch .sec-tickers{color:rgba(176,136,255,0.6);}

.sec-tickers{font-size:10px;font-family:'Space Mono',monospace;letter-spacing:0.5px;}
.sec-hint{font-size:9px;color:var(--sub);opacity:.5;margin-left:auto;}
.sec-add-btn{display:flex;align-items:center;justify-content:center;gap:8px;
  padding:10px 28px;font-size:13px;font-family:'Space Mono',monospace;font-weight:700;
  cursor:pointer;border:none;border-left:1px solid var(--border);
  background:transparent;transition:all .2s;white-space:nowrap;min-width:120px;}
.sec-bar-core  .sec-add-btn{color:var(--amber);background:rgba(255,170,0,0.10);}
.sec-bar-core  .sec-add-btn:hover{background:rgba(255,170,0,0.20);color:#ffd040;}
.sec-bar-t1    .sec-add-btn{color:var(--blue); background:rgba(85,153,255,0.10);}
.sec-bar-t1    .sec-add-btn:hover{background:rgba(85,153,255,0.22);color:#88bbff;}
.sec-bar-t2    .sec-add-btn{color:var(--cyan); background:rgba(0,204,221,0.09);}
.sec-bar-t2    .sec-add-btn:hover{background:rgba(0,204,221,0.20);color:#33ddee;}
.sec-bar-watch .sec-add-btn{color:var(--purple);background:rgba(176,136,255,0.10);}
.sec-bar-ref   .sec-add-btn{color:#a09080;background:rgba(122,112,96,0.10);}
.sec-bar-watch .sec-add-btn:hover{background:rgba(176,136,255,0.22);color:#cc99ff;}
.sec-add-plus{font-size:18px;line-height:1;font-weight:400;}

/* GRIDS */
.hot-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));gap:14px;
  padding:14px 24px;background:rgba(255,107,53,0.02);border-bottom:1px solid var(--border);}
.main-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:14px;padding:14px 24px;}
.section-group{border-bottom:1px solid var(--border);padding-bottom:4px;margin-bottom:0;}

/* DROP ZONE */
.drop-zone{border:2px dashed rgba(255,107,53,0.3);border-radius:12px;
  display:flex;align-items:center;justify-content:center;min-height:80px;
  font-size:10px;font-family:'Space Mono',monospace;color:rgba(255,107,53,0.4);
  letter-spacing:1px;transition:all .2s;}
.drop-zone.drag-active{border-color:var(--hot);color:var(--hot);background:rgba(255,107,53,0.05);}

/* CARD */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;
  overflow:hidden;transition:transform .12s,border-color .12s;display:flex;flex-direction:column;position:relative;min-width:0;}
.card:hover{transform:translateY(-2px);border-color:#3e3e3e;}
.card.hot-card{border-color:rgba(255,107,53,0.35);}
.card.hot-card:hover{border-color:rgba(255,107,53,0.65);}
.card.dragging{opacity:.4;transform:scale(.98);}
.card.drag-over{border-color:var(--amber)!important;border-style:dashed;}
.drag-handle{position:absolute;top:10px;right:10px;cursor:grab;opacity:0;
  font-size:14px;color:var(--sub);transition:opacity .15s;z-index:5;}
.card:hover .drag-handle{opacity:.5;}
.hot-toggle{cursor:pointer;font-size:11px;font-family:'Space Mono',monospace;
  padding:2px 6px;border-radius:3px;transition:all .15s;white-space:nowrap;}
.hot-toggle.hot-on{background:rgba(255,107,53,0.15);color:var(--hot);border:1px solid rgba(255,107,53,0.3);}
.hot-toggle.hot-on:hover{background:rgba(255,107,53,0.3);}
.hot-toggle.hot-off{background:rgba(80,80,80,0.15);color:var(--sub);border:1px solid rgba(120,120,120,0.2);}
.hot-toggle.hot-off:hover{background:rgba(255,107,53,0.1);color:var(--hot);border-color:rgba(255,107,53,0.2);}

/* Card stripes */
.stripe{height:4px;}
.stripe-ACCUMULATE{background:linear-gradient(90deg,var(--green),#00ffaa);}
.stripe-WATCH_ENTRY{background:linear-gradient(90deg,var(--amber),#ffcc55);}
.stripe-MONITOR{background:linear-gradient(90deg,var(--sub),#4a4a4a);}
.stripe-EXTENDED{background:linear-gradient(90deg,var(--red),#ff7070);}
.stripe-WATCH_ENTRY{background:linear-gradient(90deg,var(--purple),var(--blue));}
.stripe-MONITOR{background:linear-gradient(90deg,var(--blue),var(--cyan));}
.stripe-EXTENDED{background:linear-gradient(90deg,var(--red),#ff8855);}

/* Card head */
.card-head{padding:14px 16px 10px;}
.ticker-row{display:flex;align-items:baseline;gap:10px;justify-content:space-between;flex-wrap:wrap;}
.ticker-left{display:flex;align-items:baseline;gap:10px;}
.ticker{font-size:26px;font-weight:800;letter-spacing:-1px;line-height:1;}
.price{font-family:'Space Mono',monospace;font-size:18px;font-weight:700;}
.fullname{font-size:11px;color:#b0b0bc;margin-top:3px;font-style:italic;}
.badge-row{display:flex;align-items:center;gap:7px;margin-top:8px;flex-wrap:wrap;}

/* Signal pill with hover tooltip */
.sig-wrap{position:relative;display:inline-block;}
.sig-pill{font-size:10px;font-weight:700;font-family:'Space Mono',monospace;
  padding:4px 10px;border-radius:5px;white-space:nowrap;cursor:help;
  border-bottom:1px dashed rgba(255,255,255,0.15);}
.sig-ACCUMULATE_CONFIRMED{background:rgba(0,221,136,0.15);color:#00dd88;border:1px solid rgba(0,221,136,0.35);}
.sig-ACCUMULATE_WATCH{background:rgba(74,222,128,0.12);color:#4ade80;border:1px solid rgba(74,222,128,0.30);}
.sig-ACCUMULATE{background:rgba(0,221,136,0.15);color:#00dd88;border:1px solid rgba(0,221,136,0.35);}
.sig-WATCH_ENTRY{background:rgba(255,170,0,0.15);color:var(--amber);}
.sig-MONITOR{background:rgba(85,153,255,0.15);color:var(--blue);}
.sig-EXTENDED{background:rgba(255,80,80,0.15);color:var(--red);}

/* Signal tooltip */
.sig-tooltip{display:none;position:absolute;top:calc(100% + 6px);right:0;z-index:200;
  background:#1a1a1a;border:1px solid var(--border);border-radius:8px;
  padding:14px 16px;width:320px;box-shadow:0 8px 24px rgba(0,0,0,0.7);}
.sig-wrap:hover .sig-tooltip{display:block;}
.sig-tt-title{font-size:10px;font-family:'Space Mono',monospace;color:#b0b0bc;
  letter-spacing:2px;margin-bottom:10px;}
.sig-tt-row{display:flex;gap:8px;margin-bottom:7px;align-items:flex-start;font-size:11px;line-height:1.5;color:#b0b0bc;}
.sig-tt-row.active-sig .sig-tt-label{box-shadow:0 0 0 1px currentColor;}
.sig-tt-row.active-sig .sig-tt-text{color:var(--text);}
.sig-tt-label{font-family:'Space Mono',monospace;font-size:9px;padding:2px 6px;
  border-radius:3px;flex-shrink:0;margin-top:2px;white-space:nowrap;}

.ma-badge{font-size:12px;font-family:'Space Mono',monospace;font-weight:700;}
.hot-badge{font-size:10px;font-family:'Space Mono',monospace;
  background:rgba(255,107,53,0.15);color:var(--hot);padding:2px 7px;border-radius:3px;}
.lim-badge{font-size:10px;font-family:'Space Mono',monospace;
  background:rgba(255,80,80,0.1);color:var(--red);padding:2px 7px;border-radius:3px;}
.tier-badge{font-size:10px;font-family:'Space Mono',monospace;padding:2px 7px;border-radius:3px;}
.tier-group{display:flex;align-items:center;gap:6px;margin-left:auto;}

/* Layer 2 */
.divider{height:1px;background:var(--border);}
.l2{padding:10px 16px 10px;}
.layer-title{font-size:10px;font-family:'Space Mono',monospace;letter-spacing:2px;font-weight:700;
  margin-bottom:9px;display:flex;align-items:center;gap:6px;}
.layer-title-bar{width:14px;height:2px;border-radius:1px;display:inline-block;flex-shrink:0;}
.l1{padding:8px 14px;}
.l1-strip{display:flex;align-items:center;gap:10px;font-size:10px;font-family:'Space Mono',monospace;}
.l1-gate-pill{padding:3px 8px;border-radius:4px;font-size:10px;font-weight:700;letter-spacing:1px;white-space:nowrap;}
.l1-gate-pill.open{background:rgba(0,221,136,0.15);color:var(--green);border:1px solid rgba(0,221,136,0.3);}
.l1-gate-pill.warn{background:rgba(255,80,80,0.12);color:var(--red);border:1px solid rgba(255,80,80,0.25);}
.l1-gate-pill.monitoring{background:rgba(255,170,0,0.12);color:var(--amber);border:1px solid rgba(255,170,0,0.25);}
.l1-vals{display:flex;gap:8px;color:var(--sub);}
.l1-val-item{display:flex;align-items:center;gap:3px;}
.l1-tf{font-size:9px;color:#b0b0bc;}
.bar-row{display:grid;grid-template-columns:26px 1fr 40px 16px;align-items:center;gap:8px;margin-bottom:7px;}
.bar-lbl{font-size:10px;font-family:'Space Mono',monospace;color:#b0b0bc;}
.bar-lbl.key{color:var(--text);font-weight:600;}
.bar-track{height:8px;background:var(--dim);border-radius:4px;overflow:hidden;position:relative;}
.bar-track::before{content:'';position:absolute;left:25%;top:0;height:100%;width:1px;background:rgba(255,255,255,0.06);}
.bar-track::after{content:'';position:absolute;left:75%;top:0;height:100%;width:1px;background:rgba(255,255,255,0.06);}
.bar-fill{height:100%;border-radius:4px;transition:width .5s ease;}
.bar-val{font-family:'Space Mono',monospace;font-size:11px;font-weight:700;text-align:right;}
.bar-arr{font-size:14px;font-weight:700;text-align:center;line-height:1;}
.arr-legend{font-size:10px;font-family:'Space Mono',monospace;color:#b0b0bc;opacity:0.65;margin-top:4px;display:flex;gap:10px;}
.arr-legend span{display:flex;align-items:center;gap:3px;}

/* Layer 3 */
.l3{padding:8px 16px 10px;background:rgba(176,136,255,0.02);border-top:1px solid rgba(176,136,255,0.08);}
.l3-grid{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;margin-top:6px;}
.l3-cell{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:8px 11px;}
.l3-cell.key{border-color:rgba(176,136,255,0.2);}
.l3-cell.key.firing{border-color:var(--purple);box-shadow:0 0 8px rgba(176,136,255,0.18);}
.l3-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
.l3-name{font-size:10px;font-family:'Space Mono',monospace;color:#b0b0bc;}
.l3-name.key-lbl{color:#ffffff;font-weight:700;font-size:11px;}
.l3-arr{font-size:14px;font-weight:700;}
.l3-bar{height:5px;background:rgba(255,255,255,0.05);border-radius:3px;overflow:hidden;margin-bottom:5px;}
.l3-fill{height:100%;border-radius:3px;transition:width .5s ease;}
.l3-val{font-family:'Space Mono',monospace;font-size:13px;font-weight:700;}

/* Score / State row — WIDE PILL (Option C) */
.score-row{padding:8px 16px 10px;border-top:1px solid rgba(176,136,255,0.08);
  display:flex;align-items:center;justify-content:space-between;}
.dots{display:flex;gap:5px;}
.dot{width:11px;height:11px;border-radius:50%;transition:all .3s;}
.dot.on{background:var(--purple);box-shadow:0 0 6px rgba(176,136,255,0.5);}
.dot.off{background:var(--bg4);border:1px solid var(--border);}

/* Wide pill → slim pill */
.wide-pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;
  border-radius:5px;cursor:help;white-space:nowrap;}
.wide-pill-state{font-size:9px;font-family:'Space Mono',monospace;font-weight:700;}
.wide-pill-extra{font-size:9px;font-family:'Space Mono',monospace;opacity:.75;}
.wp-WAIT     {background:var(--bg4);border:1px solid #3a3a3a;color:var(--label);}
.wp-AT_FLOOR {background:rgba(255,170,0,.10);border:1px solid rgba(255,170,0,.25);color:var(--amber);}
.wp-NEAR     {background:rgba(176,136,255,.15);border:1px solid rgba(176,136,255,.35);color:var(--purple);}
.wp-TURNING  {background:rgba(85,153,255,.08);border:1px solid rgba(85,153,255,.25);color:var(--blue);}
.wp-ENTRY_NOW{background:rgba(0,221,136,.12);border:1px solid rgba(0,221,136,.35);color:var(--green);}

/* State tooltip — fixed width, stays inside card */
.state-wrap{position:relative;display:inline-block;}
.state-wrap:hover .state-tooltip{display:block;}
.state-tooltip{display:none;position:absolute;bottom:calc(100% + 8px);right:-8px;z-index:200;
  background:#1c1c1c;border:1px solid #383838;border-radius:10px;
  padding:15px 17px;width:290px;box-shadow:0 10px 32px rgba(0,0,0,.9);}
.st-title{font-size:8px;font-family:'Space Mono',monospace;color:var(--sub);letter-spacing:2px;margin-bottom:12px;}
.st-row{display:flex;gap:8px;margin-bottom:8px;align-items:flex-start;font-size:11px;line-height:1.5;color:#b0b0bc;}
.st-row.active-state .st-key{box-shadow:0 0 0 1px currentColor;}
.st-row.active-state .st-desc{color:var(--text);}
.st-key{font-family:'Space Mono',monospace;font-size:8px;padding:2px 6px;border-radius:3px;
  flex-shrink:0;margin-top:2px;white-space:nowrap;}
.state-ENTRY_NOW{background:rgba(0,221,136,0.12);color:var(--green);}
.state-NEAR{background:rgba(176,136,255,0.12);color:var(--purple);}
.state-AT_FLOOR{background:rgba(255,170,0,0.12);color:var(--amber);}
.state-TURNING{background:rgba(85,153,255,0.12);color:var(--blue);}
.state-WAIT{background:var(--bg4);color:var(--label);}

/* 4H rule box inside tooltip */
.tt-4h{margin-top:11px;padding:10px 12px;border-radius:7px;border:1px solid;}
.tt-4h-waiting{background:rgba(122,112,96,.06);border-color:rgba(122,112,96,.22);}
.tt-4h-armed  {background:rgba(255,170,0,.05); border-color:rgba(255,170,0,.28);}
.tt-4h-fired  {background:rgba(0,221,136,.05); border-color:rgba(0,221,136,.3);}
.tt-4h-title{font-size:8px;font-family:'Space Mono',monospace;letter-spacing:1.5px;margin-bottom:6px;}
.tt-4h-waiting .tt-4h-title{color:var(--label);}
.tt-4h-armed   .tt-4h-title{color:var(--amber);}
.tt-4h-fired   .tt-4h-title{color:var(--green);}
.tt-4h-rule{font-size:11px;line-height:1.6;color:#b0b0bc;}
.tt-4h-live{margin-top:6px;font-size:10px;font-family:'Space Mono',monospace;
  display:flex;align-items:center;gap:5px;flex-wrap:wrap;}

/* Entry target row */
.target-row{padding:8px 16px;display:flex;align-items:center;justify-content:space-between;
  border-top:1px solid rgba(255,80,80,.06);background:rgba(255,80,80,.02);}
.target-row.hit{background:rgba(0,221,136,.04);border-top-color:rgba(0,221,136,.1);}
.target-lbl{font-size:10px;font-family:'Space Mono',monospace;color:#b0b0bc;letter-spacing:1px;}
.target-lbl.hit{color:var(--green);}
.target-right{display:flex;align-items:center;gap:8px;}
.target-box{font-family:'Space Mono',monospace;font-size:13px;font-weight:700;
  padding:3px 10px;border-radius:5px;border:1px solid;}
.target-unset{border-color:#2a2a2a;color:#3d3d3d;font-size:10px;font-style:italic;background:transparent;}
.target-red{border-color:rgba(255,80,80,.4);color:var(--red);background:rgba(255,80,80,.08);}
.target-green{border-color:rgba(0,221,136,.5);color:var(--green);
  background:rgba(0,221,136,.1);box-shadow:0 0 10px rgba(0,221,136,.12);}
.pencil-btn{background:none;border:none;cursor:pointer;font-size:11px;
  color:var(--label);padding:3px 5px;border-radius:4px;transition:all .15s;}
.pencil-btn:hover{color:var(--amber);background:rgba(255,170,0,.1);}

/* ── 4H TRIGGER BOX — three-column compact ── */
.trigger-row{margin:0 16px 8px;padding:10px 14px;border-radius:8px;border:1px solid;
  display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:12px;}
.tr-waiting{background:rgba(122,112,96,.07);border-color:rgba(122,112,96,.22);}
.tr-armed  {background:rgba(255,170,0,.06); border-color:rgba(255,170,0,.28);}
.tr-fired  {background:rgba(0,221,136,.06); border-color:rgba(0,221,136,.28);}
.tr-lbl{font-size:10px;font-family:'Space Mono',monospace;letter-spacing:1px;font-weight:700;white-space:nowrap;}
.tr-waiting .tr-lbl{color:#b0b0bc;}
.tr-armed   .tr-lbl{color:var(--amber);}
.tr-fired   .tr-lbl{color:var(--green);}
.tr-center{text-align:center;display:flex;flex-direction:column;gap:2px;}
.tr-plain{font-size:11px;line-height:1.4;color:var(--text);}
.tr-tech{font-size:10px;line-height:1.4;color:var(--sub);font-family:'Space Mono',monospace;overflow-wrap:break-word;word-break:break-word;}
.tr-tech strong{color:var(--text);font-weight:700;}
.tr-right{display:flex;flex-direction:column;align-items:flex-end;gap:3px;}
.tr-badge{font-size:9px;font-family:'Space Mono',monospace;font-weight:700;
  padding:3px 10px;border-radius:4px;letter-spacing:1px;white-space:nowrap;}
.tr-waiting .tr-badge{background:rgba(122,112,96,.15);color:#b0b0bc;}
.tr-armed   .tr-badge{background:rgba(255,170,0,.15); color:var(--amber);}
.tr-fired   .tr-badge{background:rgba(0,221,136,.15); color:var(--green);}
.tr-val{font-size:14px;font-family:'Space Mono',monospace;font-weight:700;
  display:flex;align-items:center;gap:5px;white-space:nowrap;}
.tr-waiting .tr-val{color:#b0b0bc;}
.tr-armed   .tr-val{color:var(--amber);}
.tr-fired   .tr-val{color:var(--green);}
.tr-arrow{font-size:16px;font-weight:700;line-height:1;}
.tr-arrow-up{color:var(--green);}
.tr-arrow-down{color:var(--red);}


/* ── CONTEXT STRIP ── */
.ctx-strip{display:flex;align-items:center;gap:14px;padding:10px 24px;
  background:var(--bg2);border-bottom:1px solid var(--border);flex-wrap:wrap;position:relative;overflow:visible;z-index:50;}
.ctx-seg{display:flex;align-items:center;gap:6px;white-space:nowrap;}
.ctx-day{font-size:18px;font-weight:800;font-family:'Space Mono',monospace;color:var(--text);}
.ctx-day-sub{font-size:11px;color:#b0b0bc;font-family:'Space Mono',monospace;}
.ctx-progress{width:160px;height:10px;background:var(--bg4);border-radius:5px;position:relative;overflow:hidden;}
.ctx-prog-z1{position:absolute;left:0;top:0;height:100%;background:rgba(0,221,136,0.25);border-radius:5px 0 0 5px;}
.ctx-prog-z2{position:absolute;top:0;height:100%;background:rgba(255,170,0,0.25);}
.ctx-prog-z3{position:absolute;top:0;height:100%;background:rgba(255,80,80,0.2);border-radius:0 5px 5px 0;}
.ctx-prog-dot{position:absolute;top:-1px;width:12px;height:12px;border-radius:50%;
  background:var(--green);border:2px solid var(--bg2);z-index:2;transform:translateX(-50%);}
.ctx-prog-marker{position:absolute;top:0;width:1px;height:100%;background:rgba(255,255,255,0.15);}
.ctx-pill{font-size:10px;font-family:'Space Mono',monospace;font-weight:700;
  padding:4px 12px;border-radius:4px;letter-spacing:0.5px;}
.ctx-pill-green{background:rgba(0,221,136,0.12);color:var(--green);border:1px solid rgba(0,221,136,0.3);}
.ctx-pill-amber{background:rgba(255,170,0,0.12);color:var(--amber);border:1px solid rgba(255,170,0,0.3);}
.ctx-pill-red{background:rgba(255,80,80,0.12);color:var(--red);border:1px solid rgba(255,80,80,0.3);}
.ctx-pill-grey{background:rgba(152,152,168,0.08);color:#b0b0bc;border:1px solid rgba(152,152,168,0.2);}
.ctx-pill-purple{background:rgba(176,136,255,0.12);color:var(--purple);border:1px solid rgba(176,136,255,0.3);}
.ctx-countdown{display:flex;align-items:baseline;gap:5px;}
.ctx-countdown-val{font-size:20px;font-weight:800;font-family:'Space Mono',monospace;}
.ctx-countdown-date{font-size:13px;font-weight:700;color:#ffffff;}
.ctx-countdown-label{font-size:11px;color:#b0b0bc;font-family:'Space Mono',monospace;font-weight:700;}
.ctx-ev{font-size:12px;font-family:'Space Mono',monospace;font-weight:700;}
.ctx-conf-dots{display:flex;gap:3px;align-items:center;}
.ctx-dot{width:10px;height:10px;border-radius:50%;border:1.5px solid rgba(255,255,255,0.2);}
.ctx-dot-on{background:var(--green);border-color:var(--green);box-shadow:0 0 4px var(--green);}
.ctx-dot-off{background:rgba(255,255,255,0.08);border-color:rgba(255,255,255,0.25);}
.ctx-dot-pending{background:rgba(255,170,0,0.4);border-color:rgba(255,170,0,0.6);animation:ctx-pulse 2s ease-in-out infinite;}
@keyframes ctx-pulse{0%,100%{opacity:.4}50%{opacity:1}}
.ctx-conf-score{font-size:12px;font-family:'Space Mono',monospace;font-weight:700;color:#ffffff;}
/* Context strip tooltips */
.ctx-seg{position:relative;cursor:help;}
.ctx-tt{display:none;position:fixed;
  z-index:600;background:#141420;border:1px solid rgba(255,255,255,0.12);border-radius:10px;
  padding:18px 22px;width:360px;box-shadow:0 10px 32px rgba(0,0,0,0.8);font-size:12px;line-height:1.7;
  color:#b0b0bc;overflow-wrap:break-word;word-wrap:break-word;overflow:visible;
  white-space:normal;}
.ctx-tt::before{display:none;}
/* ctx-tt shown/hidden via JS — see ctxTooltipInit() */
.ctx-tt-title{font-size:10px;font-family:'Space Mono',monospace;font-weight:700;color:#00ccdd;
  letter-spacing:1.5px;margin-bottom:8px;}
.ctx-tt-body{color:#b0b0bc;font-size:12px;line-height:1.7;}
.ctx-tt-tech{margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.08);
  font-size:11px;font-family:'Space Mono',monospace;color:#b0b0bc;line-height:1.6;}

/* ── MQS + ENTRY OPTIMIZER PANEL ── */
.mqs-panel{background:var(--bg2);border-bottom:1px solid var(--border);overflow:visible;}
.mqs-header{display:flex;align-items:center;gap:24px;padding:18px 24px;flex-wrap:wrap;}
.mqs-block{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.mqs-block-title{font-size:13px;font-family:'Space Mono',monospace;letter-spacing:1.5px;color:#00ccdd;white-space:nowrap;font-weight:700;}
.mqs-block-row{display:flex;align-items:center;gap:6px;}
.mqs-ev-main{font-size:15px;font-family:'Space Mono',monospace;font-weight:700;white-space:nowrap;}
.mqs-ev-sub{font-size:12px;font-family:'Space Mono',monospace;color:#d0d0d8;}
.mqs-health{display:flex;align-items:center;gap:5px;font-size:11px;font-family:'Space Mono',monospace;color:#b0b0bc;}
.mqs-health-dot{width:9px;height:9px;border-radius:50%;}
.mqs-health-live{background:var(--green);}
.mqs-health-seed{background:var(--amber);}
.mqs-health-stale{background:var(--red);}
/* old expand bar removed — now using mqs-expand-btn-v2 in header */
.mqs-alert{font-size:12px;font-family:'Space Mono',monospace;}
.mqs-alert-normal{color:var(--sub);}
.mqs-alert-attention{color:var(--amber);animation:mqs-att-pulse 2s ease-in-out 3;}
@keyframes mqs-att-pulse{0%,100%{opacity:.6}50%{opacity:1}}
.mqs-alert-critical{color:var(--red);animation:mqs-crit-flash 1s ease-in-out infinite;}
@keyframes mqs-crit-flash{0%,100%{opacity:1}50%{opacity:.4}}
.mqs-details{display:none;padding:14px 24px;border-top:1px solid var(--border);margin-top:0;}
.mqs-panel.expanded .mqs-details{display:block;}
.mqs-inputs-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin-bottom:14px;}
.mqs-input-cell{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:8px 10px;}
.mqs-input-label{font-size:11px;font-family:'Space Mono',monospace;color:#00ccdd;letter-spacing:1px;margin-bottom:3px;font-weight:700;}
.mqs-input-val{font-size:13px;font-family:'Space Mono',monospace;font-weight:700;color:var(--text);}
.mqs-input-status{font-size:11px;font-family:'Space Mono',monospace;margin-top:2px;color:#b0b0bc;}
.mqs-triggers{margin-top:12px;}
.mqs-triggers-title{font-size:9px;font-family:'Space Mono',monospace;color:#00ccdd;letter-spacing:1px;margin-bottom:6px;}
.mqs-trigger-row{font-size:11px;color:#b0b0bc;line-height:1.7;}
.mqs-zones{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:12px;}
.mqs-zone-card{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:10px;text-align:center;}
.mqs-zone-card.active{border-color:var(--green);background:rgba(0,221,136,0.04);}
.mqs-zone-badge{font-size:10px;font-family:'Space Mono',monospace;font-weight:700;
  padding:2px 8px;border-radius:3px;letter-spacing:1px;display:inline-block;margin-bottom:4px;}
.mqs-zone-ev{font-size:14px;font-family:'Space Mono',monospace;font-weight:700;color:var(--text);}
.mqs-zone-sub{font-size:11px;font-family:'Space Mono',monospace;color:#b0b0bc;}

/* ── EXTREME BADGES ── */
.extreme-badge{display:inline-flex;align-items:center;gap:4px;font-size:10px;
  font-family:'Space Mono',monospace;font-weight:700;padding:3px 10px;border-radius:4px;
  letter-spacing:0.5px;white-space:nowrap;margin-right:4px;}
.badge-capitulation{background:rgba(176,136,255,0.15);color:var(--purple);border:1px solid rgba(176,136,255,0.35);animation:badge-pulse 2s ease-in-out infinite;}
.badge-macro-risk{background:rgba(255,80,80,0.12);color:var(--red);border:1px solid rgba(255,80,80,0.3);}
@keyframes badge-pulse{0%,100%{opacity:1;box-shadow:0 0 4px rgba(176,136,255,0.2);}50%{opacity:0.7;box-shadow:0 0 12px rgba(176,136,255,0.5);}}


/* ── GUIDE BUTTON (header) ── */
.guide-btn-wrap{position:relative;}
.guide-btn-wrap:hover{z-index:200;}
.guide-btn{display:flex;align-items:center;gap:6px;background:rgba(85,153,255,0.08);
  border:1px solid rgba(85,153,255,0.2);border-radius:8px;padding:7px 14px;
  cursor:pointer;font-size:12px;font-family:'Space Mono',monospace;font-weight:600;
  color:#88aaff;transition:all .15s;white-space:nowrap;}
.guide-btn:hover{border-color:#88aaff;background:rgba(85,153,255,0.16);}
.guide-btn .qmark{font-size:14px;line-height:1;}
.guide-panel-hdr{display:none;position:fixed;top:104px;left:50%;transform:translateX(-50%);z-index:1000;
  background:#111118;border:1px solid var(--border);border-radius:12px;
  box-shadow:0 12px 40px rgba(0,0,0,0.65);width:min(94vw,1100px);max-height:75vh;overflow-y:auto;
  padding:20px 24px;}
.guide-panel-hdr.open{display:block;}


.mqs-expand-btn-v2{display:flex;align-items:center;gap:6px;background:rgba(0,204,221,0.08);
  border:1px solid rgba(0,204,221,0.2);border-radius:6px;padding:8px 18px;
  cursor:pointer;font-size:11px;font-family:'Space Mono',monospace;font-weight:700;
  color:#00ccdd;letter-spacing:1px;transition:all .15s;white-space:nowrap;flex-shrink:0;}
.mqs-expand-btn-v2:hover{border-color:#00ccdd;background:rgba(0,204,221,0.16);}
.mqs-expand-btn-v2 .arrow{transition:transform .2s;font-size:12px;}
.mqs-panel.expanded .mqs-expand-btn-v2 .arrow{transform:rotate(180deg);}

/* Inline edit popup */
.edit-popup{display:none;padding:11px 16px;border-top:1px solid rgba(255,170,0,.25);
  background:#1a1a1a;}
.edit-popup.open{display:block;}
.edit-popup-ttl{font-size:10px;font-family:'Space Mono',monospace;color:var(--amber);
  letter-spacing:2px;margin-bottom:9px;}
.edit-popup-row{display:flex;gap:7px;align-items:center;}
.edit-input{flex:1;background:var(--bg3);border:1px solid #3a3a3a;border-radius:6px;
  padding:7px 11px;color:var(--text);font-size:13px;font-family:'Space Mono',monospace;outline:none;}
.edit-input:focus{border-color:var(--amber);}
.btn-set{background:var(--amber);color:#000;border:none;border-radius:6px;
  padding:7px 13px;font-family:'Space Mono',monospace;font-size:10px;font-weight:700;cursor:pointer;}
.btn-set:hover{background:#ffbb22;}
.btn-clr{background:rgba(255,80,80,.1);color:var(--red);
  border:1px solid rgba(255,80,80,.3);border-radius:6px;
  padding:7px 10px;font-family:'Space Mono',monospace;font-size:10px;cursor:pointer;}
.btn-clr:hover{background:rgba(255,80,80,.2);}
.edit-hint{font-size:10px;color:var(--label);margin-top:7px;font-family:'Space Mono',monospace;}

/* Alert */
.alert-row{padding:9px 16px 12px;border-top:1px solid rgba(255,255,255,0.04);
  font-size:11px;color:#b0b0bc;line-height:1.6;background:rgba(0,0,0,0.12);}

/* Fill/color utils */
.fill-low{background:var(--green);}
.fill-mid{background:var(--amber);}
.fill-high{background:var(--red);}
.col-low{color:var(--green);}
.col-mid{color:var(--amber);}
.col-high{color:var(--red);}
.up{color:var(--green);}
.dn{color:var(--red);}

/* ADD CARD MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.82);z-index:300;
  align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:#1e1e1e;border:1px solid #3a3a3a;border-radius:14px;
  padding:24px;width:480px;max-width:94vw;max-height:90vh;overflow-y:auto;}
.modal h3{font-size:17px;font-weight:800;margin-bottom:6px;margin-top:4px;}
.modal p{font-size:11px;color:#b0b0bc;margin-bottom:18px;line-height:1.6;}
.modal-step-label{font-size:10px;font-family:'Space Mono',monospace;letter-spacing:2px;
  margin-bottom:10px;padding:3px 8px;border-radius:3px;display:inline-block;margin-bottom:12px;}
.modal-field{margin-bottom:14px;}
.modal-field label{display:block;font-size:10px;font-family:'Space Mono',monospace;
  color:#b0b0bc;letter-spacing:1px;margin-bottom:6px;}
.modal-field input{width:100%;background:var(--bg3);border:1px solid var(--border);
  border-radius:6px;padding:9px 12px;color:var(--text);font-size:13px;font-family:'Space Mono',monospace;
  outline:none;transition:border-color .15s;}
.modal-field input:focus{border-color:var(--amber);}
.modal-link-box{background:var(--bg3);border:1px solid var(--border);border-radius:8px;
  padding:14px 16px;margin-bottom:14px;}
.modal-link{display:block;font-family:'Space Mono',monospace;font-size:11px;
  color:var(--amber);word-break:break-all;margin-top:2px;text-decoration:none;}
.modal-link:hover{text-decoration:underline;}
.modal-link-small{font-family:'Space Mono',monospace;font-size:10px;color:var(--blue);text-decoration:none;}
.modal-link-small:hover{text-decoration:underline;}
.modal-instruction{background:rgba(255,255,255,0.03);border:1px solid var(--border);
  border-radius:8px;padding:14px 16px;font-size:11px;color:#b0b0bc;line-height:2;}
.modal-upload-zone{background:var(--bg3);border:2px dashed var(--border);border-radius:10px;
  padding:32px;text-align:center;cursor:pointer;transition:all .15s;margin-bottom:12px;}
.modal-upload-zone:hover{border-color:var(--amber);background:rgba(255,170,0,0.04);}
.modal-row{display:flex;gap:8px;flex-wrap:wrap;}
.modal-btn{flex:1;padding:10px;border-radius:7px;border:none;cursor:pointer;
  font-family:'Space Mono',monospace;font-size:11px;font-weight:700;transition:all .15s;min-width:80px;}
.modal-btn.primary{background:var(--amber);color:#000;}
.modal-btn.primary:hover{background:#ffbb22;}
.modal-btn.primary:disabled{opacity:.35;cursor:not-allowed;}
.modal-btn.secondary{background:var(--bg4);color:#b0b0bc;border:1px solid var(--border);}
.modal-btn.secondary:hover{border-color:var(--sub);color:var(--text);}
.modal-btn.cancel{background:var(--bg3);color:#b0b0bc;border:1px solid var(--border);}
.modal-btn.cancel:hover{border-color:var(--sub);}
.csv-ok{background:rgba(0,221,136,0.08);border:1px solid rgba(0,221,136,0.25);
  border-radius:8px;padding:14px 16px;font-family:'Space Mono',monospace;font-size:11px;line-height:1.9;}
.csv-err{background:rgba(255,80,80,0.08);border:1px solid rgba(255,80,80,0.25);
  border-radius:8px;padding:14px 16px;font-family:'Space Mono',monospace;font-size:11px;line-height:1.9;color:var(--red);}
.modal-asset-list{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;}
.modal-asset-chip{padding:6px 12px;border-radius:6px;border:1px solid var(--border);
  cursor:pointer;font-family:'Space Mono',monospace;font-size:11px;color:#b0b0bc;transition:all .15s;}
.modal-asset-chip:hover,.modal-asset-chip.sel{background:rgba(255,170,0,0.12);border-color:var(--amber);color:var(--amber);}
.modal-asset-chip.already{opacity:.3;cursor:not-allowed;}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:200;
  align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:14px;
  padding:24px;width:420px;max-width:90vw;}
.modal h3{font-size:16px;font-weight:800;margin-bottom:6px;}
.modal p{font-size:11px;color:#b0b0bc;margin-bottom:18px;line-height:1.5;}
.modal-asset-list{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;}
.modal-asset-chip{padding:6px 12px;border-radius:6px;border:1px solid var(--border);
  cursor:pointer;font-family:'Space Mono',monospace;font-size:11px;color:#b0b0bc;transition:all .15s;}
.modal-asset-chip:hover,.modal-asset-chip.sel{background:rgba(255,170,0,0.12);border-color:var(--amber);color:var(--amber);}
.modal-asset-chip.already{opacity:.3;cursor:not-allowed;}
.modal-row{display:flex;gap:8px;margin-top:4px;}
.modal-btn{flex:1;padding:10px;border-radius:7px;border:none;cursor:pointer;
  font-family:'Space Mono',monospace;font-size:11px;font-weight:700;transition:all .15s;}
.modal-btn.primary{background:var(--amber);color:#000;}
.modal-btn.primary:hover{background:#ffbb22;}
.modal-btn.cancel{background:var(--bg3);color:#b0b0bc;border:1px solid var(--border);}

/* Ticker chart popup */
.ticker-wrap{position:relative;display:inline-block;padding-bottom:8px;cursor:pointer;}
.ticker-wrap:hover .ticker{color:var(--amber);}
.chart-popup{display:none;position:absolute;top:calc(100% - 4px);left:0;z-index:200;
  background:#1a1a1a;border:1px solid #3a3a3a;border-radius:8px;padding:8px;
  box-shadow:0 8px 24px rgba(0,0,0,.75);flex-direction:column;gap:5px;white-space:nowrap;}
.ticker-wrap:hover .chart-popup{display:flex;}
.chart-hint{font-size:9px;font-family:'Space Mono',monospace;color:#b0b0bc;
  padding:0 4px 2px;letter-spacing:1px;}
.ohlc-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px;padding:4px 4px 2px;border-top:1px solid rgba(255,255,255,0.06);margin-top:2px;}
.ohlc-pill{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:5px;padding:5px 9px;}
.ohlc-lbl{font-size:8px;font-family:'Space Mono',monospace;color:#b0b0bc;letter-spacing:1px;margin-bottom:2px;}
.ohlc-val{font-family:'Space Mono',monospace;font-size:11px;font-weight:700;color:var(--text);}
.chart-btn{display:flex;align-items:center;gap:8px;padding:7px 13px;border-radius:6px;
  border:none;cursor:pointer;font-family:'Space Mono',monospace;font-size:11px;font-weight:700;
  transition:all .15s;text-decoration:none;}
.chart-tv{background:rgba(33,150,243,.12);color:#4dabf7;border:1px solid rgba(33,150,243,.3);}
.chart-tv:hover{background:rgba(33,150,243,.25);}
.chart-cg{background:rgba(122,112,96,0.12);color:#c8bfaf;border:1px solid rgba(200,190,175,0.25);}
.chart-cg:hover{background:rgba(122,112,96,0.28);}
.chart-bn{background:rgba(240,185,11,0.12);color:#f0b90b;border:1px solid rgba(240,185,11,0.3);}
.chart-bn:hover{background:rgba(240,185,11,0.25);}

/* SETTINGS MODAL */
.settings-modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.82);
  z-index:300;align-items:center;justify-content:center;}
.settings-modal-overlay.open{display:flex;}
.settings-modal{background:#1e1e1e;border:1px solid #3a3a3a;border-radius:14px;
  padding:24px;width:780px;max-width:96vw;max-height:90vh;overflow-y:auto;}
.settings-modal h3{font-size:17px;font-weight:800;margin-bottom:4px;}
.settings-modal .sub{font-size:13px;color:#c8bfaf;margin-bottom:20px;line-height:1.6;}
.settings-table{width:100%;border-collapse:collapse;font-size:11px;}
.settings-table th{font-family:'Space Mono',monospace;font-size:11px;letter-spacing:0.5px;
  color:#c8bfaf;text-align:left;padding:0 8px 10px;border-bottom:1px solid var(--border);font-weight:700;}
.settings-table td{padding:6px 8px;border-bottom:1px solid rgba(255,255,255,0.04);vertical-align:middle;}
.settings-table tr:hover td{background:rgba(255,255,255,0.02);}
.settings-ticker-lbl{font-family:'Space Mono',monospace;font-size:11px;font-weight:700;
  color:var(--text);white-space:nowrap;}
.settings-input{width:100%;background:var(--bg3);border:1px solid #3a3a3a;border-radius:5px;
  padding:5px 8px;color:var(--text);font-size:11px;font-family:'Space Mono',monospace;
  outline:none;transition:border-color .15s;min-width:0;}
.settings-input:focus{border-color:var(--cyan);}
.settings-input.changed{border-color:var(--amber);background:rgba(255,170,0,0.05);}
.settings-save-row{display:flex;align-items:center;gap:10px;margin-top:18px;flex-wrap:wrap;}
.settings-status{font-size:10px;font-family:'Space Mono',monospace;color:var(--sub);}
.settings-status.ok{color:var(--green);}
.settings-status.err{color:var(--red);}
.btn-settings-save{background:var(--cyan);color:#000;border:none;border-radius:7px;
  padding:9px 20px;font-family:'Space Mono',monospace;font-size:11px;font-weight:700;cursor:pointer;}
.btn-settings-save:hover{background:#33ddee;}
.btn-settings-save:disabled{opacity:.4;cursor:not-allowed;}
.btn-settings-cancel{background:var(--bg3);color:var(--sub);border:1px solid var(--border);
  border-radius:7px;padding:9px 16px;font-family:'Space Mono',monospace;font-size:11px;cursor:pointer;}
.btn-settings-cancel:hover{border-color:var(--sub);}


/* SETTINGS TABS */
.stab-bar{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:20px;}
.stab-btn{background:none;border:none;border-bottom:2px solid transparent;
  color:var(--sub);font-family:'Space Mono',monospace;font-size:11px;font-weight:700;
  letter-spacing:1px;padding:8px 18px;cursor:pointer;margin-bottom:-1px;transition:all .15s;}
.stab-btn:hover{color:var(--text);}
.stab-btn.active{color:var(--cyan);border-bottom-color:var(--cyan);}
.stab-panel{display:none;}
.stab-panel.active{display:block;}
/* Prefs sections */
.pref-section{margin-bottom:24px;}
.pref-section-title{font-family:'Space Mono',monospace;font-size:10px;letter-spacing:2px;
  color:var(--sub);text-transform:uppercase;padding-bottom:8px;
  border-bottom:1px solid var(--border);margin-bottom:12px;}
.pref-row{display:flex;align-items:center;justify-content:space-between;
  padding:8px 0;border-bottom:1px solid rgba(255,255,255,0.04);}
.pref-row:last-child{border-bottom:none;}
.pref-label{font-size:12px;color:var(--text);font-weight:600;}
.pref-desc{font-size:10px;color:var(--sub);margin-top:2px;line-height:1.4;}
.pref-control{display:flex;align-items:center;gap:6px;flex-shrink:0;margin-left:16px;}
/* Toggle switch */
.pref-toggle{position:relative;width:38px;height:20px;flex-shrink:0;}
.pref-toggle input{opacity:0;width:0;height:0;}
.pref-toggle-track{position:absolute;inset:0;background:var(--bg4);border-radius:10px;
  border:1px solid var(--border);cursor:pointer;transition:background .2s;}
.pref-toggle input:checked + .pref-toggle-track{background:var(--cyan);}
.pref-toggle-thumb{position:absolute;top:2px;left:2px;width:14px;height:14px;
  background:#fff;border-radius:50%;transition:transform .2s;pointer-events:none;}
.pref-toggle input:checked ~ .pref-toggle-thumb{transform:translateX(18px);}
/* 3-btn toggle */
.pref-3btn{display:flex;gap:2px;background:var(--bg3);border-radius:7px;padding:2px;}
.pref-3btn button{background:none;border:none;border-radius:5px;
  color:var(--sub);font-family:'Space Mono',monospace;font-size:10px;font-weight:700;
  padding:5px 12px;cursor:pointer;transition:all .15s;}
.pref-3btn button.active{background:var(--cyan);color:#000;}
.pref-3btn button:hover:not(.active){color:var(--text);}
/* Number input */
.pref-number{width:64px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;
  color:var(--text);font-family:'Space Mono',monospace;font-size:12px;font-weight:700;
  padding:5px 8px;text-align:center;outline:none;transition:border-color .15s;}
.pref-number:focus{border-color:var(--cyan);}
.pref-number.err{border-color:var(--red)!important;}
/* Dropdown */
.pref-select{background:var(--bg3);border:1px solid var(--border);border-radius:6px;
  color:var(--text);font-family:'Space Mono',monospace;font-size:11px;
  padding:5px 10px;outline:none;cursor:pointer;}
.pref-select:focus{border-color:var(--cyan);}
/* Text input for API key */
.pref-text{width:200px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;
  color:var(--text);font-family:'Space Mono',monospace;font-size:11px;
  padding:5px 10px;outline:none;}
.pref-text:focus{border-color:var(--cyan);}
/* Validation error message */
.pref-validation{font-size:10px;color:var(--red);font-family:'Space Mono',monospace;
  margin-top:6px;display:none;}
.pref-validation.visible{display:block;}
/* Readonly display */
.pref-readonly{font-family:'Space Mono',monospace;font-size:11px;color:var(--sub);}
/* Save row */
.pref-save-row{display:flex;align-items:center;gap:10px;margin-top:20px;
  padding-top:16px;border-top:1px solid var(--border);}
.pref-reset-link{font-family:'Space Mono',monospace;font-size:10px;color:var(--sub);
  background:none;border:none;cursor:pointer;text-decoration:underline;margin-left:auto;}
.pref-reset-link:hover{color:var(--text);}

/* ── ANALYSE FULL-SCREEN PANEL ── */
.analyze-overlay{display:none;position:fixed;inset:0;background:var(--bg);z-index:400;
  flex-direction:column;overflow-y:auto;}
.analyze-overlay.open{display:flex;}
.analyze-back{position:sticky;top:0;z-index:10;background:var(--bg2);
  border-bottom:1px solid var(--border);padding:12px 20px;
  display:flex;align-items:center;justify-content:space-between;position:relative;}
.analyze-back-btn{background:none;border:none;cursor:pointer;
  font-family:'Space Mono',monospace;font-size:18px;font-weight:800;color:#ffffff;
  text-transform:uppercase;letter-spacing:1px;transition:color .15s;white-space:nowrap;padding:0;}
.analyze-back-btn:hover{color:var(--amber);}
.analyze-header-center{position:absolute;left:50%;transform:translateX(-50%);
  display:flex;align-items:center;gap:10px;}
.analyze-asset-id{font-family:'Space Mono',monospace;font-size:20px;font-weight:800;color:var(--amber);}
.analyze-asset-price{font-family:'Space Mono',monospace;font-size:20px;font-weight:800;color:#ffffff;}
.analyze-header-right{width:120px;}

.analyze-body{flex:1;padding:20px 24px;max-width:800px;width:100%;margin:0 auto;}

/* Strategy selector */
.analyze-strategy-wrap{background:var(--bg2);border:1px solid var(--border);border-radius:10px;
  padding:14px 18px;margin-bottom:18px;}
.analyze-strategy-label{font-size:11px;font-family:'Space Mono',monospace;color:#ffffff;font-weight:800;
  letter-spacing:2px;margin-bottom:10px;padding-left:10px;border-left:3px solid var(--amber);}
.strategy-btns{display:flex;gap:8px;flex-wrap:wrap;}
.strategy-btn{padding:8px 16px;border-radius:6px;border:1px solid var(--border);
  background:var(--bg3);font-family:'Space Mono',monospace;font-size:12px;font-weight:700;
  cursor:pointer;color:#b0b0bc;transition:all .15s;white-space:nowrap;}
.strategy-btn:hover{border-color:var(--amber);color:var(--amber);}
.strategy-btn.active{background:rgba(255,170,0,0.15);border-color:var(--amber);color:var(--amber);}

/* Narrative box */
.analyze-narrative{background:var(--bg2);border:1px solid var(--border);border-left:4px solid var(--blue);
  border-radius:10px;padding:18px 20px;margin-bottom:18px;}
.analyze-section-label{font-size:8px;font-family:'Space Mono',monospace;color:#ffffff;font-weight:800;
  letter-spacing:2px;margin-bottom:10px;padding-left:10px;border-left:3px solid var(--blue);}
.analyze-narrative-text{font-size:13px;line-height:1.8;color:#d8d0c8;}

/* Bull market note */
.bull-note{margin-top:12px;padding:10px 14px;background:rgba(255,170,0,0.06);
  border:1px solid rgba(255,170,0,0.2);border-radius:7px;
  font-size:11px;line-height:1.7;color:rgba(255,170,0,0.85);}

/* Checklist */
.analyze-checklist{background:var(--bg2);border:1px solid var(--border);
  border-radius:10px;padding:18px 20px;margin-bottom:18px;}
.check-row{display:flex;align-items:flex-start;gap:12px;padding:8px 0;
  border-bottom:1px solid rgba(255,255,255,0.04);}
.check-row:last-child{border-bottom:none;}
.check-icon{font-size:16px;line-height:1;flex-shrink:0;margin-top:1px;}
.check-content{flex:1;}
.check-title{font-size:12px;font-weight:700;margin-bottom:2px;}
.check-detail{font-size:11px;color:#b0b0bc;line-height:1.5;}
.check-pass .check-title{color:var(--green);}
.check-warn .check-title{color:var(--amber);}
.check-fail .check-title{color:var(--red);}
.check-info .check-title{color:var(--blue);}

.checklist-progress{margin-top:14px;padding-top:12px;border-top:1px solid var(--border);}
.progress-bar-wrap{height:6px;background:var(--dim);border-radius:3px;overflow:hidden;margin:6px 0;}
.progress-bar-fill{height:100%;border-radius:3px;background:var(--green);transition:width .4s ease;}
.progress-label{font-size:11px;font-family:'Space Mono',monospace;color:#b0b0bc;}

/* ── WAVE PANEL (Analyze) ── */
.wave-panel-wrap{background:#161616;border:1px solid #2a2a2a;border-radius:14px;
  padding:18px 20px 16px;margin-bottom:18px;}
.wave-panel-title{font-family:'Space Mono',monospace;font-size:12px;letter-spacing:2.5px;font-weight:700;
  display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;}
.wpt-left{color:#00ccdd;}
.wpt-right{color:#b0b0bc;}
.wave-grid{display:flex;flex-direction:column;gap:3px;}
.wave-panel-body{display:none;}
.wave-panel-wrap.open .wave-panel-body{display:block;}
.wave-panel-chevron{font-size:14px;color:#b0b0bc;transition:transform .2s;flex-shrink:0;}
.wave-panel-wrap.open .wave-panel-chevron{transform:rotate(0deg);}
.wave-panel-wrap:not(.open) .wave-panel-chevron{transform:rotate(-90deg);}
.wave-row{display:flex;align-items:center;gap:10px;}
.wave-lbl{font-family:'Space Mono',monospace;font-size:10px;font-weight:700;
  width:34px;flex-shrink:0;text-align:right;}
.wave-track{flex:1;height:50px;position:relative;padding-right:8px;}
.wave-svg{width:100%;height:100%;display:block;overflow:visible;}
.wave-val{font-family:'Space Mono',monospace;font-size:11px;font-weight:700;
  width:42px;text-align:right;flex-shrink:0;}
.wave-arr{font-size:14px;width:18px;flex-shrink:0;text-align:center;font-weight:700;}
.wave-arr.arr-up{color:var(--green);}
.wave-arr.arr-dn{color:var(--red);}
.wave-divider{border-top:1px solid #252525;margin:8px 0 5px;}
.wave-legend{display:flex;gap:18px;margin-top:14px;padding-top:10px;
  border-top:1px solid #1e1e1e;}
.legend-item{display:flex;align-items:center;gap:7px;font-size:11px;
  font-family:'Space Mono',monospace;color:#b0b0bc;}
.legend-line{width:24px;height:0;}

.action-wait{background:rgba(122,112,96,.07);border-color:rgba(122,112,96,.2);}
.action-armed{background:rgba(255,170,0,.06);border-color:rgba(255,170,0,.25);}
.action-fired{background:rgba(0,221,136,.06);border-color:rgba(0,221,136,.25);}
.action-caution{background:rgba(255,80,80,.06);border-color:rgba(255,80,80,.25);}

/* ── VERDICT CARD (Analyze Tab — above the fold) ── */
.verdict-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;
  padding:20px;margin-bottom:18px;position:relative;overflow:hidden;}
.verdict-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:5px;}
.verdict-card.verdict-red::before{background:var(--red);}
.verdict-card.verdict-amber::before{background:var(--amber);}
.verdict-card.verdict-green::before{background:var(--green);}

.verdict-header{display:flex;align-items:center;gap:12px;margin-bottom:14px;flex-wrap:wrap;}
.verdict-asset-select{background:var(--bg3);border:1px solid var(--border);border-radius:6px;
  padding:8px 32px 8px 14px;font-family:'Space Mono',monospace;font-size:15px;font-weight:700;
  color:var(--amber);cursor:pointer;min-width:120px;
  appearance:none;-webkit-appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23ffaa00' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 10px center;background-size:16px;}
.verdict-asset-select:focus{outline:none;border-color:var(--amber);}
.verdict-asset-select option{background:var(--bg2);color:var(--text);font-size:14px;}

.verdict-title{font-size:20px;font-weight:800;letter-spacing:-0.3px;}
.verdict-subtitle{font-size:13px;font-family:'Space Mono',monospace;color:#b0b0bc;margin-top:2px;}

.verdict-pills{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0;}
.verdict-pill{display:flex;flex-direction:column;align-items:center;gap:3px;
  padding:12px 16px;border-radius:8px;background:var(--bg3);border:1px solid var(--border);
  min-width:110px;text-align:center;}
.verdict-pill-label{font-size:11px;font-family:'Space Mono',monospace;color:var(--cyan);
  letter-spacing:1.5px;}
.verdict-pill-val{font-size:14px;font-weight:800;font-family:'Space Mono',monospace;}
.verdict-pill.pill-red .verdict-pill-val{color:var(--red);}
.verdict-pill.pill-amber .verdict-pill-val{color:var(--amber);}
.verdict-pill.pill-green .verdict-pill-val{color:var(--green);}
.verdict-pill.pill-neutral .verdict-pill-val{color:#b0b0bc;}
.verdict-pill.pill-pulse{animation:pillPulse 2s infinite;}
@keyframes pillPulse{0%,100%{box-shadow:none}50%{box-shadow:0 0 12px rgba(255,170,0,0.3)}}

.verdict-warning{margin-top:10px;padding:8px 14px;border-radius:6px;font-size:11px;
  line-height:1.5;font-family:'Space Mono',monospace;}
.verdict-warning.warn-boundary{background:rgba(255,170,0,0.06);border:1px solid rgba(255,170,0,0.2);
  color:rgba(255,170,0,0.85);}
.verdict-warning.warn-stale{background:rgba(255,80,80,0.06);border:1px solid rgba(255,80,80,0.2);
  color:rgba(255,80,80,0.85);}

/* ── FIVE-LAYER NARRATIVE CARDS ── */
.narrative-layer{background:var(--bg2);border:1px solid var(--border);border-radius:10px;
  margin-bottom:12px;overflow:hidden;transition:all .2s;}
.narrative-layer-header{display:flex;align-items:center;gap:10px;padding:14px 18px;
  cursor:pointer;user-select:none;transition:background .15s;}
.narrative-layer-header:hover{background:rgba(255,255,255,0.02);}
.narrative-layer-num{font-size:10px;font-family:'Space Mono',monospace;font-weight:700;
  padding:3px 8px;border-radius:4px;letter-spacing:1px;flex-shrink:0;}
.narrative-layer-num.nl-1{background:rgba(255,80,80,0.12);color:var(--red);}
.narrative-layer-num.nl-2{background:rgba(0,204,221,0.12);color:var(--cyan);}
.narrative-layer-num.nl-3{background:rgba(176,136,255,0.12);color:var(--purple);}
.narrative-layer-num.nl-4{background:rgba(85,153,255,0.12);color:var(--blue);}
.narrative-layer-num.nl-5{background:rgba(255,170,0,0.12);color:var(--amber);}
.narrative-layer-title{font-size:15px;font-weight:800;color:#ffffff;flex:1;}
.narrative-layer-chevron{font-size:14px;color:var(--sub);transition:transform .2s;flex-shrink:0;}
.narrative-layer.open .narrative-layer-chevron{transform:rotate(180deg);}
.narrative-layer-body{display:none;padding:0 18px 16px;border-top:1px solid var(--border);}
.narrative-layer.open .narrative-layer-body{display:block;padding-top:14px;}
.narrative-text{font-size:13px;line-height:1.85;color:#b0b0bc;}
.narrative-text strong{color:var(--text);font-weight:700;}
.narrative-highlight{padding:10px 14px;border-radius:6px;margin:10px 0;font-size:12px;line-height:1.7;}
.nh-green{background:rgba(0,221,136,0.06);border:1px solid rgba(0,221,136,0.15);color:rgba(0,221,136,0.9);}
.nh-amber{background:rgba(255,170,0,0.06);border:1px solid rgba(255,170,0,0.15);color:rgba(255,170,0,0.9);}
.nh-red{background:rgba(255,80,80,0.06);border:1px solid rgba(255,80,80,0.15);color:rgba(255,80,80,0.9);}
.nh-blue{background:rgba(85,153,255,0.06);border:1px solid rgba(85,153,255,0.15);color:rgba(85,153,255,0.9);}

/* Asset perf table inside Layer 4 */
.perf-table{width:100%;border-collapse:collapse;margin:10px 0;font-size:11px;font-family:'Space Mono',monospace;}
.perf-table th{text-align:left;padding:6px 10px;font-size:9px;letter-spacing:1px;color:var(--sub);
  border-bottom:1px solid var(--border);}
.perf-table td{padding:6px 10px;border-bottom:1px solid rgba(255,255,255,0.03);}
.perf-table .perf-pos{color:var(--green);}
.perf-table .perf-neg{color:var(--red);}

/* ── DATA FRESHNESS FOOTER ── */
.data-freshness{margin-top:16px;padding:12px 16px;background:var(--bg2);border:1px solid var(--border);
  border-radius:8px;font-size:10px;font-family:'Space Mono',monospace;color:var(--sub);
  display:flex;gap:16px;flex-wrap:wrap;align-items:center;}
.freshness-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.freshness-dot.fresh{background:var(--green);}
.freshness-dot.stale{background:var(--amber);}
.freshness-dot.outdated{background:var(--red);}
.freshness-seed{background:rgba(85,153,255,0.08);color:var(--blue);padding:2px 8px;border-radius:3px;}

/* ── SWING SIGNAL CARD ── */
.swing-layer{background:var(--bg2);border:1px solid var(--border);border-radius:10px;
  margin-bottom:12px;overflow:hidden;}
.swing-layer-header{display:flex;align-items:center;gap:12px;padding:14px 18px;
  cursor:pointer;user-select:none;transition:background .15s;}
.swing-layer-header:hover{background:rgba(255,255,255,0.02);}
.swing-layer-tag{font-size:10px;font-family:'Space Mono',monospace;font-weight:700;
  padding:3px 10px;border-radius:4px;letter-spacing:1px;flex-shrink:0;}
.swing-layer-tag.tag-active{background:rgba(176,136,255,0.15);color:var(--purple);}
.swing-layer-tag.tag-inactive{background:rgba(176,176,188,0.08);color:var(--sub);}
.swing-layer-tag.tag-blocked{background:rgba(255,170,0,0.12);color:var(--amber);}
.swing-layer-title{font-size:15px;font-weight:800;color:#ffffff;flex:1;}
.swing-layer-status{font-size:11px;font-family:'Space Mono',monospace;font-weight:700;}
.swing-layer-chevron{font-size:14px;color:var(--sub);transition:transform .2s;flex-shrink:0;}
.swing-layer.open .swing-layer-chevron{transform:rotate(180deg);}
.swing-layer-body{display:none;padding:0 18px 18px;border-top:1px solid var(--border);}
.swing-layer.open .swing-layer-body{display:block;padding-top:16px;}
.swing-row{display:flex;align-items:center;gap:10px;padding:8px 0;
  border-bottom:1px solid rgba(255,255,255,0.04);font-size:13px;}
.swing-row:last-child{border-bottom:none;}
.swing-key{color:var(--cyan);font-family:'Space Mono',monospace;font-size:12px;
  font-weight:700;width:140px;flex-shrink:0;}
.swing-val{font-weight:700;}
.swing-val-green{color:var(--green);}
.swing-val-amber{color:var(--amber);}
.swing-val-red{color:var(--red);}
.swing-val-purple{color:var(--purple);}
.swing-val-neutral{color:#b0b0bc;}
.swing-val-white{color:var(--text);}
.swing-highlight{padding:12px 16px;border-radius:6px;margin:12px 0;font-size:12px;line-height:1.7;}
.sh-green{background:rgba(0,221,136,0.06);border:1px solid rgba(0,221,136,0.15);color:rgba(0,221,136,0.9);}
.sh-amber{background:rgba(255,170,0,0.06);border:1px solid rgba(255,170,0,0.15);color:rgba(255,170,0,0.9);}
.sh-neutral{background:rgba(176,176,188,0.04);border:1px solid rgba(176,176,188,0.12);color:var(--sub);}
.swing-ev-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px;}
.swing-ev-card{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:10px;text-align:center;}
.swing-ev-label{font-size:11px;font-family:'Space Mono',monospace;color:#00ccdd;letter-spacing:1px;margin-bottom:4px;font-weight:700;}
.swing-ev-val{font-size:16px;font-weight:800;font-family:'Space Mono',monospace;}
.hbar-swing-warning{margin-top:10px;padding:10px 14px;border-radius:6px;
  background:rgba(255,170,0,0.06);border:1px solid rgba(255,170,0,0.15);
  font-size:11px;line-height:1.6;color:rgba(255,170,0,0.85);}
.action-label{font-size:11px;font-family:'Space Mono',monospace;font-weight:800;
  letter-spacing:2px;margin-bottom:8px;padding-left:10px;border-left:3px solid currentColor;}
.action-wait .action-label{color:#b0b0bc;}
.action-armed .action-label{color:var(--amber);}
.action-fired .action-label{color:var(--green);}
.action-caution .action-label{color:var(--red);}
.action-title{font-size:16px;font-weight:800;margin-bottom:4px;}
.action-sub{font-size:11px;font-family:'Space Mono',monospace;color:#b0b0bc;margin-bottom:8px;line-height:1.5;}
.action-wait .action-sub{color:#b0b0bc;}
.action-armed .action-sub{color:rgba(255,170,0,0.8);}
.action-fired .action-sub{color:rgba(0,221,136,0.8);}
.action-caution .action-sub{color:rgba(255,80,80,0.8);}
.action-wait .action-title{color:#9090a0;}
.action-armed .action-title{color:var(--amber);}
.action-fired .action-title{color:var(--green);}
.action-caution .action-title{color:var(--red);}
.action-desc{font-size:12px;line-height:1.8;color:#b0b0bc;}

/* Price targets button */
.btn-price-targets{display:flex;align-items:center;justify-content:space-between;
  width:100%;padding:16px 20px;border-radius:10px;border:1px solid rgba(0,204,221,0.3);
  background:rgba(0,204,221,0.06);cursor:pointer;transition:all .2s;margin-bottom:20px;}
.btn-price-targets:hover{background:rgba(0,204,221,0.12);border-color:var(--cyan);}
.bpt-left{display:flex;flex-direction:column;gap:3px;text-align:left;}
.bpt-title{font-size:13px;font-weight:800;color:var(--cyan);}
.bpt-sub{font-size:10px;font-family:'Space Mono',monospace;color:rgba(0,204,221,0.6);}
.bpt-arrow{font-size:20px;color:var(--cyan);}

/* ── PRICE TARGETS FULL-SCREEN ── */
.targets-overlay{display:none;position:fixed;inset:0;background:var(--bg);z-index:500;
  flex-direction:column;overflow-y:auto;}
.targets-overlay.open{display:flex;}

.targets-body{flex:1;padding:20px 24px;max-width:800px;width:100%;margin:0 auto;}

/* Swing basis */
.swing-basis{background:var(--bg2);border:1px solid var(--border);border-radius:10px;
  padding:14px 18px;margin-bottom:18px;display:flex;gap:16px;flex-wrap:wrap;}
.swing-item{flex:1;min-width:140px;}
.swing-item-label{font-size:8px;font-family:'Space Mono',monospace;color:#b0b0bc;
  letter-spacing:1.5px;margin-bottom:4px;}
.swing-item-val{font-family:'Space Mono',monospace;font-size:15px;font-weight:700;}
.swing-low-val{color:var(--green);}
.swing-high-val{color:var(--red);}
.swing-current-val{color:var(--amber);}

/* Price range bar */
.price-range-wrap{background:var(--bg2);border:1px solid var(--border);border-radius:10px;
  padding:18px 20px;margin-bottom:18px;}
.price-range-bar{position:relative;height:28px;background:var(--dim);border-radius:6px;
  margin:16px 0;overflow:visible;}
.prb-zone{position:absolute;top:0;height:100%;border-radius:4px;opacity:0.35;}
.prb-current{position:absolute;top:-6px;width:3px;height:40px;border-radius:2px;
  background:var(--amber);box-shadow:0 0 10px var(--amber);}
.prb-label{position:absolute;top:-22px;transform:translateX(-50%);
  font-size:9px;font-family:'Space Mono',monospace;color:var(--amber);white-space:nowrap;}
.prb-endpoints{display:flex;justify-content:space-between;font-size:9px;
  font-family:'Space Mono',monospace;color:#b0b0bc;margin-top:6px;}

/* Target rows */
.targets-section-label{font-size:10px;font-family:'Space Mono',monospace;color:#ffffff;font-weight:800;
  letter-spacing:2px;margin:16px 0 10px;padding-left:10px;border-left:3px solid var(--blue);}
.target-item{display:flex;align-items:center;gap:12px;padding:12px 16px;
  background:var(--bg2);border:1px solid var(--border);border-radius:8px;margin-bottom:8px;}
.target-price{font-family:'Space Mono',monospace;font-size:17px;font-weight:700;min-width:100px;}
.target-up .target-price{color:var(--green);}
.target-dn .target-price{color:var(--red);}
.target-tags{display:flex;gap:6px;flex-wrap:wrap;flex:1;}
.target-tag{font-size:10px;font-family:'Space Mono',monospace;padding:2px 8px;border-radius:3px;
  font-weight:700;white-space:nowrap;}
.tag-fib{background:rgba(85,153,255,0.15);color:var(--blue);}
.tag-prev{background:rgba(0,204,221,0.15);color:var(--cyan);}
.tag-ma{background:rgba(176,136,255,0.15);color:var(--purple);}
.confluence-badge{font-size:10px;font-family:'Space Mono',monospace;padding:3px 8px;
  border-radius:4px;font-weight:700;white-space:nowrap;flex-shrink:0;}
.conf-high{background:rgba(0,221,136,0.15);color:var(--green);}
.conf-med{background:rgba(255,170,0,0.15);color:var(--amber);}
.target-dist{font-family:'Space Mono',monospace;font-size:13px;font-weight:700;color:#b0b0bc;
  min-width:55px;text-align:right;flex-shrink:0;}
.target-up .target-dist{color:var(--green);}
.target-dn .target-dist{color:var(--red);}

/* Timing note */
.timing-note{background:rgba(176,136,255,0.06);border:1px solid rgba(176,136,255,0.2);
  border-radius:10px;padding:14px 18px;margin-top:18px;
  font-size:12px;line-height:1.8;color:#c8c0d8;}
.timing-note strong{color:var(--purple);}

/* ── Mobile Responsive ── */
@media(max-width:640px){
  /* Macro strip: stack and hide low-priority items */
  #macro-strip{flex-wrap:wrap;height:auto;padding:6px 12px;gap:6px;}
  .ms-title{font-size:11px;}
  .ms-item{font-size:11px;}
  .ms-sep{display:none;}
  #ms-m2,#ms-yen,#ms-spx{display:none;}
  #ms-m2+.ms-sep,#ms-yen+.ms-sep,#ms-spx+.ms-sep{display:none;}
  /* MQS row: stack vertically */
  .mqs-header{flex-direction:column;align-items:flex-start;gap:8px;padding:10px 14px;}
  .mqs-header>.mqs-block-sep{display:none;}
  /* Context strip: wrap */
  #ctx-strip{flex-wrap:wrap;height:auto;padding:6px 12px;gap:4px 12px;}
  /* Gate boxes: smaller on mobile */
  .gate-boxes{flex-wrap:wrap;gap:8px;}
  .gate-box{min-width:70px;padding:10px 12px;}
  .gate-box-val{font-size:20px;}
  /* Cards: single column */
  .card-grid{grid-template-columns:1fr;}
  /* Analyze tab: tighter padding */
  .analyze-body{padding:14px 12px;}
}
</style>
</head>
<body>

<!-- ADD CARD MODAL -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal" id="modal-box">

    <!-- STEP 1: Asset Details -->
    <div id="step1">
      <div class="modal-step-label" id="modal-step-label">ADDING TO CORE</div>
      <h3>Step 1 — Asset Details</h3>
      <p>Enter the ticker and name. We'll auto-generate the CoinGecko slug — correct it if needed.</p>
      <div class="modal-field">
        <label>Ticker Symbol</label>
        <input type="text" id="inp-ticker" placeholder="e.g. PENDLE" oninput="autoSlug()" maxlength="12"
          style="text-transform:uppercase">
      </div>
      <div class="modal-field">
        <label>Full Name</label>
        <input type="text" id="inp-name" placeholder="e.g. Pendle Finance" maxlength="40">
      </div>
      <div class="modal-field">
        <label>CoinGecko Slug <span style="color:#b0b0bc;font-weight:400">(auto-generated — edit if wrong)</span></label>
        <input type="text" id="inp-slug" placeholder="e.g. pendle" oninput="updateLinks()" maxlength="60">
      </div>
      <div class="modal-row" style="margin-top:16px">
        <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
        <button class="modal-btn primary" onclick="goStep2()">Next →</button>
      </div>
    </div>

    <!-- STEP 2: CSV Download -->
    <div id="step2" style="display:none">
      <div class="modal-step-label" id="modal-step-label2">ADDING TO CORE</div>
      <h3>Step 2 — Download Historical Data</h3>
      <p>Download the Max historical CSV from CoinGecko before continuing. This gives the DPO indicators their full accuracy.</p>
      <div class="modal-link-box">
        <div style="font-size:9px;font-family:'Space Mono',monospace;color:#b0b0bc;margin-bottom:8px;letter-spacing:1px;">DIRECT LINK (best guess)</div>
        <a id="link-direct" href="#" target="_blank" class="modal-link"></a>
        <div style="font-size:10px;color:#b0b0bc;margin-top:6px;line-height:1.5">
          If that 404s, use the search fallback:<br>
          <a id="link-search" href="#" target="_blank" class="modal-link-small"></a>
        </div>
      </div>
      <div class="modal-instruction">
        1. Click the link above<br>
        2. Scroll to the historical data table<br>
        3. Select <strong style="color:var(--text)">MAX</strong> date range<br>
        4. Click <strong style="color:var(--text)">Download CSV</strong><br>
        5. Come back and click "I've downloaded it"
      </div>
      <div class="modal-row" style="margin-top:16px">
        <button class="modal-btn cancel" onclick="goStep1()">← Back</button>
        <button class="modal-btn secondary" onclick="goStep3(true)">Skip — add without CSV</button>
        <button class="modal-btn primary" onclick="goStep3(false)">I've downloaded it →</button>
      </div>
    </div>

    <!-- STEP 3: CSV Upload & Validate -->
    <div id="step3" style="display:none">
      <div class="modal-step-label" id="modal-step-label3">ADDING TO CORE</div>
      <h3>Step 3 — Upload & Validate</h3>
      <p>Select the CSV you just downloaded. We'll check it looks right before adding the card.</p>
      <div class="modal-upload-zone" id="upload-zone" onclick="document.getElementById('csv-input').click()">
        <div style="font-size:24px;margin-bottom:8px">📂</div>
        <div style="font-size:11px;color:#b0b0bc">Click to select CSV file</div>
        <input type="file" id="csv-input" accept=".csv" style="display:none" onchange="validateCSV(this)">
      </div>
      <div id="csv-result" style="display:none"></div>
      <div class="modal-row" style="margin-top:16px">
        <button class="modal-btn cancel" onclick="goStep2()">← Back</button>
        <button class="modal-btn primary" id="btn-add" onclick="finalizeAdd()" disabled>Add Card ✓</button>
      </div>
    </div>

  </div>
</div>

<!-- MOVE MODAL -->
<div class="modal-overlay" id="move-modal-overlay">
  <div class="modal" id="move-modal-box" style="width:460px;">
    <div id="move-step-label" class="modal-step-label" style="background:rgba(85,153,255,0.12);color:var(--blue)">MOVE ASSET</div>
    <h3>Move Asset</h3>
    <p>Select the asset to move, then choose its destination section.</p>
    <div style="font-size:9px;font-family:'Space Mono',monospace;color:#b0b0bc;letter-spacing:1px;margin-bottom:8px;">SELECT ASSET</div>
    <div class="modal-asset-list" id="move-asset-list" style="margin-bottom:16px;"></div>
    <div style="font-size:9px;font-family:'Space Mono',monospace;color:#b0b0bc;letter-spacing:1px;margin-bottom:8px;">MOVE TO SECTION</div>
    <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:20px;" id="move-tier-radios"></div>
    <div class="modal-row">
      <button class="modal-btn cancel" onclick="closeMoveModal()">Cancel</button>
      <button class="modal-btn primary" id="btn-confirm-move" onclick="confirmMove()" style="background:var(--blue);color:#fff;" disabled>Move →</button>
    </div>
  </div>
</div>

<!-- DELETE MODAL -->
<div class="modal-overlay" id="delete-modal-overlay">
  <div class="modal" id="delete-modal-box" style="width:460px;">
    <div class="modal-step-label" style="background:rgba(255,80,80,0.12);color:var(--red)">DELETE ASSET</div>
    <h3>Delete Asset</h3>
    <p>Select assets to remove from the dashboard. This cannot be undone.</p>
    <div style="font-size:9px;font-family:'Space Mono',monospace;color:#b0b0bc;letter-spacing:1px;margin-bottom:8px;">SELECT TO DELETE</div>
    <div class="modal-asset-list" id="delete-asset-list" style="margin-bottom:16px;"></div>
    <div id="delete-confirm-box" style="display:none;background:rgba(255,80,80,0.08);border:1px solid rgba(255,80,80,0.3);
      border-radius:8px;padding:14px 16px;font-family:'Space Mono',monospace;font-size:11px;color:#e09090;margin-bottom:16px;line-height:1.8;">
    </div>
    <div class="modal-row">
      <button class="modal-btn cancel" onclick="closeDeleteModal()">Cancel</button>
      <button class="modal-btn primary" id="btn-confirm-delete" onclick="confirmDelete()"
        style="background:rgba(255,80,80,0.2);color:var(--red);border:1px solid rgba(255,80,80,0.4);" disabled>
        Delete Selected
      </button>
    </div>
  </div>
</div>

<!-- SETTINGS MODAL -->
<div class="settings-modal-overlay" id="settings-modal-overlay">
  <div class="settings-modal" style="width:820px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <h3>⚙ Settings</h3>
      <button class="btn-settings-cancel" onclick="closeSettingsModal()" style="padding:6px 12px;">✕</button>
    </div>

    <!-- Tab bar -->
    <div class="stab-bar">
      <button class="stab-btn active" id="stab-prefs-btn" onclick="switchSettingsTab('prefs')">PREFERENCES</button>
      <button class="stab-btn" id="stab-assets-btn" onclick="switchSettingsTab('assets')">ASSET DATA</button>
    </div>

    <!-- PREFERENCES TAB -->
    <div class="stab-panel active" id="stab-prefs">

      <!-- Strategy -->
      <div class="pref-section">
        <div class="pref-section-title">Strategy</div>

        <div class="pref-row">
          <div>
            <div class="pref-label">Trading Mode</div>
            <div class="pref-desc">Changes action panel language and check-back cadence throughout the Analyze panel.</div>
          </div>
          <div class="pref-control">
            <div class="pref-3btn" id="pref-strategy">
              <button onclick="setPrefStrategy('daily')" id="pstrat-daily">DAILY</button>
              <button onclick="setPrefStrategy('weekly')" id="pstrat-weekly">WEEKLY</button>
              <button onclick="setPrefStrategy('intraday')" id="pstrat-intraday">INTRADAY</button>
            </div>
          </div>
        </div>

        <div class="pref-row">
          <div>
            <div class="pref-label">Bull Exception Mode</div>
            <div class="pref-desc">4H trigger fires at &lt;25 instead of &lt;20. Only enable in confirmed bull trends.</div>
          </div>
          <div class="pref-control">
            <label class="pref-toggle">
              <input type="checkbox" id="pref-bull-mode" onchange="prefChanged()">
              <div class="pref-toggle-track"></div>
              <div class="pref-toggle-thumb"></div>
            </label>
          </div>
        </div>
      </div>

      <!-- Thresholds -->
      <div class="pref-section">
        <div class="pref-section-title">Thresholds</div>

        <div class="pref-row">
          <div>
            <div class="pref-label">Floor Threshold (CONFIRMED)</div>
            <div class="pref-desc">1W &amp; 2W must both be below this for CONFIRMED signal. Default: 20. Range: 10–30.</div>
          </div>
          <div class="pref-control">
            <input class="pref-number" type="number" id="pref-floor" min="10" max="30" value="20" oninput="validateThresholds()">
          </div>
        </div>

        <div class="pref-row">
          <div>
            <div class="pref-label">Watch Threshold</div>
            <div class="pref-desc">1W &amp; 2W must both be below this for WATCH signal. Must be &gt; Floor. Default: 25. Range: 15–35.</div>
          </div>
          <div class="pref-control">
            <input class="pref-number" type="number" id="pref-watch" min="15" max="35" value="25" oninput="validateThresholds()">
          </div>
        </div>

        <div class="pref-row">
          <div>
            <div class="pref-label">Extended Threshold</div>
            <div class="pref-desc">Above this = EXTENDED / caution zone. Must be &gt; Watch. Default: 80. Range: 70–95.</div>
          </div>
          <div class="pref-control">
            <input class="pref-number" type="number" id="pref-extended" min="70" max="95" value="80" oninput="validateThresholds()">
          </div>
        </div>

        <div class="pref-row">
          <div>
            <div class="pref-label">4H Trigger Threshold</div>
            <div class="pref-desc">Standard 4H ARMED/FIRED threshold. Default: 20. Range: 10–35.</div>
          </div>
          <div class="pref-control">
            <input class="pref-number" type="number" id="pref-4h" min="10" max="35" value="20" oninput="validateThresholds()">
          </div>
        </div>

        <div class="pref-validation" id="pref-thresh-err">⚠ Invalid: Floor must be &lt; Watch &lt; Extended, and 4H ≤ Floor.</div>
      </div>

      <!-- Display -->
      <div class="pref-section">
        <div class="pref-section-title">Display</div>

        <div class="pref-row">
          <div>
            <div class="pref-label">Show Wave Oscillator</div>
            <div class="pref-desc">Show/hide the wave visualizer section on each card.</div>
          </div>
          <div class="pref-control">
            <label class="pref-toggle">
              <input type="checkbox" id="pref-show-wave" checked onchange="prefChanged()">
              <div class="pref-toggle-track"></div>
              <div class="pref-toggle-thumb"></div>
            </label>
          </div>
        </div>

        <div class="pref-row">
          <div>
            <div class="pref-label">Show 200MA Distance</div>
            <div class="pref-desc">Show/hide the 200MA % distance badge on each card.</div>
          </div>
          <div class="pref-control">
            <label class="pref-toggle">
              <input type="checkbox" id="pref-show-ma" checked onchange="prefChanged()">
              <div class="pref-toggle-track"></div>
              <div class="pref-toggle-thumb"></div>
            </label>
          </div>
        </div>

        <div class="pref-row">
          <div>
            <div class="pref-label">Compact Card Mode</div>
            <div class="pref-desc">Hides Layer 3 sub-daily grid. Shows only confluence score row. Good for overview scanning.</div>
          </div>
          <div class="pref-control">
            <label class="pref-toggle">
              <input type="checkbox" id="pref-compact" onchange="prefChanged()">
              <div class="pref-toggle-track"></div>
              <div class="pref-toggle-thumb"></div>
            </label>
          </div>
        </div>

        <div class="pref-row">
          <div>
            <div class="pref-label">Show REFERENCE Tier</div>
            <div class="pref-desc">Show/hide BTC and ETH reference cards.</div>
          </div>
          <div class="pref-control">
            <label class="pref-toggle">
              <input type="checkbox" id="pref-show-ref" checked onchange="prefChanged()">
              <div class="pref-toggle-track"></div>
              <div class="pref-toggle-thumb"></div>
            </label>
          </div>
        </div>
      </div>

      <!-- Data -->
      <div class="pref-section">
        <div class="pref-section-title">Data</div>

        <div class="pref-row">
          <div>
            <div class="pref-label">Seed Data Date</div>
            <div class="pref-desc">The date of the embedded fallback seed data.</div>
          </div>
          <div class="pref-control">
            <span class="pref-readonly">Feb 21, 2026</span>
          </div>
        </div>

        <div class="pref-row">
          <div>
            <div class="pref-label">Auto-Refresh Interval</div>
            <div class="pref-desc">How often to fetch live data when connected.</div>
          </div>
          <div class="pref-control">
            <select class="pref-select" id="pref-refresh" onchange="prefChanged()">
              <option value="15">15 min</option>
              <option value="30">30 min</option>
              <option value="60" selected>60 min</option>
              <option value="0">Manual only</option>
            </select>
          </div>
        </div>

        <div class="pref-row">
          <div>
            <div class="pref-label">CoinGecko API Key</div>
            <div class="pref-desc">Optional. Increases rate limit for live fetch. Stored locally only.</div>
          </div>
          <div class="pref-control">
            <input class="pref-text" type="password" id="pref-cg-key" placeholder="(optional)" oninput="prefChanged()">
          </div>
        </div>
        <div class="pref-row">
          <div>
            <div class="pref-label">Signal Date</div>
            <div class="pref-desc">The date the DPO buy signal fired. Used for cycle day calculation. Format: YYYY-MM-DD.</div>
          </div>
          <div class="pref-control">
            <input class="pref-text" type="date" id="pref-signal-date" oninput="prefChanged()">
          </div>
        </div>
        <div class="pref-row">
          <div>
            <div class="pref-label">Right Translation Confirmed</div>
            <div class="pref-desc">Manual toggle. Flip ON ~30 days after signal when you confirm the DPO cycle low was followed by a rising trajectory (not sideways). Adds +1 to confidence score.</div>
          </div>
          <div class="pref-control">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
              <input type="checkbox" id="pref-right-trans" onchange="prefChanged()" style="width:18px;height:18px;accent-color:var(--green);cursor:pointer;">
              <span id="pref-right-trans-label" style="font-size:11px;font-family:'Space Mono',monospace;color:var(--sub);">OFF</span>
            </label>
          </div>
        </div>
      </div>

      <!-- Save row -->
      <div class="pref-save-row">
        <button class="btn-settings-save" id="pref-save-btn" onclick="savePreferences()">Save Preferences</button>
        <button class="btn-settings-cancel" onclick="closeSettingsModal()">Cancel</button>
        <span class="settings-status" id="pref-status"></span>
        <button class="pref-reset-link" onclick="resetPreferences()">Reset to defaults</button>
      </div>
    </div>

    <!-- ASSET DATA TAB -->
    <div class="stab-panel" id="stab-assets">
      <div style="font-size:11px;color:var(--sub);margin-bottom:16px;line-height:1.6;">
        Edit asset names, CoinGecko slugs, and chart symbols. Changes sync via the Worker.
        Leave a field blank to use the built-in default. <span style="color:var(--amber)">Amber</span> = unsaved change.
      </div>
      <table class="settings-table">
        <thead>
          <tr>
            <th>TICKER</th>
            <th>FULL NAME</th>
            <th>COINGECKO SLUG</th>
            <th>TRADINGVIEW SYMBOL</th>
            <th>BINANCE SYMBOL</th>
          </tr>
        </thead>
        <tbody id="settings-tbody"></tbody>
      </table>
      <div class="settings-save-row">
        <button class="btn-settings-save" onclick="saveAllSettings()">Save Asset Changes</button>
        <button class="btn-settings-cancel" onclick="closeSettingsModal()">Cancel</button>
        <span class="settings-status" id="settings-status"></span>
      </div>
    </div>

  </div>
</div>

<header>
  <div class="logo">
    <div class="logo-box">M4</div>
    <div class="logo-text">
      <h1>Dr. Bob's <span>MCAT</span> <span class="vb">v5.0 LIVE</span></h1>
      <div class="sub">Market Cycle Analysis Tool · Three-Layer System</div>
    </div>
  </div>
  <div class="hdr-right">
    <div class="guide-btn-wrap" id="guide-btn-wrap">
      <button class="guide-btn" onclick="toggleGuidePanel()">
        <span class="qmark">?</span> GUIDE TO 3 LAYER SYSTEM
      </button>
      <div class="guide-panel-hdr">
        <!-- Market Conditions — full-width intro section -->
        <div class="guide-section" style="margin-bottom:14px;">
          <h4 style="color:#00ccdd;">MARKET CONDITIONS STRIP</h4>
          <div style="font-size:13px;color:#d0d0d8;line-height:1.7;">
            The strip at the top of the dashboard shows the current macro environment. This is the single most important context for all your trading decisions — the same cycle signal can produce +155% returns in one environment and +13% in another.
          </div>
          <div style="font-size:13px;color:#d0d0d8;line-height:1.7;margin-top:10px;">
            The color tells you how aggressively to size your positions:
          </div>
          <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
            <div class="guide-row"><span class="gk" style="background:rgba(0,221,136,0.12);color:var(--green);">GREEN</span><span style="font-size:13px;color:#d0d0d8;">Best conditions. Lean in with full sizing.</span></div>
            <div class="guide-row"><span class="gk" style="background:rgba(255,170,0,0.12);color:var(--amber);">AMBER</span><span style="font-size:13px;color:#d0d0d8;">Stress recovery or mixed signals. Standard sizing. Altcoins historically perform best here.</span></div>
            <div class="guide-row"><span class="gk" style="background:rgba(255,80,80,0.12);color:var(--red);">RED</span><span style="font-size:13px;color:#d0d0d8;">Macro headwinds. Signals still work but need patience. Reduced sizing.</span></div>
          </div>
          <div style="font-size:12px;color:#b0b0bc;line-height:1.6;margin-top:10px;">
            Tap the tier badge for details on the specific conditions driving the current classification. The individual indicators (VIX, BTC trend, SPX, M2, Yen) are shown for context — you don't need to interpret them individually. The tier badge already synthesizes them into a single recommendation. They're there so you can see <em>why</em> the system is classifying the environment the way it is.
          </div>
        </div>

        <!-- Cycle Status Bar — full-width intro section -->
        <div class="guide-section" style="margin-bottom:14px;">
          <h4 style="color:#00ccdd;">CYCLE STATUS BAR</h4>
          <div style="font-size:13px;color:#d0d0d8;line-height:1.7;">
            The bar below the market conditions strip shows where you are in the current cycle.
          </div>
          <div style="margin-top:8px;display:flex;flex-direction:column;gap:6px;">
            <div class="guide-row"><span class="gk" style="background:rgba(85,153,255,0.12);color:var(--blue)">Cycle Day</span><span style="font-size:13px;color:#d0d0d8;">How many days since the buy signal fired. The average cycle runs about 100 days. Early in the cycle (days 1–30) is the prime accumulation window. Later in the cycle, focus shifts to monitoring exit conditions.</span></div>
            <div class="guide-row"><span class="gk" style="background:rgba(85,153,255,0.12);color:var(--blue)">Confidence</span><span style="font-size:13px;color:#d0d0d8;">A score from 0 to 4 measuring how many supporting conditions are confirmed. Higher confidence = larger position sizing. The four components are: DPO in buy zone, BTC above 200-day average, S&P 500 above 200-day average, and right translation confirmed.</span></div>
            <div class="guide-row"><span class="gk" style="background:rgba(85,153,255,0.12);color:var(--blue)">Zone Status</span><span style="font-size:13px;color:#d0d0d8;">Whether the current cycle is in the buy zone, waiting, or overheated. This mirrors the Layer 1 gate reading in compact form.</span></div>
          </div>
          <div style="font-size:12px;color:#b0b0bc;line-height:1.6;margin-top:10px;">
            Technical: Cycle day = calendar days since signal date (Settings). Confidence = sum of 4 binary conditions (M61). Zone = both 1W + 2W DPO below thresholds.
          </div>
        </div>

        <div class="guide-grid">

          <div class="guide-section">
            <h4 style="color:var(--amber)">LAYER 1 · THE BIG PICTURE</h4>
            <div style="font-size:11px;color:#b0b0bc;margin-bottom:10px;line-height:1.6;">This layer tells you whether the overall altcoin market is cheap or expensive. When both weekly indicators drop into the green zone, the buy window opens.</div>
            <div class="guide-row"><span class="gk" style="background:rgba(0,221,136,0.12);color:var(--green)">✓✓ IN BUY ZONE</span><span>The market is at its cheapest point in the cycle — highest conviction window to buy. Both indicators confirmed below 20.<br><span style="color:#b0b0bc;font-size:10px;font-family:'Space Mono',monospace">Technical: 1W + 2W DPO both &lt;20. July 2024 precedent: +100% altcoin move.</span></span></div>
            <div class="guide-row"><span class="gk" style="background:rgba(74,222,128,0.12);color:#4ade80">✓ IN BUY ZONE</span><span>Both indicators are below 25 — the buy zone is active. Good window to start building positions. Full confirmation comes when both drop below 20.<br><span style="color:#b0b0bc;font-size:10px;font-family:'Space Mono',monospace">Technical: 1W + 2W DPO both &lt;25 but not yet confirmed &lt;20.</span></span></div>
            <div class="guide-row"><span class="gk" style="background:rgba(255,170,0,0.12);color:var(--amber)">NOT YET</span><span>Mid-cycle — nothing to do right now. The indicators haven't reached actionable levels yet.<br><span style="color:#b0b0bc;font-size:10px;font-family:'Space Mono',monospace">Technical: DPOs between 30–80. No gate conditions met.</span></span></div>
            <div class="guide-row"><span class="gk" style="background:rgba(255,80,80,0.12);color:var(--red)">OVERHEATED</span><span>The market is stretched high — definitely not a buying zone. Consider taking profits, especially if both indicators peak near 83–90.<br><span style="color:#b0b0bc;font-size:10px;font-family:'Space Mono',monospace">Technical: 1W or 2W DPO &gt;80. Both peaking simultaneously → EXIT signal.</span></span></div>
          </div>

          <div class="guide-section">
            <h4 style="color:var(--blue)">LAYER 2 · EACH ASSET'S CYCLE</h4>
            <div style="font-size:11px;color:#b0b0bc;margin-bottom:10px;line-height:1.6;">Each coin has its own cycle. Layer 2 shows where each one is independently — some will be cheap before others. The 2-week indicator typically bottoms first, then the 1-week follows.</div>
            <div class="guide-row"><span class="gk" style="background:rgba(85,153,255,0.12);color:var(--blue)">1W + 2W</span><span>The main cycle indicators for each asset. When both drop below 25, the asset is entering its buy zone. Below 20 = confirmed floor.<br><span style="color:#b0b0bc;font-size:10px;font-family:'Space Mono',monospace">Technical: 1W and 2W DPO proxies per asset. 2W bottoms first → 1W follows.</span></span></div>
            <div class="guide-row"><span class="gk" style="background:rgba(85,153,255,0.12);color:var(--blue)">1D + 3D</span><span>Faster indicators that help with timing. You want these already rising from a low point when you enter — that confirms the cycle has turned.<br><span style="color:#b0b0bc;font-size:10px;font-family:'Space Mono',monospace">Technical: 1D and 3D DPO. Entry sequence: 2W bottoms → 1W follows → 3D turns ↑ → 1D turns last.</span></span></div>
            <div class="guide-row"><span class="gk" style="background:rgba(85,153,255,0.12);color:var(--blue)">200MA %</span><span>How far below (or above) the 200-day average price. A deeper discount means more room to run when the cycle turns up.<br><span style="color:#b0b0bc;font-size:10px;font-family:'Space Mono',monospace">Technical: (Price − 200MA) / 200MA × 100. More negative = greater reversion potential.</span></span></div>
            <div class="guide-row"><span class="gk" style="background:rgba(255,255,255,0.06);color:var(--sub)">ARROWS ↑↓</span><span>Shows which direction the indicator is heading. Green ↑ = rising over the last 5 days. Red ↓ = falling. Watch for the weekly arrows to flip green at low levels — that's the floor forming.<br><span style="color:#b0b0bc;font-size:10px;font-family:'Space Mono',monospace">Technical: 5-day delta comparison. Trend reversal at low DPO = floor confirmation.</span></span></div>
          </div>

          <div class="guide-section">
            <h4 style="color:var(--purple)">LAYER 3 · THE ENTRY TRIGGER</h4>
            <div style="font-size:11px;color:#b0b0bc;margin-bottom:10px;line-height:1.6;">This is the timing layer — it tells you <em>when</em> to enter. The 4-hour indicator is the single most important number in the system. When it drops low and starts turning up, that's your signal.</div>
            <div class="guide-row"><span class="gk" style="background:rgba(176,136,255,0.2);color:var(--purple)">4H TRIGGER ★</span><span>The most important indicator. When it drops below 20 and turns upward — that is your precise entry moment. In strong uptrends, it may fire earlier (25–28).<br><span style="color:#b0b0bc;font-size:10px;font-family:'Space Mono',monospace">Technical: 4H DPO proxy &lt;20 AND trend = ↑. Bull mode relaxes threshold to &lt;30.</span></span></div>
            <div class="guide-row"><span class="gk" style="background:rgba(176,136,255,0.12);color:var(--purple)">MULTIPLE TRIGGERS</span><span>When the 2H and 4H both bottom and turn up at the same time, that's the highest confidence version of the entry signal.<br><span style="color:#b0b0bc;font-size:10px;font-family:'Space Mono',monospace">Technical: 2H + 4H both &lt;20 and turning ↑ simultaneously. Score 3-4/4 = TRIGGER FIRED state.</span></span></div>
            <div class="guide-row"><span class="gk" style="background:rgba(0,221,136,0.12);color:var(--green)">TRIGGER FIRED</span><span>Multiple short-term indicators have bottomed and turned up together. This is the precise moment the system is designed to catch — all three layers are aligned.<br><span style="color:#b0b0bc;font-size:10px;font-family:'Space Mono',monospace">Technical: Score 3–4/4. Sub-daily proxies below 30 and turning ↑. Full Layer 1+2+3 confluence.</span></span></div>
          </div>

          <div class="guide-section">
            <h4 style="color:var(--hot)">YOUR PORTFOLIO TIERS</h4>
            <div style="font-size:11px;color:#b0b0bc;margin-bottom:10px;line-height:1.6;">Assets are grouped by conviction level. Core positions are your primary targets — signals on these are the most actionable. Lower tiers require more judgment.</div>
            <div class="guide-row"><span class="gk" style="background:rgba(255,170,0,0.15);color:var(--amber)">CORE</span><span>Highest conviction: XRP, QNT, TAO, CC. When these flash a buy signal, it's your primary action zone.</span></div>
            <div class="guide-row"><span class="gk" style="background:rgba(85,153,255,0.12);color:var(--blue)">TIER 1</span><span>Strong secondary: XLM, HBAR, XDC, ALGO, IOTA, AERO. Same signal criteria apply — use your judgment on position size.</span></div>
            <div class="guide-row"><span class="gk" style="background:rgba(0,204,221,0.10);color:var(--cyan)">TIER 2</span><span>Speculative / limited data: FLR. ⚠ Less price history means the cycle readings are less reliable. Treat as directional guidance only.</span></div>
            <div class="guide-row"><span class="gk" style="background:rgba(122,112,96,0.15);color:var(--sub)">REFERENCE</span><span>BTC and ETH — not buy targets, but useful for reading the overall market direction and confirming macro context.</span></div>
          </div>

        </div>
      </div>
    </div>
    <button class="settings-btn" onclick="openSettingsModal()">
      <span class="gear">⚙</span> Settings
    </button>
    <div class="status-pill">
      <div class="status-dot stale" id="status-dot"></div>
      <div class="status-text" id="status-text">Initializing...</div>
    </div>
    <button class="refresh-btn" id="refresh-btn" onclick="refreshAll()">
      <span id="refresh-ico">↻</span> Refresh
    </button>
  </div>
</header>

<!-- DATA WARNING BANNER -->
<div id="data-warning" style="display:none;background:rgba(255,80,80,0.1);border-bottom:2px solid rgba(255,80,80,0.4);
  padding:10px 24px;align-items:center;gap:12px;flex-wrap:wrap;">
  <span style="font-size:16px">⚠️</span>
  <div style="flex:1;">
    <div style="font-size:11px;font-weight:700;color:var(--red);font-family:'Space Mono',monospace;margin-bottom:2px;">LIVE DATA NOT LOADING</div>
    <div class="dw-msg" style="font-size:11px;color:#c09090;line-height:1.5;">
      Live data is not loading — all values shown are seed data from Feb 21, 2026.
      <strong style="color:var(--text)">Do not make trading decisions based on these numbers.</strong>
      A free CoinGecko API key is required. Open the HTML file, find <code style="color:var(--amber)">YOUR_API_KEY_HERE</code> and replace it with your key, then re-upload to GitHub.
    </div>
  </div>
  <button onclick="document.getElementById('data-warning').style.display='none';refreshAll();"
    style="background:var(--red);border:none;border-radius:6px;padding:7px 14px;
    color:#fff;font-family:'Space Mono',monospace;font-size:10px;font-weight:700;cursor:pointer;flex-shrink:0;">
    RETRY
  </button>
  <button onclick="document.getElementById('data-warning').style.display='none';"
    style="background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:7px 14px;
    color:#b0b0bc;font-family:'Space Mono',monospace;font-size:10px;cursor:pointer;flex-shrink:0;">
    Dismiss
  </button>
</div>

<!-- GLOBAL MACRO STRIP -->
<div class="macro-strip" id="macro-strip">
  <span class="ms-title">MARKET CONDITIONS</span>
  <div class="ms-sep"></div>
  <div class="ms-tier" id="ms-tier">
    <span class="ms-tier-badge ms-amber" id="ms-tier-badge">AMBER</span>
    <div class="ms-tier-tooltip" id="ms-tier-tooltip">Rule 6: VIX &lt;20 + BTC bear → AMBER</div>
  </div>
  <div class="ms-sep"></div>
  <div class="ms-item" id="ms-vix">
    <span class="ms-label">VIX</span>
    <span class="ms-val" id="ms-vix-val">—</span>
  </div>
  <div class="ms-sep"></div>
  <div class="ms-item" id="ms-btc">
    <span class="ms-label">BTC</span>
    <span class="ms-val" id="ms-btc-val">—</span>
  </div>
  <div class="ms-sep"></div>
  <div class="ms-item" id="ms-spx">
    <span class="ms-label">SPX</span>
    <span class="ms-val" id="ms-spx-val">—</span>
  </div>
  <div class="ms-sep"></div>
  <div class="ms-item" id="ms-m2">
    <span class="ms-label">M2</span>
    <span class="ms-val" id="ms-m2-val">—</span>
  </div>
  <div class="ms-item" id="ms-yen" style="display:none">
    <div class="ms-sep"></div>
    <span class="ms-val ms-val-red" style="font-weight:700">¥ UNWIND</span>
  </div>
</div>

<!-- CONTEXT STRIP -->
<div class="ctx-strip" id="ctx-strip">
  <!-- Cycle Day -->
  <div class="ctx-seg" id="ctx-day-seg">
    <span class="ctx-day" id="ctx-day-num">DAY 13</span>
    <span class="ctx-day-sub">of ~100d</span>
    <div class="ctx-tt">
      <div class="ctx-tt-title">CYCLE DAY COUNTER</div>
      <div class="ctx-tt-body">Days since the DPO buy signal fired. The average cycle runs about 100 days from signal to the next meaningful move.</div>
      <div class="ctx-tt-tech">Signal date: Feb 13, 2026. Cycle mean: 104d (M38). Range: 60-120d typical.</div>
    </div>
  </div>

  <!-- Progress Bar -->
  <div class="ctx-seg">
    <div class="ctx-progress" id="ctx-progress">
      <div class="ctx-prog-z1" style="width:25%"></div>
      <div class="ctx-prog-z2" style="left:25%;width:25%"></div>
      <div class="ctx-prog-z3" style="left:50%;width:50%"></div>
      <div class="ctx-prog-marker" style="left:5%"></div>
      <div class="ctx-prog-marker" style="left:25%"></div>
      <div class="ctx-prog-marker" style="left:50%"></div>
      <div class="ctx-prog-dot" id="ctx-prog-dot" style="left:13%"></div>
    </div>
  </div>

  <!-- Zone Status -->
  <div class="ctx-seg" id="ctx-zone-seg">
    <span class="ctx-pill ctx-pill-green" id="ctx-zone-pill">Zone 2 Active</span>
    <div class="ctx-tt">
      <div class="ctx-tt-title">ENTRY ZONE</div>
      <div class="ctx-tt-body">Zone 2 is the optimal entry window — historically produces the best risk-adjusted returns for most assets (+95.8% EV at 90 days).</div>
      <div class="ctx-tt-tech">Zone 1: Days 1-5 (immediate). Zone 2: Days 5-25 (optimal). Zone 3: Days 25+ (value destroys, −51pp EV). Ref: M54, M63.</div>
    </div>
  </div>

  <!-- Zone Countdown -->
  <div class="ctx-seg" id="ctx-countdown-seg">
    <div class="ctx-countdown">
      <span class="ctx-countdown-label">Z2 CLOSES</span>
      <span class="ctx-countdown-val" id="ctx-countdown-days" style="color:var(--green)">~11d</span>
      <span class="ctx-countdown-date" id="ctx-countdown-date">Mar 9</span>
    </div>
    <div class="ctx-tt">
      <div class="ctx-tt-title">ZONE 2 COUNTDOWN</div>
      <div class="ctx-tt-body">Days remaining in the optimal entry window. After this closes, Zone 3 begins — historically waiting destroys value (−51pp EV drop, +27.5% higher entry cost).</div>
      <div class="ctx-tt-tech">Zone 2 closes ~Day 25. Signal date Feb 13 → closes ~Mar 9. Ref: M54, M63.</div>
    </div>
  </div>

  <!-- Macro Quality -->
  <div class="ctx-seg" id="ctx-macro-seg">
    <span class="ctx-pill ctx-pill-red" id="ctx-macro-pill">MACRO: RED</span>
    <span class="ctx-ev" id="ctx-macro-ev" style="color:var(--red)">+15%</span>
    <div class="ctx-tt">
      <div class="ctx-tt-title">MACRO QUALITY SCORE</div>
      <div class="ctx-tt-body" id="ctx-macro-tt-body">The macro environment is unfavorable. BTC is below its 200-day average in a stressed VIX zone. Expected returns are significantly compressed — position sizing should be conservative.</div>
      <div class="ctx-tt-tech" id="ctx-macro-tt-tech">MQS lookup: VIX 20-30 + BTC bear = RED (Rule 3). Macro-adjusted 90d EV: +15.3% vs raw +95.8%. n=34, 65% hit rate. Ref: M65.</div>
    </div>
  </div>

  <!-- Cycle Confidence -->
  <div class="ctx-seg" id="ctx-conf-seg">
    <span style="font-size:10px;font-family:'Space Mono',monospace;color:#b0b0bc;letter-spacing:1px;font-weight:700;">CONFIDENCE</span>
    <div class="ctx-conf-dots" id="ctx-conf-dots">
      <div class="ctx-dot ctx-dot-on"></div>
      <div class="ctx-dot ctx-dot-off"></div>
      <div class="ctx-dot ctx-dot-pending"></div>
      <div class="ctx-dot ctx-dot-pending"></div>
    </div>
    <span class="ctx-conf-score" id="ctx-conf-score">1/4</span>
    <div class="ctx-tt">
      <div class="ctx-tt-title">CYCLE CONFIDENCE (4-POINT)</div>
      <div class="ctx-tt-body">How clean is this setup compared to historical best cases. Not a signal modifier — a readability gauge for how much to trust the current signal.</div>
      <div class="ctx-tt-tech" style="line-height:1.8;">
        <span style="color:var(--green)">●</span> DPO both &lt;20 at signal — YES<br>
        <span style="color:var(--sub)">○</span> BTC above 200MA — NO (−31.6%)<br>
        <span style="color:var(--sub);animation:ctx-pulse 2s ease-in-out infinite">◐</span> SPX above 200MA — TBD (no data feed)<br>
        <span style="color:var(--sub);animation:ctx-pulse 2s ease-in-out infinite">◐</span> Right translation — PENDING (~Apr 3)<br>
        <span style="margin-top:4px;display:block;color:#b0b0bc">Ref: M61. Best post-2022: right-trans + BTC bull = 88% positive (M62).</span>
      </div>
    </div>
  </div>

  <!-- Translation / Trend -->
  <div class="ctx-seg" id="ctx-trend-seg">
    <span class="ctx-pill ctx-pill-grey" id="ctx-trend-pill">TREND: PENDING</span>
    <span style="font-size:11px;font-family:'Space Mono',monospace;color:#b0b0bc;" id="ctx-trend-info">Day 45 · Apr 3</span>
    <div class="ctx-tt">
      <div class="ctx-tt-title">TREND DIRECTION</div>
      <div class="ctx-tt-body">After a buy signal fires, we need to verify the price actually moved in the right direction. This takes about 50 days to confirm. Until then, treat the signal with appropriate caution.</div>
      <div class="ctx-tt-tech">Translation measures whether cycle midpoint price exceeded starting price. PENDING until Day 50-55. Right-translation is the single most powerful factor (+57pp at 90d). Ref: M39, M59.</div>
    </div>
  </div>
</div>

<!-- GATE -->
<div class="gate" id="gate-panel">
  <div class="gate-top">
    <div class="gate-led closed" id="gate-led"></div>
    <div class="gate-eyebrow">LAYER 1 · TOTAL3 MASTER GATE</div>
    <div class="gate-status-wrap">
      <div class="gate-status" id="gate-status-text" style="color:var(--amber)">Loading...</div>
      <div class="gate-tooltip" id="gate-tooltip">
        <div style="font-size:10px;font-family:'Space Mono',monospace;color:#00ccdd;letter-spacing:2px;margin-bottom:12px;font-weight:700;">GATE STATUS GUIDE</div>
        <div class="gt-row"><span class="gt-key" style="background:rgba(0,221,136,0.15);color:var(--green)">✓✓ IN BUY ZONE</span><span>The market is at the deepest point in its cycle — this is the highest conviction window to buy.<br><span style="color:#b0b0bc;font-family:Space Mono,monospace;font-size:10px">Technical: Both 1W + 2W DPO below 20.</span></span></div>
        <div class="gt-row"><span class="gt-key" style="background:rgba(74,222,128,0.12);color:#4ade80">✓ IN BUY ZONE</span><span>The buy zone is active — both indicators are below 25. Good window to start building positions. Waiting for deeper confirmation below 20 for highest conviction.<br><span style="color:#b0b0bc;font-family:Space Mono,monospace;font-size:10px">Technical: Both 1W + 2W below 25 but not yet confirmed below 20.</span></span></div>
        <div class="gt-row"><span class="gt-key" style="background:rgba(255,170,0,0.12);color:var(--amber)">NOT YET</span><span>Mid-cycle — nothing actionable. The market hasn't reached the buy zone yet.<br><span style="color:#b0b0bc;font-family:Space Mono,monospace;font-size:10px">Technical: DPOs between 30–80. Gate conditions not met.</span></span></div>
        <div class="gt-row"><span class="gt-key" style="background:rgba(255,80,80,0.12);color:var(--red)">OVERHEATED</span><span>Cycle is stretched high — not a buy zone. Consider taking profits, especially when both indicators peak near 83–90.<br><span style="color:#b0b0bc;font-family:Space Mono,monospace;font-size:10px">Technical: One or both DPOs above 80. Both peaking → EXIT signal.</span></span></div>
      </div>
    </div>
    <div style="margin-left:auto;font-size:9px;font-family:'Space Mono',monospace;color:#b0b0bc" id="gate-updated">as of Feb 21, 2026</div>
  </div>
  <div class="gate-body">
    <div class="gate-desc" id="gate-desc">Computing TOTAL3 cycle indicators...</div>
    <div class="gate-readings">
      <div class="reading">
        <div class="reading-label">1W CYCLE</div>
        <div class="reading-val" id="gate-1w" style="color:var(--amber)">--</div>
        <div class="reading-trend" id="gate-1w-trend">--</div>
        <div class="reading-sub rsub-mid" id="gate-1w-sub">--</div>
      </div>
      <div class="reading">
        <div class="reading-label">2W CYCLE</div>
        <div class="reading-val" id="gate-2w" style="color:var(--amber)">--</div>
        <div class="reading-trend" id="gate-2w-trend">--</div>
        <div class="reading-sub rsub-mid" id="gate-2w-sub">--</div>
      </div>
      <div class="reading">
        <div class="reading-label">TOTAL3 ~</div>
        <div class="reading-val" id="gate-t3" style="color:var(--blue);font-size:24px;padding-top:2px">--</div>
        <div style="height:22px"></div>
        <div class="reading-sub rsub-mid">excl. BTC+ETH</div>
      </div>
    </div>
  </div>
</div>

<!-- MQS + ENTRY OPTIMIZER PANEL -->
<div class="mqs-panel" id="mqs-panel">
  <div class="mqs-header">
    <!-- MQS -->
    <div class="mqs-block" style="position:relative;cursor:help;" onmouseenter="this.querySelector('.mqs-tt').style.display='block'" onmouseleave="this.querySelector('.mqs-tt').style.display='none'">
      <div class="mqs-block-title">MQS</div>
      <span class="ctx-pill ctx-pill-red" id="mqs-header-pill">RED</span>
      <span class="mqs-ev-main" style="color:var(--red)" id="mqs-header-ev">+15.3%</span>
      <span class="mqs-ev-sub">90d EV</span>
      <span class="mqs-health" id="mqs-health-status"><span class="mqs-health-dot mqs-health-seed"></span> <span class="mqs-health-label">SEED</span></span>
      <div class="mqs-tt" style="display:none;position:absolute;top:calc(100% + 8px);left:0;z-index:400;background:#141420;border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:16px 20px;width:340px;box-shadow:0 10px 32px rgba(0,0,0,0.8);white-space:normal;">
        <div style="font-size:14px;font-family:'Space Mono',monospace;font-weight:700;color:#00ccdd;letter-spacing:1.5px;margin-bottom:8px;">MACRO QUALITY SCORE</div>
        <div style="font-size:13px;color:#d0d0d8;line-height:1.7;" id="mqs-header-tt-body">The macro environment is unfavorable. BTC is below its 200-day average in a stressed VIX zone. Expected returns are significantly compressed — position sizing should be conservative.</div>
        <div style="font-size:12px;font-family:'Space Mono',monospace;color:#b0b0bc;line-height:1.6;margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.08);" id="mqs-header-tt-tech">Technical: VIX 20–30 + BTC below 200MA = RED (Rule 3). Macro-adjusted 90d EV: +15.3% vs raw +95.8%. n=34, 65% hit. SEED = using initial calibration data, not live feeds yet. Ref: M65.</div>
      </div>
    </div>

    <!-- Separator -->
    <div style="width:1px;height:20px;background:rgba(255,255,255,0.1);flex-shrink:0;"></div>

    <!-- Entry Optimizer -->
    <div class="mqs-block" style="position:relative;cursor:help;" onmouseenter="this.querySelector('.mqs-tt').style.display='block'" onmouseleave="this.querySelector('.mqs-tt').style.display='none'">
      <div class="mqs-block-title">ENTRY</div>
      <span class="ctx-pill ctx-pill-green">ZONE 2</span>
      <span class="mqs-ev-sub" style="color:#d0d0d8;">Closes <span style="color:var(--green);font-weight:700">~11d</span> · Mar 9</span>
      <div class="mqs-tt" style="display:none;position:absolute;top:calc(100% + 8px);left:0;z-index:400;background:#141420;border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:16px 20px;width:340px;box-shadow:0 10px 32px rgba(0,0,0,0.8);white-space:normal;">
        <div style="font-size:14px;font-family:'Space Mono',monospace;font-weight:700;color:#00ccdd;letter-spacing:1.5px;margin-bottom:8px;">ENTRY OPTIMIZER</div>
        <div style="font-size:13px;color:#d0d0d8;line-height:1.7;">Zone 2 is the optimal entry window — historically the best risk-adjusted returns. After this closes, waiting typically destroys value.</div>
        <div style="font-size:12px;font-family:'Space Mono',monospace;color:#b0b0bc;line-height:1.6;margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.08);">Technical: Zone 2 = Days 5–25 post-signal. EV: +95.8% raw at 90d. Zone 3 (Day 25+): −51pp EV drop, +27.5% higher entry cost. Best sub-zone: VIX &lt;20 → +155% EV. Ref: M54, M63.</div>
      </div>
    </div>

    <!-- Separator -->
    <div style="width:1px;height:20px;background:rgba(255,255,255,0.1);flex-shrink:0;"></div>

    <!-- Position Sizing -->
    <div class="mqs-block" style="position:relative;cursor:help;" onmouseenter="this.querySelector('.mqs-tt').style.display='block'" onmouseleave="this.querySelector('.mqs-tt').style.display='none'">
      <div class="mqs-block-title">SIZE</div>
      <span class="mqs-ev-main" style="color:var(--red)" id="mqs-size-val">20–25%</span>
      <span class="mqs-ev-sub">of max</span>
      <div class="mqs-tt" style="display:none;position:absolute;top:calc(100% + 8px);left:0;z-index:400;background:#141420;border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:16px 20px;width:340px;box-shadow:0 10px 32px rgba(0,0,0,0.8);white-space:normal;">
        <div style="font-size:14px;font-family:'Space Mono',monospace;font-weight:700;color:#00ccdd;letter-spacing:1.5px;margin-bottom:8px;">POSITION SIZING</div>
        <div style="font-size:13px;color:#d0d0d8;line-height:1.7;" id="mqs-size-tt-body">Based on the RED macro backdrop, recommended allocation is 20–25% of your maximum position size. Signal is still valid but the macro environment has historically compressed returns. An upgrade to AMBER (50–60%) requires BTC crossing above its 200MA.</div>
        <div style="font-size:12px;font-family:'Space Mono',monospace;color:#b0b0bc;line-height:1.6;margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.08);">Technical: GREEN = 70–80% max. AMBER = 50–60%. RED = 20–25%. CAPITULATION (VIX &gt;45) = override to 80–100%. Ref: M65.</div>
      </div>
    </div>

    <!-- Separator -->
    <div style="width:1px;height:20px;background:rgba(255,255,255,0.1);flex-shrink:0;"></div>

    <!-- Alert -->
    <div class="mqs-block" style="flex:1;">
      <span class="mqs-alert mqs-alert-normal" id="mqs-alert-line">All inputs stable · VIX 21.4 · No alerts</span>
    </div>

    <!-- Expand Button -->
    <button class="mqs-expand-btn-v2" onclick="document.getElementById('mqs-panel').classList.toggle('expanded')">
      DETAILS <span class="arrow">▼</span>
    </button>
  </div>

  <!-- Expandable Details -->
  <div class="mqs-details" id="mqs-details">
    <div style="font-size:12px;font-family:'Space Mono',monospace;color:#00ccdd;letter-spacing:1.5px;font-weight:700;margin-bottom:8px;">MACRO INPUTS</div>
    <div class="mqs-inputs-grid">
      <div class="mqs-input-cell">
        <div class="mqs-input-label">VIX</div>
        <div class="mqs-input-val" style="color:var(--amber)" id="mqs-input-vix-val">21.4</div>
        <div class="mqs-input-status" style="color:var(--amber)" id="mqs-input-vix-status">Range 20–30</div>
      </div>
      <div class="mqs-input-cell">
        <div class="mqs-input-label">BTC 200MA</div>
        <div class="mqs-input-val" style="color:var(--red)" id="mqs-input-btc-val">BELOW</div>
        <div class="mqs-input-status" style="color:var(--sub)" id="mqs-input-btc-status">−31.6% · Bear regime</div>
      </div>
      <div class="mqs-input-cell">
        <div class="mqs-input-label">SPX CO-BOTTOM</div>
        <div class="mqs-input-val" style="color:var(--green)" id="mqs-input-spx-val">NONE</div>
        <div class="mqs-input-status" style="color:var(--sub)">No ±30d overlap</div>
      </div>
      <div class="mqs-input-cell">
        <div class="mqs-input-label">YEN CARRY</div>
        <div class="mqs-input-val" style="color:var(--green)" id="mqs-input-yen-val">STABLE</div>
        <div class="mqs-input-status" style="color:var(--sub)">USDJPY: no unwind</div>
      </div>
      <div class="mqs-input-cell">
        <div class="mqs-input-label">M2 SUPPLY</div>
        <div class="mqs-input-val" style="color:var(--sub)" id="mqs-input-m2-val">NEUTRAL</div>
        <div class="mqs-input-status" style="color:var(--sub)">FRED · 4–6wk lag</div>
      </div>
    </div>

    <!-- Decision Path + Triggers — two-column row -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:14px;">

      <!-- LEFT: Decision Path Tree -->
      <div style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:14px 18px;">
        <div style="font-size:12px;font-family:'Space Mono',monospace;color:#00ccdd;letter-spacing:1.5px;font-weight:700;margin-bottom:10px;">DECISION PATH</div>
        <div style="font-size:11px;line-height:2.0;font-family:'Space Mono',monospace;" id="mqs-decision-path">
          <div style="color:#b0b0bc;">1. VIX &gt;45 → GREEN capitulation</div>
          <div style="color:#b0b0bc;">2. SPX co-bottom + VIX &lt;30 → RED</div>
          <div style="color:var(--red);font-weight:700;border-left:3px solid var(--red);padding-left:10px;margin-left:-13px;">3. VIX 20–30 + BTC bear → RED ← YOU ARE HERE</div>
          <div style="color:#b0b0bc;">4. VIX 20–30 + BTC bull → AMBER</div>
          <div style="color:#b0b0bc;">5. VIX 30–45 → AMBER</div>
          <div style="color:#b0b0bc;">6. VIX &lt;20 + BTC bear → AMBER</div>
          <div style="color:#b0b0bc;">7. VIX &lt;20 + BTC bull → GREEN</div>
          <div style="color:#b0b0bc;font-size:11px;margin-top:4px;padding-left:14px;">8–10. Overrides: yen unwind, M2 expand/contract</div>
          <div style="font-size:11px;color:var(--red);margin-top:10px;padding-top:8px;border-top:1px solid var(--border);font-family:'Space Mono',monospace;">Result: RED · +15.3% adjusted EV · n=34, 65% hit</div>
        </div>
      </div>

      <!-- RIGHT: What Would Change the Tier -->
      <div style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:14px 18px;">
        <div style="font-size:12px;font-family:'Space Mono',monospace;color:#00ccdd;letter-spacing:1.5px;font-weight:700;margin-bottom:10px;">WHAT WOULD CHANGE THE TIER</div>
        <div style="font-size:12px;line-height:1.8;color:#b0b0bc;" id="mqs-triggers">
          <div style="margin-bottom:10px;">
            <div style="color:var(--amber);font-weight:700;font-size:11px;font-family:'Space Mono',monospace;margin-bottom:2px;">⬆ UPGRADE TO AMBER</div>
            <div>BTC crosses above its 200-day moving average — moves from Rule 3 to Rule 4<br><span style="font-family:'Space Mono',monospace;font-size:11px;color:var(--amber);">+28.4% EV · 79% hit · sizing moves to 50–60%</span></div>
          </div>
          <div style="margin-bottom:10px;">
            <div style="color:var(--green);font-weight:700;font-size:11px;font-family:'Space Mono',monospace;margin-bottom:2px;">⬆⬆ UPGRADE TO GREEN</div>
            <div>VIX drops below 20 <strong style="color:var(--text)">AND</strong> BTC crosses above 200MA <strong style="color:var(--text)">AND</strong> no SPX co-bottom — Rule 7<br><span style="font-family:'Space Mono',monospace;font-size:11px;color:var(--green);">+155.5% EV · sizing moves to 70–80%</span></div>
          </div>
          <div style="margin-bottom:10px;">
            <div style="color:var(--red);font-weight:700;font-size:11px;font-family:'Space Mono',monospace;margin-bottom:2px;">⬇ STAY RED — WORSE</div>
            <div>SPX co-bottom detected — S&P 500 bottoms within ±30 days of the crypto signal. Co-bottom historically destroys EV.</div>
          </div>
          <div>
            <div style="color:var(--purple);font-weight:700;font-size:11px;font-family:'Space Mono',monospace;margin-bottom:2px;">⚡ CAPITULATION OVERRIDE</div>
            <div>VIX spikes above 45 → immediate GREEN override<br><span style="font-family:'Space Mono',monospace;font-size:11px;color:var(--purple);">+111.7% EV · 100% historical hit rate</span></div>
          </div>
        </div>
      </div>

    </div>

    <!-- Zone Breakdown -->
    <div style="font-size:12px;font-family:'Space Mono',monospace;color:#00ccdd;letter-spacing:1.5px;font-weight:700;margin:16px 0 8px;">ZONE BREAKDOWN</div>
    <div class="mqs-zones">
      <div class="mqs-zone-card">
        <div class="mqs-zone-badge" style="background:rgba(0,221,136,0.12);color:var(--green);">PASSED</div>
        <div style="font-size:11px;font-family:'Space Mono',monospace;color:#b0b0bc;margin-bottom:4px;">ZONE 1 · Days 1–5</div>
        <div class="mqs-zone-sub">Immediate entry window</div>
      </div>
      <div class="mqs-zone-card active">
        <div class="mqs-zone-badge" style="background:rgba(0,221,136,0.15);color:var(--green);">ACTIVE</div>
        <div style="font-size:11px;font-family:'Space Mono',monospace;color:var(--green);margin-bottom:4px;">ZONE 2 · Days 5–25</div>
        <div class="mqs-zone-ev" id="mqs-zone2-adj-primary" style="color:var(--green)">+28%</div>
        <div class="mqs-zone-sub" id="mqs-zone2-adj-label">macro-adjusted</div>
        <div class="mqs-zone-sub" id="mqs-zone2-raw" style="color:#b0b0bc;margin-top:2px;font-size:10px;">(+95.8% raw historical)</div>
      </div>
      <div class="mqs-zone-card">
        <div class="mqs-zone-badge" style="background:rgba(152,152,168,0.1);color:var(--sub);">UPCOMING</div>
        <div style="font-size:11px;font-family:'Space Mono',monospace;color:#b0b0bc;margin-bottom:4px;">ZONE 3 · Days 25+</div>
        <div class="mqs-zone-ev" style="color:var(--red)">+44.7%</div>
        <div class="mqs-zone-sub">−51pp EV drop · avoid waiting</div>
      </div>
    </div>
  </div>
</div>

<!-- HOT CARDS -->
<div class="sec-bar sec-bar-hot">
  <div class="sec-bar-inner">
    <span class="sec-tag sec-tag-hot">🔥 HOT</span>
    <span class="sec-tickers" id="hot-tickers">ACTIVE WATCH</span>
    <span class="sec-hint">drag to reorder</span>
  </div>
</div>
<div class="hot-grid" id="hot-grid"></div>

<!-- REFERENCE -->
<div class="sec-bar sec-bar-ref">
  <div class="sec-bar-inner">
    <span class="sec-tag sec-tag-ref">REFERENCE</span>
    <span class="sec-tickers" id="ref-tickers">BTC · ETH</span>
    <span style="font-size:9px;font-family:'Space Mono',monospace;color:var(--sub);opacity:.5;">MACRO CONTEXT ONLY</span>
  </div>
  <button class="sec-add-btn" style="color:#a09080;background:rgba(122,112,96,0.1);" onclick="openMoveModal('REFERENCE')">→ MOVE</button>
  <button class="sec-add-btn" style="color:var(--red);background:rgba(255,80,80,0.08);" onclick="openDeleteModal('REFERENCE')">－ DELETE</button>
  <button class="sec-add-btn" onclick="openAddModal('REFERENCE')">
    <span class="sec-add-plus">＋</span> ADD
  </button>
</div>
<div class="main-grid" id="ref-grid"></div>

<!-- CORE -->
<div class="sec-bar sec-bar-core">
  <div class="sec-bar-inner">
    <span class="sec-tag sec-tag-core">CORE</span>
    <span class="sec-tickers" id="core-tickers">XRP · QNT · TAO · CC</span>
  </div>
  <button class="sec-add-btn" style="color:#a09080;background:rgba(122,112,96,0.1);" onclick="openMoveModal('CORE')">→ MOVE</button>
  <button class="sec-add-btn" style="color:var(--red);background:rgba(255,80,80,0.08);" onclick="openDeleteModal('CORE')">－ DELETE</button>
  <button class="sec-add-btn" onclick="openAddModal('CORE')">
    <span class="sec-add-plus">＋</span> ADD
  </button>
</div>
<div class="main-grid" id="core-grid"></div>

<!-- TIER 1 -->
<div class="sec-bar sec-bar-t1">
  <div class="sec-bar-inner">
    <span class="sec-tag sec-tag-t1">TIER 1</span>
    <span class="sec-tickers" id="t1-tickers">XLM · HBAR · XDC · ALGO · IOTA · AERO</span>
  </div>
  <button class="sec-add-btn" style="color:#a09080;background:rgba(122,112,96,0.1);" onclick="openMoveModal('TIER1')">→ MOVE</button>
  <button class="sec-add-btn" style="color:var(--red);background:rgba(255,80,80,0.08);" onclick="openDeleteModal('TIER1')">－ DELETE</button>
  <button class="sec-add-btn" onclick="openAddModal('TIER1')">
    <span class="sec-add-plus">＋</span> ADD
  </button>
</div>
<div class="main-grid" id="t1-grid"></div>

<!-- TIER 2 -->
<div class="sec-bar sec-bar-t2">
  <div class="sec-bar-inner">
    <span class="sec-tag sec-tag-t2">TIER 2</span>
    <span class="sec-tickers" id="t2-tickers">FLR</span>
  </div>
  <button class="sec-add-btn" style="color:#a09080;background:rgba(122,112,96,0.1);" onclick="openMoveModal('TIER2')">→ MOVE</button>
  <button class="sec-add-btn" style="color:var(--red);background:rgba(255,80,80,0.08);" onclick="openDeleteModal('TIER2')">－ DELETE</button>
  <button class="sec-add-btn" onclick="openAddModal('TIER2')">
    <span class="sec-add-plus">＋</span> ADD
  </button>
</div>
<div class="main-grid" id="t2-grid"></div>

<!-- WATCHLIST -->
<div class="sec-bar sec-bar-watch">
  <div class="sec-bar-inner">
    <span class="sec-tag sec-tag-watch">WATCHLIST</span>
    <span class="sec-tickers" id="watch-tickers">CRO · ZORA</span>
  </div>
  <button class="sec-add-btn" style="color:#a09080;background:rgba(122,112,96,0.1);" onclick="openMoveModal('WATCHLIST')">→ MOVE</button>
  <button class="sec-add-btn" style="color:var(--red);background:rgba(255,80,80,0.08);" onclick="openDeleteModal('WATCHLIST')">－ DELETE</button>
  <button class="sec-add-btn" onclick="openAddModal('WATCHLIST')">
    <span class="sec-add-plus">＋</span> ADD
  </button>
</div>
<div class="main-grid" id="watch-grid" style="padding-bottom:32px;"></div>

<footer>
  <span>Dr. Bob's MCAT v5.0 · Live · CoinGecko API</span>
  <span id="footer-time">Seed data as of Feb 21, 2026 — refresh for live data</span>
</footer>

<script>
const ASSET_SEED = {"BTC": {"fullname": "Bitcoin", "tier": "REFERENCE", "hot": false, "price": 67970.294031, "ma200_pct": -31.6, "limited": false, "nrows": 4681, "signal": "ACCUMULATE", "l2": {"1d": {"val": 51.0, "trend": "down"}, "3d": {"val": 45.6, "trend": "up"}, "1w": {"val": 10.8, "trend": "down"}, "2w": {"val": 10.2, "trend": "down"}}, "l3": {"2h": {"val": 51.0, "trend": "down"}, "4h": {"val": 54.0, "trend": "down"}, "8h": {"val": 55.6, "trend": "up"}, "12h": {"val": 47.0, "trend": "up"}}, "score": 0, "l3_state": "WAIT", "alert": "\u26a0\ufe0f In the buy zone but 1W + 2W both still declining. Watching for floor to confirm."}, "ETH": {"fullname": "Ethereum", "tier": "REFERENCE", "hot": false, "price": 1967.812115, "ma200_pct": -43.9, "limited": false, "nrows": 3851, "signal": "ACCUMULATE", "l2": {"1d": {"val": 60.1, "trend": "up"}, "3d": {"val": 41.3, "trend": "up"}, "1w": {"val": 15.6, "trend": "up"}, "2w": {"val": 18.8, "trend": "down"}}, "l3": {"2h": {"val": 60.1, "trend": "up"}, "4h": {"val": 58.6, "trend": "up"}, "8h": {"val": 55.3, "trend": "up"}, "12h": {"val": 44.0, "trend": "up"}}, "score": 0, "l3_state": "WAIT", "alert": "\u2705 In the buy zone. 1W: 15.6 \u00b7 2W: 18.8 \u2014 in the buy zone. Watching for Layer 3 trigger."}, "XRP": {"fullname": "XRP / Ripple", "tier": "CORE", "hot": true, "price": 1.428702, "ma200_pct": -39.2, "limited": false, "nrows": 4580, "signal": "ACCUMULATE", "l2": {"1d": {"val": 47.7, "trend": "down"}, "3d": {"val": 31.8, "trend": "up"}, "1w": {"val": 8.0, "trend": "down"}, "2w": {"val": 9.0, "trend": "down"}}, "l3": {"2h": {"val": 47.7, "trend": "down"}, "4h": {"val": 43.2, "trend": "down"}, "8h": {"val": 43.7, "trend": "up"}, "12h": {"val": 33.4, "trend": "up"}}, "score": 0, "l3_state": "WAIT", "alert": "\u26a0\ufe0f In the buy zone but 1W + 2W both still declining. Watching for floor to confirm."}, "QNT": {"fullname": "Quant", "tier": "CORE", "hot": false, "price": 67.057574, "ma200_pct": -22.9, "limited": false, "nrows": 2794, "signal": "WATCH_ENTRY", "l2": {"1d": {"val": 37.3, "trend": "down"}, "3d": {"val": 26.6, "trend": "down"}, "1w": {"val": 28.1, "trend": "down"}, "2w": {"val": 28.9, "trend": "down"}}, "l3": {"2h": {"val": 37.3, "trend": "down"}, "4h": {"val": 37.9, "trend": "down"}, "8h": {"val": 31.5, "trend": "down"}, "12h": {"val": 26.7, "trend": "down"}}, "score": 0, "l3_state": "WAIT", "alert": "\ud83d\udc40 Approaching. 1W: 28.1, 2W: 28.9. Need both below 25 for buy zone."}, "TAO": {"fullname": "Bittensor", "tier": "CORE", "hot": false, "price": 180.959607, "ma200_pct": -40.7, "limited": false, "nrows": 1087, "signal": "WATCH_ENTRY", "l2": {"1d": {"val": 34.9, "trend": "down"}, "3d": {"val": 40.7, "trend": "up"}, "1w": {"val": 26.0, "trend": "down"}, "2w": {"val": 26.7, "trend": "up"}}, "l3": {"2h": {"val": 34.9, "trend": "down"}, "4h": {"val": 39.7, "trend": "down"}, "8h": {"val": 46.7, "trend": "up"}, "12h": {"val": 42.0, "trend": "up"}}, "score": 0, "l3_state": "WAIT", "alert": "\ud83d\udc40 Approaching. 1W: 26.0, 2W: 26.7. Need both below 25 for buy zone."}, "CC": {"fullname": "Canton Network", "tier": "CORE", "hot": false, "price": 0.158438, "ma200_pct": null, "limited": true, "nrows": 104, "signal": "MONITOR", "l2": {"1d": {"val": 37.8, "trend": "up"}, "3d": {"val": 18.3, "trend": "down"}, "1w": {"val": 0.0, "trend": "down"}, "2w": {"val": 50.0, "trend": "down"}}, "l3": {"2h": {"val": 37.8, "trend": "up"}, "4h": {"val": 37.6, "trend": "up"}, "8h": {"val": 17.9, "trend": "up"}, "12h": {"val": 18.1, "trend": "down"}}, "score": 1, "l3_state": "WAIT", "alert": "\u23f3 2W below 35 (now 50.0). Monitoring for cycle to develop."}, "XLM": {"fullname": "Stellar", "tier": "TIER1", "hot": false, "price": 0.162539, "ma200_pct": -44.0, "limited": false, "nrows": 4212, "signal": "ACCUMULATE", "l2": {"1d": {"val": 29.6, "trend": "down"}, "3d": {"val": 27.1, "trend": "up"}, "1w": {"val": 21.3, "trend": "down"}, "2w": {"val": 21.2, "trend": "down"}}, "l3": {"2h": {"val": 29.6, "trend": "down"}, "4h": {"val": 30.0, "trend": "down"}, "8h": {"val": 31.6, "trend": "down"}, "12h": {"val": 27.9, "trend": "up"}}, "score": 1, "l3_state": "AT_FLOOR", "alert": "\u23f3 In the buy zone. Waiting for 4H proxy (30) to drop below 30 and turn \u2191."}, "HBAR": {"fullname": "Hedera", "tier": "TIER1", "hot": false, "price": 0.099779, "ma200_pct": -40.1, "limited": false, "nrows": 2349, "signal": "WATCH_ENTRY", "l2": {"1d": {"val": 47.3, "trend": "down"}, "3d": {"val": 33.3, "trend": "up"}, "1w": {"val": 31.6, "trend": "up"}, "2w": {"val": 27.0, "trend": "up"}}, "l3": {"2h": {"val": 47.3, "trend": "down"}, "4h": {"val": 40.4, "trend": "down"}, "8h": {"val": 33.8, "trend": "down"}, "12h": {"val": 33.4, "trend": "up"}}, "score": 0, "l3_state": "WAIT", "alert": "\ud83d\udc40 Approaching. 1W: 31.6, 2W: 27.0. Need both below 25 for buy zone."}, "XDC": {"fullname": "XDC Network", "tier": "TIER1", "hot": false, "price": 0.035103, "ma200_pct": -40.7, "limited": false, "nrows": 2870, "signal": "ACCUMULATE", "l2": {"1d": {"val": 34.3, "trend": "down"}, "3d": {"val": 30.6, "trend": "down"}, "1w": {"val": 21.0, "trend": "down"}, "2w": {"val": 20.4, "trend": "down"}}, "l3": {"2h": {"val": 34.3, "trend": "down"}, "4h": {"val": 34.5, "trend": "down"}, "8h": {"val": 31.1, "trend": "down"}, "12h": {"val": 30.6, "trend": "down"}}, "score": 0, "l3_state": "AT_FLOOR", "alert": "\u23f3 In the buy zone. Waiting for 4H proxy (34) to drop below 30 and turn \u2191."}, "ALGO": {"fullname": "Algorand", "tier": "TIER1", "hot": false, "price": 0.090461, "ma200_pct": -47.1, "limited": false, "nrows": 2438, "signal": "WATCH_ENTRY", "l2": {"1d": {"val": 36.8, "trend": "down"}, "3d": {"val": 34.8, "trend": "up"}, "1w": {"val": 29.4, "trend": "down"}, "2w": {"val": 33.1, "trend": "down"}}, "l3": {"2h": {"val": 36.8, "trend": "down"}, "4h": {"val": 30.9, "trend": "down"}, "8h": {"val": 36.3, "trend": "down"}, "12h": {"val": 36.6, "trend": "up"}}, "score": 0, "l3_state": "WAIT", "alert": "\ud83d\udc40 Approaching. 1W: 29.4, 2W: 33.1. Need both below 25 for buy zone."}, "IOTA": {"fullname": "IOTA", "tier": "TIER1", "hot": false, "price": 0.070404, "ma200_pct": -47.3, "limited": false, "nrows": 3175, "signal": "MONITOR", "l2": {"1d": {"val": 27.8, "trend": "down"}, "3d": {"val": 27.1, "trend": "up"}, "1w": {"val": 35.6, "trend": "up"}, "2w": {"val": 29.8, "trend": "up"}}, "l3": {"2h": {"val": 27.8, "trend": "down"}, "4h": {"val": 27.2, "trend": "up"}, "8h": {"val": 26.8, "trend": "up"}, "12h": {"val": 27.3, "trend": "up"}}, "score": 3, "l3_state": "ENTRY_NOW", "alert": "\u23f3 1W below 35 (now 35.6). Monitoring for cycle to develop."}, "AERO": {"fullname": "Aerodrome", "tier": "TIER1", "hot": false, "price": 0.312844, "ma200_pct": -61.4, "limited": false, "nrows": 890, "signal": "WATCH_ENTRY", "l2": {"1d": {"val": 35.5, "trend": "down"}, "3d": {"val": 38.6, "trend": "up"}, "1w": {"val": 25.2, "trend": "up"}, "2w": {"val": 23.8, "trend": "up"}}, "l3": {"2h": {"val": 35.5, "trend": "down"}, "4h": {"val": 36.6, "trend": "up"}, "8h": {"val": 39.3, "trend": "up"}, "12h": {"val": 39.0, "trend": "up"}}, "score": 0, "l3_state": "WAIT", "alert": "\ud83d\udc40 Approaching. 1W: 25.2, 2W: 23.8. Need both below 25 for buy zone."}, "FLR": {"fullname": "Flare Network", "tier": "TIER2", "hot": false, "price": 0.009529, "ma200_pct": -41.5, "limited": false, "nrows": 1140, "signal": "WATCH_ENTRY", "l2": {"1d": {"val": 32.0, "trend": "down"}, "3d": {"val": 38.0, "trend": "up"}, "1w": {"val": 30.0, "trend": "down"}, "2w": {"val": 29.8, "trend": "down"}}, "l3": {"2h": {"val": 32.0, "trend": "down"}, "4h": {"val": 30.9, "trend": "down"}, "8h": {"val": 33.7, "trend": "down"}, "12h": {"val": 36.9, "trend": "up"}}, "score": 0, "l3_state": "WAIT", "alert": "\ud83d\udc40 Approaching. 1W: 30.0, 2W: 29.8. Need both below 25 for buy zone."}, "CRO": {"fullname": "Cronos", "tier": "WATCHLIST", "hot": false, "price": 0.077861, "ma200_pct": -44.7, "limited": false, "nrows": 2609, "signal": "WATCH_ENTRY", "l2": {"1d": {"val": 36.3, "trend": "down"}, "3d": {"val": 29.9, "trend": "up"}, "1w": {"val": 23.5, "trend": "down"}, "2w": {"val": 25.9, "trend": "down"}}, "l3": {"2h": {"val": 36.3, "trend": "down"}, "4h": {"val": 28.3, "trend": "up"}, "8h": {"val": 28.3, "trend": "up"}, "12h": {"val": 30.5, "trend": "up"}}, "score": 2, "l3_state": "NEAR", "alert": "\ud83d\udc40 Approaching. 1W: 23.5, 2W: 25.9. Need both below 25 for buy zone."}};
const TOTAL3_SEED = [{"date_str": "2025-04-28", "total3": 966671523597.0, "dpo1w": 40.71, "dpo2w": 32.79}, {"date_str": "2025-04-29", "total3": 974346559890.0, "dpo1w": 41.87, "dpo2w": 33.97}, {"date_str": "2025-04-30", "total3": 968372161675.0, "dpo1w": 41.63, "dpo2w": 33.84}, {"date_str": "2025-05-01", "total3": 962910443330.0, "dpo1w": 41.26, "dpo2w": 33.79}, {"date_str": "2025-05-02", "total3": 977136042978.0, "dpo1w": 43.02, "dpo2w": 35.65}, {"date_str": "2025-05-03", "total3": 976537441063.0, "dpo1w": 43.5, "dpo2w": 36.08}, {"date_str": "2025-05-04", "total3": 960961426588.0, "dpo1w": 42.01, "dpo2w": 35.05}, {"date_str": "2025-05-05", "total3": 948033799203.0, "dpo1w": 40.9, "dpo2w": 34.14}, {"date_str": "2025-05-06", "total3": 949683305925.0, "dpo1w": 41.35, "dpo2w": 34.64}, {"date_str": "2025-05-07", "total3": 949922123877.0, "dpo1w": 41.7, "dpo2w": 34.92}, {"date_str": "2025-05-08", "total3": 950524356519.0, "dpo1w": 42.01, "dpo2w": 35.33}, {"date_str": "2025-05-09", "total3": 1029085214858.0, "dpo1w": 50.33, "dpo2w": 43.06}, {"date_str": "2025-05-10", "total3": 1054629013491.0, "dpo1w": 53.0, "dpo2w": 45.81}, {"date_str": "2025-05-11", "total3": 1105308118086.0, "dpo1w": 58.14, "dpo2w": 50.86}, {"date_str": "2025-05-12", "total3": 1082271026591.0, "dpo1w": 55.76, "dpo2w": 48.98}, {"date_str": "2025-05-13", "total3": 1090939856519.0, "dpo1w": 56.67, "dpo2w": 50.08}, {"date_str": "2025-05-14", "total3": 1118233393452.0, "dpo1w": 59.39, "dpo2w": 52.89}, {"date_str": "2025-05-15", "total3": 1090724755668.0, "dpo1w": 56.47, "dpo2w": 50.61}, {"date_str": "2025-05-16", "total3": 1059630569780.0, "dpo1w": 53.22, "dpo2w": 47.98}, {"date_str": "2025-05-17", "total3": 1053663350940.0, "dpo1w": 52.49, "dpo2w": 47.78}, {"date_str": "2025-05-18", "total3": 1038041839028.0, "dpo1w": 50.8, "dpo2w": 46.66}, {"date_str": "2025-05-19", "total3": 1078057903002.0, "dpo1w": 54.85, "dpo2w": 50.77}, {"date_str": "2025-05-20", "total3": 1050600567017.0, "dpo1w": 52.02, "dpo2w": 48.48}, {"date_str": "2025-05-21", "total3": 1054921045954.0, "dpo1w": 52.42, "dpo2w": 49.12}, {"date_str": "2025-05-22", "total3": 1077372296824.0, "dpo1w": 54.71, "dpo2w": 51.51}, {"date_str": "2025-05-23", "total3": 1110419414891.0, "dpo1w": 58.06, "dpo2w": 54.91}, {"date_str": "2025-05-24", "total3": 1061578785711.0, "dpo1w": 52.98, "dpo2w": 50.47}, {"date_str": "2025-05-25", "total3": 1065019386480.0, "dpo1w": 53.4, "dpo2w": 50.97}, {"date_str": "2025-05-26", "total3": 1073567585311.0, "dpo1w": 54.39, "dpo2w": 51.94}, {"date_str": "2025-05-27", "total3": 1068575547892.0, "dpo1w": 53.93, "dpo2w": 51.48}, {"date_str": "2025-05-28", "total3": 1075288791148.0, "dpo1w": 54.7, "dpo2w": 52.12}, {"date_str": "2025-05-29", "total3": 1066292827467.0, "dpo1w": 53.74, "dpo2w": 51.27}, {"date_str": "2025-05-30", "total3": 1047568323640.0, "dpo1w": 51.51, "dpo2w": 49.48}, {"date_str": "2025-05-31", "total3": 1002931932088.0, "dpo1w": 46.52, "dpo2w": 45.24}, {"date_str": "2025-06-01", "total3": 1007879825277.0, "dpo1w": 46.53, "dpo2w": 45.71}, {"date_str": "2025-06-02", "total3": 1014273991407.0, "dpo1w": 46.77, "dpo2w": 46.5}, {"date_str": "2025-06-03", "total3": 1022351910054.0, "dpo1w": 47.08, "dpo2w": 47.23}, {"date_str": "2025-06-04", "total3": 1024066675182.0, "dpo1w": 46.66, "dpo2w": 47.42}, {"date_str": "2025-06-05", "total3": 1010945057786.0, "dpo1w": 44.81, "dpo2w": 46.26}, {"date_str": "2025-06-06", "total3": 974094468063.0, "dpo1w": 40.58, "dpo2w": 42.86}, {"date_str": "2025-06-07", "total3": 993338388043.0, "dpo1w": 41.97, "dpo2w": 44.72}, {"date_str": "2025-06-08", "total3": 1008126718922.0, "dpo1w": 42.94, "dpo2w": 46.13}, {"date_str": "2025-06-09", "total3": 1017632111306.0, "dpo1w": 43.24, "dpo2w": 46.82}, {"date_str": "2025-06-10", "total3": 1049342012145.0, "dpo1w": 46.08, "dpo2w": 49.51}, {"date_str": "2025-06-11", "total3": 1069236101874.0, "dpo1w": 47.62, "dpo2w": 51.07}, {"date_str": "2025-06-12", "total3": 1049136714749.0, "dpo1w": 45.04, "dpo2w": 48.89}, {"date_str": "2025-06-13", "total3": 1014310499645.0, "dpo1w": 40.92, "dpo2w": 45.31}, {"date_str": "2025-06-14", "total3": 1006355629610.0, "dpo1w": 39.66, "dpo2w": 44.27}, {"date_str": "2025-06-15", "total3": 992658105434.0, "dpo1w": 37.79, "dpo2w": 42.76}, {"date_str": "2025-06-16", "total3": 1002879371595.0, "dpo1w": 38.34, "dpo2w": 43.51}, {"date_str": "2025-06-17", "total3": 1004890646448.0, "dpo1w": 38.05, "dpo2w": 43.52}, {"date_str": "2025-06-18", "total3": 986402468809.0, "dpo1w": 35.65, "dpo2w": 41.61}, {"date_str": "2025-06-19", "total3": 991768147571.0, "dpo1w": 35.74, "dpo2w": 41.96}, {"date_str": "2025-06-20", "total3": 987062957183.0, "dpo1w": 34.87, "dpo2w": 41.36}, {"date_str": "2025-06-21", "total3": 965758956057.0, "dpo1w": 32.4, "dpo2w": 39.18}, {"date_str": "2025-06-22", "total3": 957612503503.0, "dpo1w": 31.29, "dpo2w": 38.21}, {"date_str": "2025-06-23", "total3": 930445020029.0, "dpo1w": 28.3, "dpo2w": 35.42}, {"date_str": "2025-06-24", "total3": 982065444188.0, "dpo1w": 33.48, "dpo2w": 40.18}, {"date_str": "2025-06-25", "total3": 988989443536.0, "dpo1w": 34.04, "dpo2w": 40.71}, {"date_str": "2025-06-26", "total3": 984017093560.0, "dpo1w": 33.4, "dpo2w": 40.08}, {"date_str": "2025-06-27", "total3": 964726969748.0, "dpo1w": 31.41, "dpo2w": 38.12}, {"date_str": "2025-06-28", "total3": 974816781457.0, "dpo1w": 32.39, "dpo2w": 38.86}, {"date_str": "2025-06-29", "total3": 988245595361.0, "dpo1w": 33.69, "dpo2w": 39.88}, {"date_str": "2025-06-30", "total3": 1003838185726.0, "dpo1w": 35.17, "dpo2w": 41.14}, {"date_str": "2025-07-01", "total3": 999132257409.0, "dpo1w": 34.46, "dpo2w": 40.55}, {"date_str": "2025-07-02", "total3": 976498582037.0, "dpo1w": 31.88, "dpo2w": 38.28}, {"date_str": "2025-07-03", "total3": 1005352452793.0, "dpo1w": 34.68, "dpo2w": 40.8}, {"date_str": "2025-07-04", "total3": 971511996689.0, "dpo1w": 31.04, "dpo2w": 37.39}, {"date_str": "2025-07-05", "total3": 950862805414.0, "dpo1w": 28.76, "dpo2w": 35.25}, {"date_str": "2025-07-06", "total3": 952756435638.0, "dpo1w": 28.84, "dpo2w": 35.25}, {"date_str": "2025-07-07", "total3": 967160153399.0, "dpo1w": 30.19, "dpo2w": 36.37}, {"date_str": "2025-07-08", "total3": 958842433948.0, "dpo1w": 29.19, "dpo2w": 35.32}, {"date_str": "2025-07-09", "total3": 957531572042.0, "dpo1w": 29.17, "dpo2w": 34.89}, {"date_str": "2025-07-10", "total3": 981741714401.0, "dpo1w": 31.83, "dpo2w": 36.95}, {"date_str": "2025-07-11", "total3": 1027857342626.0, "dpo1w": 36.91, "dpo2w": 41.01}, {"date_str": "2025-07-12", "total3": 1044680116272.0, "dpo1w": 38.95, "dpo2w": 42.3}, {"date_str": "2025-07-13", "total3": 1040867030225.0, "dpo1w": 38.9, "dpo2w": 41.72}, {"date_str": "2025-07-14", "total3": 1060822883407.0, "dpo1w": 41.45, "dpo2w": 43.41}, {"date_str": "2025-07-15", "total3": 1071180161113.0, "dpo1w": 42.8, "dpo2w": 44.21}, {"date_str": "2025-07-16", "total3": 1080109126686.0, "dpo1w": 43.91, "dpo2w": 44.87}, {"date_str": "2025-07-17", "total3": 1103573843223.0, "dpo1w": 46.51, "dpo2w": 46.89}, {"date_str": "2025-07-18", "total3": 1144616254558.0, "dpo1w": 50.95, "dpo2w": 50.57}, {"date_str": "2025-07-19", "total3": 1146852155678.0, "dpo1w": 51.45, "dpo2w": 50.63}, {"date_str": "2025-07-20", "total3": 1157450449493.0, "dpo1w": 52.7, "dpo2w": 51.49}, {"date_str": "2025-07-21", "total3": 1182503771954.0, "dpo1w": 55.43, "dpo2w": 53.71}, {"date_str": "2025-07-22", "total3": 1200822113273.0, "dpo1w": 57.52, "dpo2w": 55.34}, {"date_str": "2025-07-23", "total3": 1210551833458.0, "dpo1w": 58.88, "dpo2w": 56.25}, {"date_str": "2025-07-24", "total3": 1146566241566.0, "dpo1w": 52.4, "dpo2w": 50.25}, {"date_str": "2025-07-25", "total3": 1131332908231.0, "dpo1w": 51.07, "dpo2w": 48.78}, {"date_str": "2025-07-26", "total3": 1149256469806.0, "dpo1w": 53.24, "dpo2w": 50.44}, {"date_str": "2025-07-27", "total3": 1154384955221.0, "dpo1w": 54.07, "dpo2w": 50.91}, {"date_str": "2025-07-28", "total3": 1181107399804.0, "dpo1w": 57.11, "dpo2w": 53.43}, {"date_str": "2025-07-29", "total3": 1139568780086.0, "dpo1w": 53.1, "dpo2w": 49.51}, {"date_str": "2025-07-30", "total3": 1139441649379.0, "dpo1w": 53.32, "dpo2w": 49.47}, {"date_str": "2025-07-31", "total3": 1128086499246.0, "dpo1w": 52.2, "dpo2w": 48.33}, {"date_str": "2025-08-01", "total3": 1105190116559.0, "dpo1w": 49.78, "dpo2w": 46.13}, {"date_str": "2025-08-02", "total3": 1080000705292.0, "dpo1w": 47.09, "dpo2w": 43.75}, {"date_str": "2025-08-03", "total3": 1049013631137.0, "dpo1w": 43.84, "dpo2w": 40.76}, {"date_str": "2025-08-04", "total3": 1081569884474.0, "dpo1w": 47.11, "dpo2w": 43.8}, {"date_str": "2025-08-05", "total3": 1108067869211.0, "dpo1w": 49.7, "dpo2w": 46.3}, {"date_str": "2025-08-06", "total3": 1086659694333.0, "dpo1w": 47.21, "dpo2w": 44.27}, {"date_str": "2025-08-07", "total3": 1100646752487.0, "dpo1w": 48.37, "dpo2w": 45.56}, {"date_str": "2025-08-08", "total3": 1151016864114.0, "dpo1w": 53.23, "dpo2w": 50.43}, {"date_str": "2025-08-09", "total3": 1159258459200.0, "dpo1w": 53.74, "dpo2w": 51.36}, {"date_str": "2025-08-10", "total3": 1174363705329.0, "dpo1w": 55.03, "dpo2w": 52.98}, {"date_str": "2025-08-11", "total3": 1174026521353.0, "dpo1w": 54.7, "dpo2w": 53.04}, {"date_str": "2025-08-12", "total3": 1148534846653.0, "dpo1w": 51.67, "dpo2w": 50.7}, {"date_str": "2025-08-13", "total3": 1193244236311.0, "dpo1w": 55.79, "dpo2w": 55.05}, {"date_str": "2025-08-14", "total3": 1222940673072.0, "dpo1w": 58.5, "dpo2w": 57.9}, {"date_str": "2025-08-15", "total3": 1172756412566.0, "dpo1w": 52.95, "dpo2w": 53.14}, {"date_str": "2025-08-16", "total3": 1173300710199.0, "dpo1w": 52.63, "dpo2w": 53.15}, {"date_str": "2025-08-17", "total3": 1181159226016.0, "dpo1w": 53.05, "dpo2w": 53.79}, {"date_str": "2025-08-18", "total3": 1190286694873.0, "dpo1w": 53.49, "dpo2w": 54.55}, {"date_str": "2025-08-19", "total3": 1168876325483.0, "dpo1w": 50.9, "dpo2w": 52.37}, {"date_str": "2025-08-20", "total3": 1128515641289.0, "dpo1w": 46.33, "dpo2w": 48.4}, {"date_str": "2025-08-21", "total3": 1166996077580.0, "dpo1w": 49.89, "dpo2w": 51.87}, {"date_str": "2025-08-22", "total3": 1141073759399.0, "dpo1w": 46.83, "dpo2w": 49.28}, {"date_str": "2025-08-23", "total3": 1214888156126.0, "dpo1w": 54.07, "dpo2w": 56.02}, {"date_str": "2025-08-24", "total3": 1207029206818.0, "dpo1w": 53.09, "dpo2w": 55.15}, {"date_str": "2025-08-25", "total3": 1197967963517.0, "dpo1w": 51.91, "dpo2w": 54.2}, {"date_str": "2025-08-26", "total3": 1133913804823.0, "dpo1w": 44.97, "dpo2w": 48.02}, {"date_str": "2025-08-27", "total3": 1172142563532.0, "dpo1w": 48.6, "dpo2w": 51.51}, {"date_str": "2025-08-28", "total3": 1167358069026.0, "dpo1w": 47.78, "dpo2w": 50.88}, {"date_str": "2025-08-29", "total3": 1194792707451.0, "dpo1w": 50.2, "dpo2w": 53.32}, {"date_str": "2025-08-30", "total3": 1154696174886.0, "dpo1w": 45.65, "dpo2w": 49.32}, {"date_str": "2025-08-31", "total3": 1162063572411.0, "dpo1w": 45.96, "dpo2w": 49.83}, {"date_str": "2025-09-01", "total3": 1152081605376.0, "dpo1w": 44.42, "dpo2w": 48.74}, {"date_str": "2025-09-02", "total3": 1147508741144.0, "dpo1w": 43.57, "dpo2w": 48.22}, {"date_str": "2025-09-03", "total3": 1186782435207.0, "dpo1w": 47.06, "dpo2w": 51.89}, {"date_str": "2025-09-04", "total3": 1190196909621.0, "dpo1w": 46.71, "dpo2w": 52.1}, {"date_str": "2025-09-05", "total3": 1168017740299.0, "dpo1w": 43.85, "dpo2w": 49.79}, {"date_str": "2025-09-06", "total3": 1178667754846.0, "dpo1w": 44.42, "dpo2w": 50.65}, {"date_str": "2025-09-07", "total3": 1175846742002.0, "dpo1w": 43.55, "dpo2w": 50.24}, {"date_str": "2025-09-08", "total3": 1198271756737.0, "dpo1w": 45.27, "dpo2w": 52.15}, {"date_str": "2025-09-09", "total3": 1220520389041.0, "dpo1w": 47.09, "dpo2w": 54.08}, {"date_str": "2025-09-10", "total3": 1221267100088.0, "dpo1w": 46.9, "dpo2w": 53.98}, {"date_str": "2025-09-11", "total3": 1243290161714.0, "dpo1w": 48.86, "dpo2w": 55.86}, {"date_str": "2025-09-12", "total3": 1261551157757.0, "dpo1w": 50.49, "dpo2w": 57.38}, {"date_str": "2025-09-13", "total3": 1287571250684.0, "dpo1w": 52.79, "dpo2w": 59.54}, {"date_str": "2025-09-14", "total3": 1298724802295.0, "dpo1w": 53.59, "dpo2w": 60.23}, {"date_str": "2025-09-15", "total3": 1277751488820.0, "dpo1w": 51.11, "dpo2w": 57.98}, {"date_str": "2025-09-16", "total3": 1261164819433.0, "dpo1w": 49.32, "dpo2w": 56.15}, {"date_str": "2025-09-17", "total3": 1277530662226.0, "dpo1w": 50.94, "dpo2w": 57.39}, {"date_str": "2025-09-18", "total3": 1300337760846.0, "dpo1w": 53.25, "dpo2w": 59.23}, {"date_str": "2025-09-19", "total3": 1311183908719.0, "dpo1w": 54.27, "dpo2w": 59.97}, {"date_str": "2025-09-20", "total3": 1282117659069.0, "dpo1w": 51.34, "dpo2w": 56.97}, {"date_str": "2025-09-21", "total3": 1293016894309.0, "dpo1w": 52.57, "dpo2w": 57.67}, {"date_str": "2025-09-22", "total3": 1283978712923.0, "dpo1w": 51.78, "dpo2w": 56.48}, {"date_str": "2025-09-23", "total3": 1234740736655.0, "dpo1w": 46.69, "dpo2w": 51.47}, {"date_str": "2025-09-24", "total3": 1227721336823.0, "dpo1w": 45.82, "dpo2w": 50.46}, {"date_str": "2025-09-25", "total3": 1237582700755.0, "dpo1w": 46.73, "dpo2w": 51.06}, {"date_str": "2025-09-26", "total3": 1178197514851.0, "dpo1w": 40.56, "dpo2w": 45.18}, {"date_str": "2025-09-27", "total3": 1206952276379.0, "dpo1w": 43.54, "dpo2w": 47.59}, {"date_str": "2025-09-28", "total3": 1205592644136.0, "dpo1w": 43.3, "dpo2w": 47.18}, {"date_str": "2025-09-29", "total3": 1227284396573.0, "dpo1w": 45.39, "dpo2w": 48.93}, {"date_str": "2025-09-30", "total3": 1235903372936.0, "dpo1w": 46.05, "dpo2w": 49.49}, {"date_str": "2025-10-01", "total3": 1221279426262.0, "dpo1w": 44.23, "dpo2w": 47.82}, {"date_str": "2025-10-02", "total3": 1266423286952.0, "dpo1w": 48.48, "dpo2w": 51.85}, {"date_str": "2025-10-03", "total3": 1305357481466.0, "dpo1w": 51.96, "dpo2w": 55.25}, {"date_str": "2025-10-04", "total3": 1316106608827.0, "dpo1w": 52.54, "dpo2w": 55.9}, {"date_str": "2025-10-05", "total3": 1295994951076.0, "dpo1w": 49.96, "dpo2w": 53.62}, {"date_str": "2025-10-06", "total3": 1298114959023.0, "dpo1w": 49.69, "dpo2w": 53.51}, {"date_str": "2025-10-07", "total3": 1326769740257.0, "dpo1w": 52.24, "dpo2w": 55.87}, {"date_str": "2025-10-08", "total3": 1297274835575.0, "dpo1w": 48.86, "dpo2w": 52.74}, {"date_str": "2025-10-09", "total3": 1316569857572.0, "dpo1w": 50.49, "dpo2w": 54.22}, {"date_str": "2025-10-10", "total3": 1290220873383.0, "dpo1w": 47.41, "dpo2w": 51.43}, {"date_str": "2025-10-11", "total3": 1121785310642.0, "dpo1w": 29.71, "dpo2w": 35.24}, {"date_str": "2025-10-12", "total3": 1123047754799.0, "dpo1w": 29.47, "dpo2w": 35.05}, {"date_str": "2025-10-13", "total3": 1207371442422.0, "dpo1w": 37.96, "dpo2w": 42.69}, {"date_str": "2025-10-14", "total3": 1231730737695.0, "dpo1w": 40.44, "dpo2w": 44.65}, {"date_str": "2025-10-15", "total3": 1192957388533.0, "dpo1w": 36.29, "dpo2w": 40.65}, {"date_str": "2025-10-16", "total3": 1165209968046.0, "dpo1w": 33.26, "dpo2w": 37.75}, {"date_str": "2025-10-17", "total3": 1140136434325.0, "dpo1w": 30.67, "dpo2w": 35.2}, {"date_str": "2025-10-18", "total3": 1111591862383.0, "dpo1w": 27.68, "dpo2w": 32.3}, {"date_str": "2025-10-19", "total3": 1131602452899.0, "dpo1w": 29.65, "dpo2w": 33.96}, {"date_str": "2025-10-20", "total3": 1142643155324.0, "dpo1w": 30.54, "dpo2w": 34.8}, {"date_str": "2025-10-21", "total3": 1150803679106.0, "dpo1w": 31.2, "dpo2w": 35.45}, {"date_str": "2025-10-22", "total3": 1126326705213.0, "dpo1w": 28.46, "dpo2w": 33.01}, {"date_str": "2025-10-23", "total3": 1116358062267.0, "dpo1w": 27.3, "dpo2w": 31.85}, {"date_str": "2025-10-24", "total3": 1131130175987.0, "dpo1w": 28.57, "dpo2w": 33.08}, {"date_str": "2025-10-25", "total3": 1139301146944.0, "dpo1w": 29.11, "dpo2w": 33.73}, {"date_str": "2025-10-26", "total3": 1152488173387.0, "dpo1w": 30.06, "dpo2w": 34.84}, {"date_str": "2025-10-27", "total3": 1176201837390.0, "dpo1w": 32.18, "dpo2w": 37.09}, {"date_str": "2025-10-28", "total3": 1166691491904.0, "dpo1w": 30.79, "dpo2w": 36.08}, {"date_str": "2025-10-29", "total3": 1148829923057.0, "dpo1w": 28.68, "dpo2w": 34.29}, {"date_str": "2025-10-30", "total3": 1148211095282.0, "dpo1w": 28.19, "dpo2w": 34.08}, {"date_str": "2025-10-31", "total3": 1103515409242.0, "dpo1w": 23.24, "dpo2w": 29.65}, {"date_str": "2025-11-01", "total3": 1126176852684.0, "dpo1w": 25.66, "dpo2w": 31.57}, {"date_str": "2025-11-02", "total3": 1135506828995.0, "dpo1w": 26.69, "dpo2w": 32.11}, {"date_str": "2025-11-03", "total3": 1140599037109.0, "dpo1w": 27.16, "dpo2w": 32.24}, {"date_str": "2025-11-04", "total3": 1061753414743.0, "dpo1w": 18.9, "dpo2w": 24.46}, {"date_str": "2025-11-05", "total3": 1029460784357.0, "dpo1w": 15.5, "dpo2w": 21.08}, {"date_str": "2025-11-06", "total3": 1063876375027.0, "dpo1w": 19.09, "dpo2w": 24.02}, {"date_str": "2025-11-07", "total3": 1043387819669.0, "dpo1w": 17.06, "dpo2w": 21.81}, {"date_str": "2025-11-08", "total3": 1092412149338.0, "dpo1w": 22.36, "dpo2w": 26.22}, {"date_str": "2025-11-09", "total3": 1082983737541.0, "dpo1w": 21.61, "dpo2w": 25.11}, {"date_str": "2025-11-10", "total3": 1102489268580.0, "dpo1w": 23.83, "dpo2w": 26.77}, {"date_str": "2025-11-11", "total3": 1122299199673.0, "dpo1w": 26.12, "dpo2w": 28.68}, {"date_str": "2025-11-12", "total3": 1082867585439.0, "dpo1w": 22.39, "dpo2w": 25.07}, {"date_str": "2025-11-13", "total3": 1080370536910.0, "dpo1w": 22.58, "dpo2w": 24.86}, {"date_str": "2025-11-14", "total3": 1047219467830.0, "dpo1w": 19.58, "dpo2w": 21.63}, {"date_str": "2025-11-15", "total3": 1021820227020.0, "dpo1w": 17.31, "dpo2w": 19.2}, {"date_str": "2025-11-16", "total3": 1043868437331.0, "dpo1w": 19.88, "dpo2w": 21.31}, {"date_str": "2025-11-17", "total3": 1024580629231.0, "dpo1w": 18.14, "dpo2w": 19.57}, {"date_str": "2025-11-18", "total3": 1011671295180.0, "dpo1w": 17.15, "dpo2w": 18.44}, {"date_str": "2025-11-19", "total3": 1040480806282.0, "dpo1w": 20.55, "dpo2w": 21.16}, {"date_str": "2025-11-20", "total3": 1017220690591.0, "dpo1w": 18.49, "dpo2w": 19.0}, {"date_str": "2025-11-21", "total3": 979090273543.0, "dpo1w": 15.04, "dpo2w": 15.38}, {"date_str": "2025-11-22", "total3": 957979637286.0, "dpo1w": 13.26, "dpo2w": 13.53}, {"date_str": "2025-11-23", "total3": 953667421857.0, "dpo1w": 13.08, "dpo2w": 13.26}, {"date_str": "2025-11-24", "total3": 968963393208.0, "dpo1w": 14.88, "dpo2w": 14.81}, {"date_str": "2025-11-25", "total3": 996966314729.0, "dpo1w": 18.23, "dpo2w": 17.45}, {"date_str": "2025-11-26", "total3": 998604777866.0, "dpo1w": 18.79, "dpo2w": 17.63}, {"date_str": "2025-11-27", "total3": 1013811638632.0, "dpo1w": 20.73, "dpo2w": 19.06}, {"date_str": "2025-11-28", "total3": 1011009782519.0, "dpo1w": 20.86, "dpo2w": 18.84}, {"date_str": "2025-11-29", "total3": 1002213453937.0, "dpo1w": 20.3, "dpo2w": 18.01}, {"date_str": "2025-11-30", "total3": 997717972406.0, "dpo1w": 20.23, "dpo2w": 17.61}, {"date_str": "2025-12-01", "total3": 987727292073.0, "dpo1w": 19.5, "dpo2w": 16.75}, {"date_str": "2025-12-02", "total3": 954556955579.0, "dpo1w": 16.44, "dpo2w": 13.65}, {"date_str": "2025-12-03", "total3": 992847151870.0, "dpo1w": 20.98, "dpo2w": 17.34}, {"date_str": "2025-12-04", "total3": 1015987174493.0, "dpo1w": 23.98, "dpo2w": 19.61}, {"date_str": "2025-12-05", "total3": 997368092804.0, "dpo1w": 22.7, "dpo2w": 18.02}, {"date_str": "2025-12-06", "total3": 980289604351.0, "dpo1w": 21.65, "dpo2w": 16.64}, {"date_str": "2025-12-07", "total3": 981581316762.0, "dpo1w": 22.51, "dpo2w": 16.94}, {"date_str": "2025-12-08", "total3": 984599401825.0, "dpo1w": 23.53, "dpo2w": 17.46}, {"date_str": "2025-12-09", "total3": 991044207127.0, "dpo1w": 24.99, "dpo2w": 18.27}, {"date_str": "2025-12-10", "total3": 1002402068129.0, "dpo1w": 26.81, "dpo2w": 19.56}, {"date_str": "2025-12-11", "total3": 998314884232.0, "dpo1w": 26.65, "dpo2w": 19.4}, {"date_str": "2025-12-12", "total3": 992169471726.0, "dpo1w": 26.39, "dpo2w": 19.04}, {"date_str": "2025-12-13", "total3": 980787076544.0, "dpo1w": 25.86, "dpo2w": 18.29}, {"date_str": "2025-12-14", "total3": 992479508347.0, "dpo1w": 27.79, "dpo2w": 19.73}, {"date_str": "2025-12-15", "total3": 972566877618.0, "dpo1w": 26.31, "dpo2w": 18.22}, {"date_str": "2025-12-16", "total3": 958478357679.0, "dpo1w": 25.28, "dpo2w": 17.26}, {"date_str": "2025-12-17", "total3": 963915689532.0, "dpo1w": 26.21, "dpo2w": 18.14}, {"date_str": "2025-12-18", "total3": 938657148198.0, "dpo1w": 23.85, "dpo2w": 16.19}, {"date_str": "2025-12-19", "total3": 923184128348.0, "dpo1w": 22.56, "dpo2w": 15.2}, {"date_str": "2025-12-20", "total3": 951343857640.0, "dpo1w": 25.84, "dpo2w": 18.24}, {"date_str": "2025-12-21", "total3": 957751190670.0, "dpo1w": 26.9, "dpo2w": 19.28}, {"date_str": "2025-12-22", "total3": 955394735640.0, "dpo1w": 27.01, "dpo2w": 19.54}, {"date_str": "2025-12-23", "total3": 952796625413.0, "dpo1w": 27.16, "dpo2w": 19.73}, {"date_str": "2025-12-24", "total3": 941534928686.0, "dpo1w": 26.35, "dpo2w": 19.1}, {"date_str": "2025-12-25", "total3": 939591899422.0, "dpo1w": 26.47, "dpo2w": 19.34}, {"date_str": "2025-12-26", "total3": 928575058806.0, "dpo1w": 25.73, "dpo2w": 18.58}, {"date_str": "2025-12-27", "total3": 934968962300.0, "dpo1w": 26.9, "dpo2w": 19.51}, {"date_str": "2025-12-28", "total3": 950573280124.0, "dpo1w": 28.99, "dpo2w": 21.29}, {"date_str": "2025-12-29", "total3": 952596602604.0, "dpo1w": 29.63, "dpo2w": 21.82}, {"date_str": "2025-12-30", "total3": 943612532668.0, "dpo1w": 29.11, "dpo2w": 21.34}, {"date_str": "2025-12-31", "total3": 949922988070.0, "dpo1w": 30.02, "dpo2w": 22.29}, {"date_str": "2026-01-01", "total3": 941725005941.0, "dpo1w": 29.5, "dpo2w": 21.95}, {"date_str": "2026-01-02", "total3": 956745712867.0, "dpo1w": 31.43, "dpo2w": 23.92}, {"date_str": "2026-01-03", "total3": 982847201883.0, "dpo1w": 34.54, "dpo2w": 26.9}, {"date_str": "2026-01-04", "total3": 990468437531.0, "dpo1w": 35.51, "dpo2w": 28.06}, {"date_str": "2026-01-05", "total3": 1005136002272.0, "dpo1w": 37.17, "dpo2w": 29.91}, {"date_str": "2026-01-06", "total3": 1030822847510.0, "dpo1w": 40.1, "dpo2w": 32.89}, {"date_str": "2026-01-07", "total3": 1038178204804.0, "dpo1w": 41.07, "dpo2w": 34.08}, {"date_str": "2026-01-08", "total3": 1011410268184.0, "dpo1w": 38.69, "dpo2w": 32.07}, {"date_str": "2026-01-09", "total3": 1003479635151.0, "dpo1w": 38.29, "dpo2w": 31.79}, {"date_str": "2026-01-10", "total3": 997032188499.0, "dpo1w": 38.01, "dpo2w": 31.37}, {"date_str": "2026-01-11", "total3": 993909192213.0, "dpo1w": 38.11, "dpo2w": 31.27}, {"date_str": "2026-01-12", "total3": 999755825045.0, "dpo1w": 39.05, "dpo2w": 32.17}, {"date_str": "2026-01-13", "total3": 997785865466.0, "dpo1w": 39.17, "dpo2w": 32.37}, {"date_str": "2026-01-14", "total3": 1034682244362.0, "dpo1w": 43.26, "dpo2w": 36.17}, {"date_str": "2026-01-15", "total3": 1030853081238.0, "dpo1w": 43.08, "dpo2w": 36.12}, {"date_str": "2026-01-16", "total3": 1012583049231.0, "dpo1w": 41.49, "dpo2w": 34.68}, {"date_str": "2026-01-17", "total3": 1016263898961.0, "dpo1w": 42.1, "dpo2w": 35.26}, {"date_str": "2026-01-18", "total3": 1014780233854.0, "dpo1w": 42.11, "dpo2w": 35.42}, {"date_str": "2026-01-19", "total3": 991762387563.0, "dpo1w": 39.95, "dpo2w": 33.59}, {"date_str": "2026-01-20", "total3": 984967742491.0, "dpo1w": 39.44, "dpo2w": 33.26}, {"date_str": "2026-01-21", "total3": 952325662031.0, "dpo1w": 36.14, "dpo2w": 30.45}, {"date_str": "2026-01-22", "total3": 965120912625.0, "dpo1w": 37.5, "dpo2w": 31.91}, {"date_str": "2026-01-23", "total3": 964226601499.0, "dpo1w": 37.4, "dpo2w": 32.1}, {"date_str": "2026-01-24", "total3": 965930274856.0, "dpo1w": 37.54, "dpo2w": 32.58}, {"date_str": "2026-01-25", "total3": 961613983106.0, "dpo1w": 37.12, "dpo2w": 32.5}, {"date_str": "2026-01-26", "total3": 933993778406.0, "dpo1w": 34.24, "dpo2w": 30.29}, {"date_str": "2026-01-27", "total3": 954430303928.0, "dpo1w": 36.31, "dpo2w": 32.58}, {"date_str": "2026-01-28", "total3": 963570719256.0, "dpo1w": 37.19, "dpo2w": 33.76}, {"date_str": "2026-01-29", "total3": 963850372402.0, "dpo1w": 37.19, "dpo2w": 34.09}, {"date_str": "2026-01-30", "total3": 930547483639.0, "dpo1w": 33.73, "dpo2w": 31.2}, {"date_str": "2026-01-31", "total3": 918611591740.0, "dpo1w": 32.47, "dpo2w": 30.35}, {"date_str": "2026-02-01", "total3": 873783450883.0, "dpo1w": 27.74, "dpo2w": 26.42}, {"date_str": "2026-02-02", "total3": 860713545095.0, "dpo1w": 26.37, "dpo2w": 25.47}, {"date_str": "2026-02-03", "total3": 873487755590.0, "dpo1w": 27.73, "dpo2w": 26.8}, {"date_str": "2026-02-04", "total3": 859539765451.0, "dpo1w": 26.2, "dpo2w": 25.55}, {"date_str": "2026-02-05", "total3": 831846869912.0, "dpo1w": 23.2, "dpo2w": 23.03}, {"date_str": "2026-02-06", "total3": 749663524468.0, "dpo1w": 14.62, "dpo2w": 15.28}, {"date_str": "2026-02-07", "total3": 815211448453.0, "dpo1w": 21.32, "dpo2w": 21.56}, {"date_str": "2026-02-08", "total3": 809874930084.0, "dpo1w": 20.71, "dpo2w": 21.17}, {"date_str": "2026-02-09", "total3": 799102765955.0, "dpo1w": 19.62, "dpo2w": 20.31}, {"date_str": "2026-02-10", "total3": 807742814554.0, "dpo1w": 20.55, "dpo2w": 21.32}, {"date_str": "2026-02-11", "total3": 796897745348.0, "dpo1w": 19.53, "dpo2w": 20.44}, {"date_str": "2026-02-12", "total3": 788326372934.0, "dpo1w": 18.68, "dpo2w": 19.75}, {"date_str": "2026-02-13", "total3": 790150103169.0, "dpo1w": 18.94, "dpo2w": 20.0}, {"date_str": "2026-02-14", "total3": 805967505068.0, "dpo1w": 20.6, "dpo2w": 21.48}, {"date_str": "2026-02-15", "total3": 826964857550.0, "dpo1w": 22.76, "dpo2w": 23.48}, {"date_str": "2026-02-16", "total3": 813739406213.0, "dpo1w": 21.47, "dpo2w": 22.25}, {"date_str": "2026-02-17", "total3": 816510002947.0, "dpo1w": 21.72, "dpo2w": 22.5}, {"date_str": "2026-02-18", "total3": 813724555031.0, "dpo1w": 21.32, "dpo2w": 22.28}, {"date_str": "2026-02-19", "total3": 801065902084.0, "dpo1w": 19.98, "dpo2w": 21.13}, {"date_str": "2026-02-20", "total3": 800759944500.0, "dpo1w": 20.02, "dpo2w": 21.09}, {"date_str": "2026-02-21", "total3": 811722971449.0, "dpo1w": 21.25, "dpo2w": 22.13}];
// ── COINGECKO API CONFIG ──
const CG_API_KEY  = 'CG-dJVxAwDLgzBr93UYBNLwqTJZ';
// Once Cloudflare Worker is deployed, paste its URL below.
// Example: 'https://mcat-coingecko-proxy.yourusername.workers.dev'
// Leave as empty string to use direct CoinGecko (price-only mode)
const PROXY_URL = 'https://mcat-coingecko-proxy.red-darkness-98d8.workers.dev';

function cgHeaders(){ return {}; }
function cgUrl(path){
  if(PROXY_URL){
    // Route through proxy — full historical data, no CORS issues
    const base = path.split('?')[0];
    const qs   = path.includes('?') ? path.split('?')[1] : '';
    return PROXY_URL + '?path=' + base + (qs ? '&' + qs : '');
  }
  // Fallback: direct call with key as query param (price-only works, history may 401)
  const sep = path.includes('?') ? '&' : '?';
  return 'https://api.coingecko.com/api/v3' + path + sep + 'x_cg_demo_api_key=' + CG_API_KEY;
}

const CG_IDS = {"BTC": "bitcoin", "ETH": "ethereum", "XRP": "ripple", "QNT": "quant-network", "TAO": "bittensor", "CC": "canton-network", "XLM": "stellar", "HBAR": "hedera-hashgraph", "XDC": "xdce-crowd-sale", "ALGO": "algorand", "IOTA": "iota", "AERO": "aerodrome-finance", "FLR": "flare-networks", "ZORA": "zora", "CRO": "crypto-com-chain"};

const TIER_ORDER = ['REFERENCE','CORE','TIER1','TIER2','WATCHLIST'];
const TIER_GRID = {REFERENCE:'ref-grid', CORE:'core-grid', TIER1:'t1-grid', TIER2:'t2-grid', WATCHLIST:'watch-grid'};

let liveData = {};
let hotAssets = [];
let hiddenAssets = [];
let currentGate = {v1w:50,v2w:50,t1w:'down',t2w:'down',isOpen:false,isWarn:false};

// Init liveData from seed
function initFromSeed(){
  for(const[t,d] of Object.entries(ASSET_SEED)){
    liveData[t] = JSON.parse(JSON.stringify(d));
    if(d.hot && !hotAssets.includes(t)) hotAssets.push(t);
  }
}

// ── UTILITIES ──
function fmt(p){
  if(!p&&p!==0)return'--';
  if(p>=10000)return'$'+Math.round(p).toLocaleString();
  if(p>=1000) return'$'+p.toFixed(1);
  if(p>=1)    return'$'+p.toFixed(3);
  if(p>=0.01) return'$'+p.toFixed(4);
  return'$'+p.toFixed(5);
}
function fc(v){return v<20?'fill-low':v<80?'fill-mid':'fill-high';}
function cc(v){return v<20?'col-low':v<80?'col-mid':'col-high';}
function subLabel(v){
  if(v<20)return['rsub-floor','AT FLOOR'];
  if(v<40)return['rsub-low','LOW RANGE'];
  if(v<60)return['rsub-mid','MID RANGE'];
  if(v<80)return['rsub-high','HIGH'];
  return['rsub-peak','NEAR PEAK'];
}

// ── DPO ──
function calcDPO(closes,period){
  const shift=Math.floor(period/2)+1;
  const r=new Array(closes.length).fill(null);
  for(let i=period+shift-1;i<closes.length;i++){
    let s=0;for(let j=i-period+1-shift;j<=i-shift;j++)s+=closes[j];
    r[i]=closes[i-shift]-s/period;
  }
  return r;
}
function normRolling(raw, window=252, minPeriods=60){
  const r=new Array(raw.length).fill(50);
  for(let i=0;i<raw.length;i++){
    if(raw[i]===null)continue;
    let mn=Infinity, mx=-Infinity, count=0;
    for(let j=Math.max(0,i-window+1);j<=i;j++){
      if(raw[j]===null)continue;
      if(raw[j]<mn)mn=raw[j];
      if(raw[j]>mx)mx=raw[j];
      count++;
    }
    if(count<minPeriods){r[i]=50;continue;}
    r[i]=mx>mn?(raw[i]-mn)/(mx-mn)*100:50;
  }
  return r;
}
function trend(arr,days=5){
  const v=arr.filter(x=>x!==null);
  if(v.length<days+2)return'flat';
  return v[v.length-1]>v[v.length-1-days]?'up':'down';
}
function assetDPOs(closes){
  if(!closes||closes.length<60)return null;
  const out={l2:{},l3:{}};
  for(const[k,p]of[['1d',7],['3d',15],['1w',20],['2w',40]]){
    const n=normRolling(calcDPO(closes,p));
    out.l2[k]={val:Math.round(n[n.length-1]*10)/10,trend:trend(n)};
  }
  for(const[k,p]of[['2h',5],['4h',7],['8h',10],['12h',14]]){
    const n=normRolling(calcDPO(closes,p));
    out.l3[k]={val:Math.round(n[n.length-1]*10)/10,trend:trend(n)};
  }
  return out;
}
function getSignal(w1,w2){
  const fl = mcatPrefs.floor;
  const wt = mcatPrefs.watch;
  const ex = mcatPrefs.extended;
  if(w1<fl&&w2<fl)return'ACCUMULATE_CONFIRMED';
  if(w1<wt&&w2<wt)return'ACCUMULATE_WATCH';
  if(w1<wt+5&&w2<wt+5)return'WATCH_ENTRY';
  if(w1>ex||w2>ex)return'EXTENDED';
  return'MONITOR';
}
function l3Score(l3){
  return['2h','4h','8h','12h'].reduce((s,k)=>s+(l3[k].val<20&&l3[k].trend==='up'?1:0),0);
}
function l3State(l3,score){
  if(score>=3)return'ENTRY_NOW';
  if(score===2)return'NEAR';
  if(['2h','4h','8h','12h'].every(k=>l3[k].val<20))return'AT_FLOOR';
  return'WAIT';
}
function makeAlert(sig,l3st,l2,l3){
  const w1v=l2['1w'].val,w2v=l2['2w'].val,w1t=l2['1w'].trend,w2t=l2['2w'].trend;
  if(sig==='ACCUMULATE_CONFIRMED'){
    if(l3st==='ENTRY_NOW')return'🎯 Buy zone confirmed and entry trigger has fired — this is the moment. Maximum conviction entry.';
    if(l3st==='AT_FLOOR') return`✅ In the deepest buy zone — waiting for the 4H entry trigger to fire. 4H at ${l3['4h'].val.toFixed(0)}.`;
    if(w1t==='down'&&w2t==='down')return`✅ In the deepest buy zone but still falling — waiting for the bottom to form. 1W: ${w1v} · 2W: ${w2v}`;
    return`✅ In the deepest buy zone — watching for entry trigger. 1W: ${w1v} · 2W: ${w2v}`;
  }
  if(sig==='ACCUMULATE_WATCH'){
    if(l3st==='ENTRY_NOW')return'🎯 In the buy zone and trigger has fired! Good entry — watching for deeper confirmation.';
    if(l3st==='AT_FLOOR') return`✅ In the buy zone — waiting for the 4H entry trigger. 4H at ${l3['4h'].val.toFixed(0)}.`;
    if(w1t==='down'&&w2t==='down')return`✅ In the buy zone but still falling — waiting for bottom to form. 1W: ${w1v} · 2W: ${w2v}`;
    return`✅ In the buy zone — watching for entry trigger and deeper confirmation. 1W: ${w1v} · 2W: ${w2v}`;
  }
  if(sig==='ACCUMULATE'){
    if(l3st==='ENTRY_NOW')return'🎯 In the buy zone and entry trigger fired — go time. All layers aligned.';
    if(l3st==='AT_FLOOR') return`✅ In the buy zone at the floor — waiting for the 4H trigger to fire. 4H at ${l3['4h'].val.toFixed(0)}.`;
    if(w1t==='down'&&w2t==='down')return`⚠️ In the buy zone but still falling — waiting for the bottom to form. 1W: ${w1v} · 2W: ${w2v}`;
    return`✅ In the buy zone — watching for entry trigger. 1W: ${w1v} · 2W: ${w2v}`;
  }
  if(sig==='WATCH_ENTRY')return`👀 Getting close — indicators are dropping toward the buy zone. 1W: ${w1v} · 2W: ${w2v}. Need both below 25.`;
  if(sig==='EXTENDED')   return`⚠️ Overheated — cycle is stretched high. Not a buying zone. 1W: ${w1v} · 2W: ${w2v}`;
  return`⏳ Not yet — indicators are mid-range, nothing to act on. 1W: ${w1v} · 2W: ${w2v}`;
}

// Signal display names — plain English
// ── MQS STATE + DYNAMIC TIER ENGINE ──
// Seed values — will be replaced by live API feeds (Task D1)
const MQS_STATE = {
  vix: 21.4,              // CBOE VIX index level
  btcAbove200ma: false,   // true = BTC above 200-day MA (bull), false = below (bear)
  btcMa200Pct: -31.6,     // % distance from 200MA (for display)
  spxCoBottom: false,      // true = SPX bottomed within ±30d of crypto signal
  spxAbove200ma: true,     // true = SPX above 200-day MA
  spxMa200Pct: 6.1,       // % distance from 200MA
  yenUnwind: false,        // true = USDJPY dropped ≥3% in 20 days
  m2Expanding: false,      // true = M2 YoY > 2%
  m2Contracting: false,    // true = M2 YoY < 0%
  dataSource: 'SEED',      // 'SEED' | 'LIVE' | 'STALE'
  lastUpdated: null,       // ISO timestamp from pipeline
  signalDate: '2026-02-13', // DPO signal fire date (manually set)
  cycleLength: 60          // Expected cycle length in days
};

// ── LIVE DATA FROM PIPELINE (read from Cloudflare KV) ──
let pipelineData = null; // Will be populated from KV key: mcat_live_data

// ── BACKTEST TABLES (read from Cloudflare KV) ──
// Per-asset EV tables for the Analyze tab narrative
const BACKTEST_TABLES = {
  // Core 9 validated aggregate (242 events)
  aggregate: {
    GREEN: { n:105, ev_90d:152.6, hit_90d:59, ev_30d:35.1, ev_60d:68.3 },
    AMBER: { n:69,  ev_90d:28.0,  hit_90d:81, ev_30d:11.7, ev_60d:19.9 },
    RED:   { n:68,  ev_90d:12.7,  hit_90d:59, ev_30d:1.7,  ev_60d:-5.7 }
  },
  per_asset_post2022: {
    // CORE 9 (canonical DPO detection — fully validated)
    BTC:  { GREEN:{n:5,ev_90d:12.3,hit_90d:60,worst:-9.7,best:64.4}, AMBER:{n:5,ev_90d:15.2,hit_90d:80,worst:-19.7,best:46.1}, RED:{n:7,ev_90d:37.5,hit_90d:100,worst:10.6,best:80.3} },
    ETH:  { GREEN:{n:4,ev_90d:-2.9,hit_90d:50,worst:-17.5,best:10.1}, AMBER:{n:1,ev_90d:23.7,hit_90d:100,worst:23.7,best:23.7}, RED:{n:8,ev_90d:2.5,hit_90d:50,worst:-17.5,best:33.5} },
    XRP:  { AMBER:{n:3,ev_90d:25.8,hit_90d:100,worst:21.7,best:28.8}, RED:{n:3,ev_90d:5.1,hit_90d:67,worst:-1.5,best:11.5} },
    XLM:  { GREEN:{n:4,ev_90d:-13.3,hit_90d:25,worst:-29.3,best:9.5}, AMBER:{n:3,ev_90d:6.1,hit_90d:100,worst:0.0,best:12.6}, RED:{n:3,ev_90d:3.8,hit_90d:67,worst:-2.1,best:9.6} },
    LTC:  { GREEN:{n:2,ev_90d:-9.8,hit_90d:0,worst:-17.9,best:-1.7}, AMBER:{n:5,ev_90d:15.3,hit_90d:100,worst:2.3,best:28.6}, RED:{n:3,ev_90d:1.5,hit_90d:33,worst:-11.9,best:16.8} },
    DOGE: { GREEN:{n:8,ev_90d:-2.0,hit_90d:38,worst:-46.9,best:89.7}, AMBER:{n:2,ev_90d:0.9,hit_90d:50,worst:-0.2,best:1.9}, RED:{n:5,ev_90d:92.9,hit_90d:80,worst:-30.5,best:298.4} },
    XMR:  { GREEN:{n:2,ev_90d:-0.3,hit_90d:50,worst:-5.8,best:5.2}, AMBER:{n:3,ev_90d:27.9,hit_90d:100,worst:18.2,best:43.0}, RED:{n:3,ev_90d:46.4,hit_90d:100,worst:21.5,best:63.1} },
    DASH: { GREEN:{n:4,ev_90d:-13.7,hit_90d:50,worst:-41.7,best:1.7}, AMBER:{n:2,ev_90d:-19.3,hit_90d:50,worst:-43.2,best:4.6}, RED:{n:2,ev_90d:0.2,hit_90d:50,worst:-1.9,best:2.2} },
    ADA:  { GREEN:{n:5,ev_90d:-10.5,hit_90d:20,worst:-21.6,best:1.8}, AMBER:{n:1,ev_90d:4.0,hit_90d:100,worst:4.0,best:4.0}, RED:{n:3,ev_90d:-2.7,hit_90d:33,worst:-14.3,best:17.6} },
    // EXTRA 5 (simplified DPO detection — approximate, Phase 2 will refine)
    QNT:  { GREEN:{n:8,ev_90d:-5.5,hit_90d:50,worst:-28.5,best:19.6}, AMBER:{n:4,ev_90d:44.9,hit_90d:75,worst:-18.4,best:103.8}, RED:{n:7,ev_90d:13.7,hit_90d:57,worst:-10.7,best:38.5} },
    HBAR: { GREEN:{n:16,ev_90d:35.5,hit_90d:69,worst:-40.0,best:284.0}, AMBER:{n:3,ev_90d:17.2,hit_90d:67,worst:-17.5,best:61.8}, RED:{n:1,ev_90d:-9.4,hit_90d:0,worst:-9.4,best:-9.4} },
    BNB:  { GREEN:{n:8,ev_90d:29.5,hit_90d:62,worst:-16.9,best:96.7}, AMBER:{n:2,ev_90d:9.6,hit_90d:50,worst:-19.7,best:39.0}, RED:{n:3,ev_90d:12.5,hit_90d:67,worst:-4.9,best:22.5} },
    TRX:  { GREEN:{n:6,ev_90d:16.4,hit_90d:67,worst:-17.3,best:54.5}, AMBER:{n:4,ev_90d:10.1,hit_90d:75,worst:-9.2,best:29.8}, RED:{n:2,ev_90d:9.0,hit_90d:100,worst:4.3,best:13.7} },
    ETC:  { GREEN:{n:13,ev_90d:10.6,hit_90d:46,worst:-30.4,best:74.2}, AMBER:{n:1,ev_90d:-5.9,hit_90d:0,worst:-5.9,best:-5.9}, RED:{n:8,ev_90d:2.5,hit_90d:50,worst:-61.3,best:104.0} }
  },
  alt_overlay: {
    calm_green_warning: true,
    calm_green_alt_ev: -7.2,
    calm_green_alt_hit: 34,
    amber_is_alt_sweet_spot: true,
    amber_alt_ev: 12.3,
    amber_alt_hit: 90
  },
  multi_horizon: {
    AMBER: { d30:13.9, d60:11.7, d90:12.3 },
    RED:   { d30:-2.7, d60:0.9,  d90:21.6 }
  }
};

// ── ALT SIZING TABLES (from handoff doc) ──
const ALT_SIZING = {
  'GREEN_CAP':  { low:'80%', high:'100%', label:'MAX DEPLOY' },
  'AMBER':      { conf_low:'50–70%', conf_high:'60–80%', label:'Moderate-Strong' },
  'RED':        { conf_low:'15–25%', conf_high:'20–35%', label:'Conservative' },
  'GREEN_CALM': { conf_low:'25–35%', conf_high:'30–40%', label:'Reduced (Calm GREEN)' }
};
const BTC_SIZING = {
  'GREEN_CAP':  { low:'80%', high:'100%', label:'MAX DEPLOY' },
  'GREEN_CALM': { conf_low:'60–80%', conf_high:'80–100%', label:'Strong' },
  'AMBER':      { conf_low:'40–60%', conf_high:'50–70%', label:'Moderate' },
  'RED':        { conf_low:'15–25%', conf_high:'20–30%', label:'Conservative' }
};

// ── SWING SIGNAL DATA (1D DPO period 7, post-2022) ──
const SWING_EXIT_RULES = {
  'QNT':'fixed-14', 'ETH':'fixed-14', 'ETC':'fixed-14', 'LINK':'fixed-14',
  'XRP':'trend-80', 'HBAR':'trend-80', 'SOL':'trend-80', 'TAO':'trend-80',
  'BNB':'fixed-21'
};
const SWING_BACKTEST = {
  'BTC':  { n:24, ev7:2.8, ev14:3.8, ev21:6.2, hit14:58 },
  'XRP':  { n:41, ev7:6.4, ev14:5.7, ev21:5.9, hit14:56 },
  'QNT':  { n:16, ev7:6.4, ev14:7.1, ev21:5.8, hit14:75 },
  'HBAR': { n:38, ev7:4.5, ev14:2.7, ev21:3.7, hit14:58 },
  'XLM':  { n:37, ev7:4.2, ev14:0.2, ev21:1.3, hit14:51 },
  'ETH':  { n:15, ev7:4.7, ev14:4.9, ev21:4.3, hit14:60 },
  'ETC':  { n:14, ev7:6.1, ev14:8.4, ev21:8.8, hit14:79 },
  'BNB':  { n:26, ev7:4.9, ev14:4.1, ev21:6.9, hit14:65 },
  'LINK': { n:17, ev7:3.8, ev14:6.0, ev21:3.5, hit14:71 },
  'SOL':  { n:31, ev7:5.0, ev14:4.8, ev21:2.7, hit14:58 },
  'TAO':  { n:40, ev7:5.3, ev14:8.0, ev21:13.3, hit14:60 },
  'DOGE': { n:30, ev7:4.0, ev14:3.8, ev21:0.6, hit14:63 }
};
const SWING_BTC_COBOTTOM = {
  'XRP':  { with_btc:{ev14:8.0,hit:60}, without:{ev14:3.6,hit:52} },
  'QNT':  { with_btc:{ev14:7.9,hit:80}, without:{ev14:6.8,hit:73} },
  'HBAR': { with_btc:{ev14:4.3,hit:67}, without:{ev14:2.0,hit:54} },
  'XLM':  { with_btc:{ev14:3.8,hit:67}, without:{ev14:-1.5,hit:44} },
  'ETH':  { with_btc:{ev14:4.7,hit:54}, without:{ev14:5.7,hit:100} },
  'TAO':  { with_btc:{ev14:17.7,hit:62}, without:{ev14:5.5,hit:59} }
};

/**
 * getMqsTier() — MQS Lookup Table (M65)
 * Evaluates rules in ORDER — first match wins.
 * Returns { tier, ev, evRaw, hitRate, hitN, sizing, sizingLabel, rule, ruleName,
 *           plainDesc, techDesc, triggerHtml, decisionPathHtml }
 * 
 * DECISION TREE:
 *   1. VIX >45 → GREEN capitulation (+111.7%, 100% hit)
 *   2. SPX co-bottom + VIX <30 → RED (-6.5% to +7.8%)
 *   3. VIX 20-30 + BTC bear → RED (+15.3%)
 *   4. VIX 20-30 + BTC bull → AMBER (+28.4%)
 *   5. VIX 30-45 → AMBER (+27.6%)
 *   6. VIX <20 + BTC bear + no co-bottom → AMBER (+26.5%)
 *   7. VIX <20 + BTC bull + no co-bottom → GREEN (+155.5%)
 *   8. Override: GREEN + yen unwind → AMBER (+19.5%)
 *   9. Override: GREEN + M2 expanding → PREMIUM GREEN (+207.9%)
 *  10. Override: GREEN + M2 contracting → size as AMBER (+10.9%)
 *
 * Monotonicity: GREEN +152.6% > AMBER +28.0% > RED +12.7%
 * Sizing: GREEN 70-80% | AMBER 50-60% | RED 20-25% | CAPITULATION 80-100%
 */
function getMqsTier(s) {
  if (!s) s = MQS_STATE;
  const vix = s.vix;
  const bull = s.btcAbove200ma;
  const bear = !bull;
  const coBot = s.spxCoBottom;
  const yenUw = s.yenUnwind;
  const m2Exp = s.m2Expanding;
  const m2Con = s.m2Contracting;

  let tier, ev, hitRate, hitN, sizing, sizingLabel, rule, ruleName;

  // Rule 1: VIX >45 → GREEN capitulation
  if (vix > 45) {
    tier='GREEN'; ev=111.7; hitRate=100; hitN=4; sizing='80–100%'; sizingLabel='MAX DEPLOY'; rule=1; ruleName='VIX >45 capitulation';
  }
  // Rule 2: SPX co-bottom + VIX <30 → RED
  else if (coBot && vix < 30) {
    tier='RED'; ev=7.8; hitRate=55; hitN=11; sizing='20–25%'; sizingLabel='Conservative'; rule=2; ruleName='SPX co-bottom + VIX <30';
  }
  // Rule 3: VIX 20-30 + BTC bear → RED
  else if (vix >= 20 && vix <= 30 && bear) {
    tier='RED'; ev=15.3; hitRate=65; hitN=34; sizing='20–25%'; sizingLabel='Conservative'; rule=3; ruleName='VIX 20–30 + BTC bear';
  }
  // Rule 4: VIX 20-30 + BTC bull → AMBER
  else if (vix >= 20 && vix <= 30 && bull) {
    tier='AMBER'; ev=28.4; hitRate=79; hitN=29; sizing='50–60%'; sizingLabel='Moderate'; rule=4; ruleName='VIX 20–30 + BTC bull';
  }
  // Rule 5: VIX 30-45 → AMBER
  else if (vix > 30 && vix <= 45) {
    tier='AMBER'; ev=27.6; hitRate=73; hitN=15; sizing='50–60%'; sizingLabel='Moderate'; rule=5; ruleName='VIX 30–45';
  }
  // Rule 6: VIX <20 + BTC bear + no co-bottom → AMBER
  else if (vix < 20 && bear && !coBot) {
    tier='AMBER'; ev=26.5; hitRate=75; hitN=20; sizing='50–60%'; sizingLabel='Moderate'; rule=6; ruleName='VIX <20 + BTC bear';
  }
  // Rule 7: VIX <20 + BTC bull + no co-bottom → GREEN baseline
  else if (vix < 20 && bull && !coBot) {
    tier='GREEN'; ev=155.5; hitRate=58; hitN=40; sizing='70–80%'; sizingLabel='Full'; rule=7; ruleName='VIX <20 + BTC bull';
  }
  // Fallback (shouldn't reach — covers edge cases like vix exactly 20 with co-bottom)
  else {
    tier='AMBER'; ev=28.0; hitRate=75; hitN=0; sizing='50–60%'; sizingLabel='Moderate'; rule=0; ruleName='Fallback';
  }

  // Overrides (only apply to GREEN from Rule 7)
  let overrideNote = '';
  if (rule === 7) {
    // Rule 8: yen unwind overrides GREEN → AMBER
    if (yenUw) {
      tier='AMBER'; ev=19.5; sizing='50–60%'; sizingLabel='Moderate (yen risk)'; rule=8; ruleName='GREEN + yen unwind';
      overrideNote = 'Yen carry unwind detected — GREEN overridden to AMBER.';
    }
    // Rule 9: M2 expanding → PREMIUM GREEN (checked after yen, so yen takes priority)
    else if (m2Exp) {
      tier='GREEN'; ev=207.9; sizing='70–80%'; sizingLabel='Full (M2 tailwind)'; rule=9; ruleName='GREEN + M2 expanding';
      overrideNote = 'M2 expanding >2% YoY — PREMIUM GREEN conditions.';
    }
    // Rule 10: M2 contracting → size as AMBER
    else if (m2Con) {
      tier='GREEN'; ev=10.9; sizing='50–60%'; sizingLabel='Moderate (M2 drag)'; rule=10; ruleName='GREEN + M2 contracting';
      overrideNote = 'M2 contracting — GREEN tier but sizing reduced to AMBER levels.';
    }
  }

  const evRaw = 95.8; // raw DPO signal EV without macro adjustment

  // ── CSS variable name for this tier ──
  const cssVar = tier === 'GREEN' ? 'var(--green)' : tier === 'AMBER' ? 'var(--amber)' : 'var(--red)';
  const cssPill = tier === 'GREEN' ? 'ctx-pill-green' : tier === 'AMBER' ? 'ctx-pill-amber' : 'ctx-pill-red';

  // ── Plain English description (for tooltips) ──
  const plainDescs = {
    1: 'Extreme fear — historically the best possible entry. Maximum deployment warranted.',
    2: 'The stock market is bottoming at the same time as crypto. This overlap has historically destroyed returns — be very cautious.',
    3: 'The macro environment is unfavorable. BTC is below its 200-day average in a stressed VIX zone. Expected returns are significantly compressed — position sizing should be conservative.',
    4: 'The macro environment is mixed. VIX is elevated but BTC is in a bull regime. Returns are moderate — standard position sizing.',
    5: 'VIX is elevated (30–45 range). Historically this produces moderate returns similar to other AMBER conditions.',
    6: 'VIX is low but BTC is in a bear regime. The calm surface masks underlying weakness — moderate sizing.',
    7: 'Ideal conditions — low VIX, BTC in bull regime, no stock market co-bottom. Historically the best sustained returns.',
    8: 'Conditions were ideal but a sudden yen carry trade unwind has introduced risk. Sizing reduced to AMBER levels.',
    9: 'Ideal conditions plus M2 money supply expanding — the strongest possible macro tailwind for crypto.',
    10: 'Conditions are otherwise ideal but M2 is contracting, which historically drags returns. Sizing reduced to AMBER levels.'
  };
  const plainDesc = plainDescs[rule] || plainDescs[3];

  // ── Technical description (for tooltip tech line) ──
  const techDesc = `MQS lookup: ${ruleName} = ${tier} (Rule ${rule}). Macro-adjusted 90d EV: +${ev}% vs raw +${evRaw}%. n=${hitN}, ${hitRate}% hit rate. ${s.dataSource === 'SEED' ? 'SEED = using initial calibration data, not live feeds yet. ' : ''}Ref: M65.`;

  // ── Decision Path HTML (7 main rules + overrides) ──
  const rules = [
    { n:1, txt:'VIX &gt;45 → GREEN capitulation' },
    { n:2, txt:'SPX co-bottom + VIX &lt;30 → RED' },
    { n:3, txt:'VIX 20–30 + BTC bear → RED' },
    { n:4, txt:'VIX 20–30 + BTC bull → AMBER' },
    { n:5, txt:'VIX 30–45 → AMBER' },
    { n:6, txt:'VIX &lt;20 + BTC bear → AMBER' },
    { n:7, txt:'VIX &lt;20 + BTC bull → GREEN' },
  ];
  let dpHtml = '';
  for (const r of rules) {
    if (r.n === rule || (rule >= 8 && r.n === 7)) {
      const c = rule >= 8 ? 'var(--green)' : cssVar;
      dpHtml += `<div style="color:${c};font-weight:700;border-left:3px solid ${c};padding-left:10px;margin-left:-13px;">${r.n}. ${r.txt} ← YOU ARE HERE</div>`;
    } else {
      dpHtml += `<div style="color:#b0b0bc;">${r.n}. ${r.txt}</div>`;
    }
  }
  dpHtml += `<div style="color:#b0b0bc;font-size:10px;margin-top:4px;padding-left:14px;">8–10. Overrides: yen unwind, M2 expand/contract</div>`;
  if (overrideNote) {
    dpHtml += `<div style="color:var(--amber);font-size:10px;margin-top:6px;font-style:italic;">${overrideNote}</div>`;
  }
  dpHtml += `<div style="font-size:10px;color:${cssVar};margin-top:10px;padding-top:8px;border-top:1px solid var(--border);font-family:'Space Mono',monospace;">Result: ${tier} · +${ev}% adjusted EV · n=${hitN}, ${hitRate}% hit</div>`;

  // ── Trigger HTML (What Would Change) — context-aware ──
  let trigHtml = '';
  if (tier === 'RED' || rule === 2 || rule === 3) {
    trigHtml += `<div style="margin-bottom:10px;">
      <div style="color:var(--amber);font-weight:700;font-size:11px;font-family:'Space Mono',monospace;margin-bottom:2px;">⬆ UPGRADE TO AMBER</div>
      <div>BTC crosses above its 200-day moving average — moves from Rule ${rule} to Rule 4<br><span style="font-family:'Space Mono',monospace;font-size:11px;color:var(--amber);">+28.4% EV · 79% hit · sizing moves to 50–60%</span></div>
    </div>`;
    trigHtml += `<div style="margin-bottom:10px;">
      <div style="color:var(--green);font-weight:700;font-size:11px;font-family:'Space Mono',monospace;margin-bottom:2px;">⬆⬆ UPGRADE TO GREEN</div>
      <div>VIX drops below 20 <strong style="color:var(--text)">AND</strong> BTC crosses above 200MA <strong style="color:var(--text)">AND</strong> no SPX co-bottom — Rule 7<br><span style="font-family:'Space Mono',monospace;font-size:11px;color:var(--green);">+155.5% EV · sizing moves to 70–80%</span></div>
    </div>`;
    trigHtml += `<div style="margin-bottom:10px;">
      <div style="color:var(--red);font-weight:700;font-size:11px;font-family:'Space Mono',monospace;margin-bottom:2px;">⬇ STAY RED — WORSE</div>
      <div>SPX co-bottom detected — S&P 500 bottoms within ±30 days of the crypto signal. Co-bottom historically destroys EV.</div>
    </div>`;
  } else if (tier === 'AMBER') {
    trigHtml += `<div style="margin-bottom:10px;">
      <div style="color:var(--green);font-weight:700;font-size:11px;font-family:'Space Mono',monospace;margin-bottom:2px;">⬆ UPGRADE TO GREEN</div>
      <div>VIX drops below 20 <strong style="color:var(--text)">AND</strong> BTC crosses above 200MA <strong style="color:var(--text)">AND</strong> no SPX co-bottom — Rule 7<br><span style="font-family:'Space Mono',monospace;font-size:11px;color:var(--green);">+155.5% EV · sizing moves to 70–80%</span></div>
    </div>`;
    trigHtml += `<div style="margin-bottom:10px;">
      <div style="color:var(--red);font-weight:700;font-size:11px;font-family:'Space Mono',monospace;margin-bottom:2px;">⬇ DOWNGRADE TO RED</div>
      <div>SPX co-bottom detected or conditions worsen (VIX rises + BTC stays bear)<br><span style="font-family:'Space Mono',monospace;font-size:10px;color:var(--red);">+15.3% EV · sizing drops to 20–25%</span></div>
    </div>`;
  } else if (tier === 'GREEN') {
    trigHtml += `<div style="margin-bottom:10px;">
      <div style="color:var(--amber);font-weight:700;font-size:11px;font-family:'Space Mono',monospace;margin-bottom:2px;">⬇ DOWNGRADE TO AMBER</div>
      <div>BTC drops below 200MA, VIX rises above 20, or yen carry unwind detected<br><span style="font-family:'Space Mono',monospace;font-size:11px;color:var(--amber);">+28.4% EV · sizing drops to 50–60%</span></div>
    </div>`;
    trigHtml += `<div style="margin-bottom:10px;">
      <div style="color:var(--red);font-weight:700;font-size:11px;font-family:'Space Mono',monospace;margin-bottom:2px;">⬇⬇ DOWNGRADE TO RED</div>
      <div>SPX co-bottom detected or VIX spikes to 20–30 + BTC bear<br><span style="font-family:'Space Mono',monospace;font-size:10px;color:var(--red);">+15.3% EV · sizing drops to 20–25%</span></div>
    </div>`;
  }
  // Capitulation override always shown
  trigHtml += `<div>
    <div style="color:var(--purple);font-weight:700;font-size:11px;font-family:'Space Mono',monospace;margin-bottom:2px;">⚡ CAPITULATION OVERRIDE</div>
    <div>VIX spikes above 45 → immediate GREEN override<br><span style="font-family:'Space Mono',monospace;font-size:11px;color:var(--purple);">+111.7% EV · 100% historical hit rate</span></div>
  </div>`;

  // ── Sizing tooltip description ──
  const sizingDesc = `Based on the ${tier} macro backdrop, recommended allocation is ${sizing} of your maximum position size. ${
    tier === 'GREEN' ? 'Conditions are favorable — full deployment warranted.' :
    tier === 'AMBER' ? 'Signal is valid but macro conditions are mixed — moderate sizing.' :
    'Signal is still valid but the macro environment has historically compressed returns. An upgrade to AMBER (50–60%) requires BTC crossing above its 200MA.'
  }`;

  return { tier, ev, evRaw, hitRate, hitN, sizing, sizingLabel, rule, ruleName,
           cssVar, cssPill, plainDesc, techDesc, dpHtml, trigHtml, sizingDesc, overrideNote };
}

/**
 * updateMqsDisplay() — Wires getMqsTier() output to ALL 5 display surfaces:
 *   1. Context strip: pill + EV
 *   2. Context strip tooltip: plain + tech
 *   3. MQS panel header: pill + EV + health
 *   4. MQS panel tooltip: plain + tech
 *   5. Position sizing: value + tooltip
 *   6. Expanded details: inputs grid + decision path + triggers + zone adjusted EVs
 *   7. Extreme badges on cards
 *   8. Alert line
 */
function updateMqsDisplay() {
  const m = getMqsTier();
  const s = MQS_STATE;

  // ── 0. Global macro strip ──
  updateMacroStrip();

  // ── 1. Context strip pill + EV ──
  const ctxPill = document.getElementById('ctx-macro-pill');
  const ctxEv = document.getElementById('ctx-macro-ev');
  if (ctxPill) {
    ctxPill.textContent = 'MACRO: ' + m.tier;
    ctxPill.className = 'ctx-pill ' + m.cssPill;
  }
  if (ctxEv) {
    ctxEv.textContent = '+' + Math.round(m.ev) + '%';
    ctxEv.style.color = m.cssVar;
  }

  // ── 2. Context strip tooltip ──
  const ctxTtBody = document.getElementById('ctx-macro-tt-body');
  const ctxTtTech = document.getElementById('ctx-macro-tt-tech');
  if (ctxTtBody) ctxTtBody.textContent = m.plainDesc;
  if (ctxTtTech) ctxTtTech.textContent = m.techDesc;

  // ── 3. MQS panel header: pill + EV ──
  const mqsPill = document.getElementById('mqs-header-pill');
  const mqsEvMain = document.getElementById('mqs-header-ev');
  if (mqsPill) {
    mqsPill.textContent = m.tier;
    mqsPill.className = 'ctx-pill ' + m.cssPill;
  }
  if (mqsEvMain) {
    mqsEvMain.textContent = '+' + m.ev + '%';
    mqsEvMain.style.color = m.cssVar;
  }

  // ── 4. MQS panel tooltip: plain + tech ──
  const mqsTtBody = document.getElementById('mqs-header-tt-body');
  const mqsTtTech = document.getElementById('mqs-header-tt-tech');
  if (mqsTtBody) mqsTtBody.textContent = m.plainDesc;
  if (mqsTtTech) mqsTtTech.textContent = m.techDesc;

  // ── 5. Position sizing ──
  const sizeVal = document.getElementById('mqs-size-val');
  const sizeTtBody = document.getElementById('mqs-size-tt-body');
  if (sizeVal) {
    sizeVal.textContent = m.sizing;
    sizeVal.style.color = m.cssVar;
  }
  if (sizeTtBody) sizeTtBody.textContent = m.sizingDesc;

  // ── 6. Expanded details ──
  // 6a. Macro inputs grid (values)
  const vixVal = document.getElementById('mqs-input-vix-val');
  const vixStatus = document.getElementById('mqs-input-vix-status');
  if (vixVal) {
    vixVal.textContent = s.vix.toFixed(1);
    vixVal.style.color = s.vix > 45 ? 'var(--purple)' : s.vix > 30 ? 'var(--red)' : s.vix >= 20 ? 'var(--amber)' : 'var(--green)';
  }
  if (vixStatus) {
    vixStatus.textContent = s.vix > 45 ? 'Capitulation' : s.vix > 30 ? 'Elevated 30–45' : s.vix >= 20 ? 'Range 20–30' : 'Low <20';
    vixStatus.style.color = vixVal ? vixVal.style.color : 'var(--sub)';
  }

  const btcVal = document.getElementById('mqs-input-btc-val');
  const btcStatus = document.getElementById('mqs-input-btc-status');
  if (btcVal) {
    btcVal.textContent = s.btcAbove200ma ? 'ABOVE' : 'BELOW';
    btcVal.style.color = s.btcAbove200ma ? 'var(--green)' : 'var(--red)';
  }
  if (btcStatus) btcStatus.textContent = s.btcMa200Pct.toFixed(1) + '% · ' + (s.btcAbove200ma ? 'Bull regime' : 'Bear regime');

  const spxVal = document.getElementById('mqs-input-spx-val');
  if (spxVal) {
    spxVal.textContent = s.spxCoBottom ? 'DETECTED' : 'NONE';
    spxVal.style.color = s.spxCoBottom ? 'var(--red)' : 'var(--green)';
  }

  const yenVal = document.getElementById('mqs-input-yen-val');
  if (yenVal) {
    yenVal.textContent = s.yenUnwind ? 'UNWIND' : 'STABLE';
    yenVal.style.color = s.yenUnwind ? 'var(--red)' : 'var(--green)';
  }

  const m2Val = document.getElementById('mqs-input-m2-val');
  if (m2Val) {
    m2Val.textContent = s.m2Expanding ? 'EXPANDING' : s.m2Contracting ? 'CONTRACTING' : 'NEUTRAL';
    m2Val.style.color = s.m2Expanding ? 'var(--green)' : s.m2Contracting ? 'var(--red)' : 'var(--sub)';
  }

  // 6b. Decision Path
  const dpEl = document.getElementById('mqs-decision-path');
  if (dpEl) dpEl.innerHTML = m.dpHtml;

  // 6c. Triggers
  const trigEl = document.getElementById('mqs-triggers');
  if (trigEl) trigEl.innerHTML = m.trigHtml;

  // 6d. Zone 2 adjusted EV — macro-adjusted as primary, raw as secondary
  const z2PrimaryEl = document.getElementById('mqs-zone2-adj-primary');
  const z2LabelEl = document.getElementById('mqs-zone2-adj-label');
  if (z2PrimaryEl) {
    z2PrimaryEl.textContent = '+' + Math.round(m.ev) + '%';
    const evColor = m.tier === 'GREEN' ? 'var(--green)' : m.tier === 'RED' ? 'var(--red)' : 'var(--amber)';
    z2PrimaryEl.style.color = evColor;
  }
  const MACRO_ADJ_LABELS = {
    GREEN: 'Calm macro — full historical edge',
    AMBER: 'Stress recovery — reduced but positive',
    RED:   'Macro headwinds — patience required'
  };
  if (z2LabelEl) z2LabelEl.textContent = MACRO_ADJ_LABELS[m.tier] || 'macro-adjusted';

  // ── 7. Extreme badges ──
  EXTREME_STATE.vixCapitulation = s.vix > 45;
  EXTREME_STATE.spxCoBottom = s.spxCoBottom;

  // ── 8. Alert line ──
  const alertEl = document.getElementById('mqs-alert-line');
  if (alertEl) {
    const alerts = [];
    if (s.vix > 45) alerts.push('⚡ VIX CAPITULATION');
    if (s.spxCoBottom) alerts.push('⚠ SPX co-bottom detected');
    if (s.yenUnwind) alerts.push('⚠ Yen carry unwind');
    if (alerts.length === 0) {
      alertEl.textContent = 'All inputs stable · VIX ' + s.vix.toFixed(1) + ' · No alerts';
      alertEl.className = 'mqs-alert mqs-alert-normal';
    } else {
      alertEl.textContent = alerts.join(' · ');
      alertEl.className = 'mqs-alert ' + (s.vix > 45 ? 'mqs-alert-critical' : 'mqs-alert-attention');
    }
  }

  // ── Health dot ──
  const healthEl = document.getElementById('mqs-health-status');
  if (healthEl) {
    const dot = healthEl.querySelector('.mqs-health-dot');
    if (dot) {
      dot.className = 'mqs-health-dot mqs-health-' + s.dataSource.toLowerCase();
    }
    const label = healthEl.querySelector('.mqs-health-label');
    if (label) label.textContent = s.dataSource;
  }
}

// ── Extreme badge logic (reads from MQS_STATE via updateMqsDisplay) ──
const EXTREME_STATE = { vixCapitulation: false, spxCoBottom: false };
function getExtremeBadge(asset) {
  // Capitulation overrides co-bottom (stronger signal)
  if (EXTREME_STATE.vixCapitulation) {
    return '<span class="extreme-badge badge-capitulation">⚡ CAPITULATION — MAX DEPLOY</span>';
  }
  if (EXTREME_STATE.spxCoBottom) {
    return '<span class="extreme-badge badge-macro-risk">⚠ MACRO RISK — SIGNALS DEGRADED</span>';
  }
  return '';
}

// ── Context strip cycle day updater ──
// ── Guide panel click toggle ──
function toggleGuidePanel() {
  const panel = document.querySelector('.guide-panel-hdr');
  const strip = document.getElementById('macro-strip');
  if (panel) {
    panel.classList.toggle('open');
    if (strip) strip.style.display = panel.classList.contains('open') ? 'none' : 'flex';
  }
}
document.addEventListener('click', function(e) {
  const wrap = document.getElementById('guide-btn-wrap');
  const panel = document.querySelector('.guide-panel-hdr');
  const strip = document.getElementById('macro-strip');
  if (panel && wrap && !wrap.contains(e.target) && !panel.contains(e.target)) {
    panel.classList.remove('open');
    if (strip) strip.style.display = 'flex';
  }
});

// ── Global Macro Strip updater ──
function updateMacroStrip() {
  const s = MQS_STATE;
  const m = getMqsTier(s);

  // Tier badge
  const badge = document.getElementById('ms-tier-badge');
  const tooltip = document.getElementById('ms-tier-tooltip');
  if (badge) {
    const isCapitulation = s.vix >= 45;
    badge.textContent = isCapitulation ? 'CAPITULATION' : m.tier;
    badge.className = 'ms-tier-badge ' + (isCapitulation ? 'ms-capitulation' :
      m.tier === 'GREEN' ? 'ms-green' : m.tier === 'RED' ? 'ms-red' : 'ms-amber');
  }
  if (tooltip) {
    // Plain English descriptions — PLACEHOLDER: brain chat to review/refine these
    const RULE_PLAIN = {
      1: 'Extreme market panic. Historically, buying here has never lost at 90 days. Deploy maximum.',
      2: 'Stocks and crypto falling together despite moderate fear. Macro shock dragging everything down. Signals degraded — patience required.',
      3: 'Elevated fear plus Bitcoin in downtrend. Tough environment. Signals work but expect 60+ days before returns materialize.',
      4: 'Elevated fear but Bitcoin still in uptrend. Stress recovery zone — altcoins historically do their best work here.',
      5: 'Significant fear but not panic. Reduced sizing, but positive expected value. Be patient.',
      6: 'Markets calm but Bitcoin in downtrend. Mixed signals — proceed with standard sizing.',
      7: 'Best baseline conditions. Low fear, crypto in bull market. Full accumulation sizing.',
      8: 'Looks calm on the surface, but yen carry trade unwinding signals hidden stress. Downgraded to AMBER — reduce sizing.',
      9: 'Best conditions plus expanding money supply. Strongest historical environment. Full deployment, consider oversizing.',
      10: 'Good conditions but liquidity tightening. Accumulate, but size like AMBER — the money supply headwind caps upside.',
      0: 'Conditions don\'t match any specific scenario. Using moderate defaults.'
    };
    tooltip.innerHTML = `<div class="ms-tt-rule">Rule ${m.rule}: ${m.ruleName}</div><div class="ms-tt-plain">${RULE_PLAIN[m.rule] || ''}</div>`;
  }

  // VIX
  const vixEl = document.getElementById('ms-vix-val');
  if (vixEl && s.vix != null) {
    let vixLabel, vixCls;
    if (s.vix >= 45)      { vixLabel = s.vix.toFixed(1) + ' · CAPITULATION'; vixCls = 'ms-val ms-val-purple'; }
    else if (s.vix >= 30)  { vixLabel = s.vix.toFixed(1) + ' · High Stress'; vixCls = 'ms-val ms-val-red'; }
    else if (s.vix >= 20)  { vixLabel = s.vix.toFixed(1) + ' · Danger Zone'; vixCls = 'ms-val ms-val-amber'; }
    else                    { vixLabel = s.vix.toFixed(1) + ' · Calm'; vixCls = 'ms-val ms-val-green'; }
    // Boundary warning
    const boundary = (s.vix >= 18 && s.vix <= 22);
    vixEl.innerHTML = vixLabel + (boundary ? '<span class="ms-boundary">⚠ near boundary</span>' : '');
    vixEl.className = vixCls;
  }

  // BTC 200MA
  const btcEl = document.getElementById('ms-btc-val');
  if (btcEl) {
    const pct = s.btcMa200Pct;
    if (pct != null) {
      const above = s.btcAbove200ma;
      btcEl.textContent = above ? `▲ BULL (+${Math.abs(pct).toFixed(0)}%)` : `▼ BEAR (${pct.toFixed(0)}%)`;
      btcEl.className = 'ms-val ' + (above ? 'ms-val-green' : 'ms-val-red');
    }
  }

  // SPX
  const spxEl = document.getElementById('ms-spx-val');
  if (spxEl) {
    const coBottom = s.spxCoBottom || !s.spxAbove200ma;
    spxEl.textContent = coBottom ? '⚠ CO-BOTTOM' : '✓';
    spxEl.className = 'ms-val ' + (coBottom ? 'ms-val-red' : 'ms-val-dim');
    spxEl.style.fontWeight = coBottom ? '700' : '400';
  }

  // M2
  const m2El = document.getElementById('ms-m2-val');
  if (m2El) {
    if (s.m2Expanding) { m2El.textContent = '↑'; m2El.className = 'ms-val ms-val-green'; }
    else if (s.m2Contracting) { m2El.textContent = '↓'; m2El.className = 'ms-val ms-val-red'; }
    else { m2El.textContent = '→'; m2El.className = 'ms-val ms-val-dim'; }
  }

  // Yen carry (only show when active)
  const yenEl = document.getElementById('ms-yen');
  if (yenEl) yenEl.style.display = s.yenUnwind ? 'flex' : 'none';
}

function updateContextStrip() {
  const signalDate = new Date('2026-02-13');
  const now = new Date();
  const dayNum = Math.floor((now - signalDate) / 86400000);
  const cycleMean = 100;
  const z2CloseDay = 25;
  const daysToZ2Close = Math.max(0, z2CloseDay - dayNum);
  const z2CloseDate = new Date(signalDate);
  z2CloseDate.setDate(z2CloseDate.getDate() + z2CloseDay);
  const z2CloseStr = z2CloseDate.toLocaleDateString('en-US', {month:'short', day:'numeric'});

  const dayEl = document.getElementById('ctx-day-num');
  if (dayEl) dayEl.textContent = 'DAY ' + dayNum;

  const dotEl = document.getElementById('ctx-prog-dot');
  if (dotEl) dotEl.style.left = Math.min(95, Math.max(2, (dayNum / cycleMean) * 100)) + '%';

  const cdDays = document.getElementById('ctx-countdown-days');
  const cdDate = document.getElementById('ctx-countdown-date');
  if (cdDays && cdDate) {
    if (daysToZ2Close > 0) {
      cdDays.textContent = '~' + daysToZ2Close + 'd';
      cdDays.style.color = daysToZ2Close <= 3 ? 'var(--red)' : 'var(--green)';
      cdDate.textContent = z2CloseStr;
    } else {
      cdDays.textContent = 'CLOSED';
      cdDays.style.color = 'var(--red)';
      cdDate.textContent = '';
      // Update zone pill
      const zonePill = document.getElementById('ctx-zone-pill');
      if (zonePill) {
        zonePill.textContent = 'Zone 3 Active';
        zonePill.className = 'ctx-pill ctx-pill-red';
      }
    }
  }
}

const SIG_DISPLAY = {
  'ACCUMULATE_CONFIRMED': '✓✓ IN BUY ZONE',
  'ACCUMULATE_WATCH':     '✓ IN BUY ZONE',
  'ACCUMULATE':           'IN BUY ZONE',
  'WATCH_ENTRY':          'GETTING CLOSE',
  'MONITOR':              'NOT YET',
  'EXTENDED':             'OVERHEATED',
};

// Signal tooltip HTML
const SIG_STATES = [
  {k:'✓✓ IN BUY ZONE', cls:'sig-ACCUMULATE_CONFIRMED', desc:'The cycle has reached the deepest floor — highest conviction window to add to your position.<br><span style="color:#b0b0bc;font-family:Space Mono,monospace;font-size:10px">Technical: 1W + 2W DPO both confirmed below 20.</span>'},
  {k:'✓ IN BUY ZONE',  cls:'sig-ACCUMULATE_WATCH',     desc:'The cycle is in the buy zone — a good window to start adding.<br><span style="color:#b0b0bc;font-family:Space Mono,monospace;font-size:10px">Technical: 1W + 2W both below 25. Watching for confirmed floor below 20.</span>'},
  {k:'GETTING CLOSE',cls:'sig-WATCH_ENTRY',desc:'Almost at the buy zone but not quite there yet. Watch for the remaining indicators to drop.<br><span style="color:#b0b0bc;font-family:Space Mono,monospace;font-size:10px">Technical: 1W + 2W both below 30, descending toward the 25 watch zone.</span>'},
  {k:'NOT YET',    cls:'sig-MONITOR',    desc:'Mid-cycle — nothing to do right now. The indicators haven\'t reached actionable levels yet.<br><span style="color:#b0b0bc;font-family:Space Mono,monospace;font-size:10px">Technical: One or both DPOs between 30–80.</span>'},
  {k:'OVERHEATED',   cls:'sig-EXTENDED',   desc:'The cycle is stretched high — definitely not a buying zone. Consider reducing exposure and waiting for reset.<br><span style="color:#b0b0bc;font-family:Space Mono,monospace;font-size:10px">Technical: One or both DPOs above 80.</span>'},
];
function sigTooltipHTML(activeSig){
  const rows=SIG_STATES.map(s=>{
    const active=s.k.replace(' ','_')===activeSig||s.k===activeSig;
    return`<div class="sig-tt-row${active?' active-sig':''}">
      <span class="sig-tt-label ${s.cls}">${s.k}</span>
      <span class="sig-tt-text">${s.desc}</span>
    </div>`;
  }).join('');
  return`<div class="sig-tooltip"><div class="sig-tt-title">SIGNAL STATES</div>${rows}</div>`;
}


// State tooltip HTML
const L3_STATES = [
  {k:'TRIGGER FIRED', state:'ENTRY_NOW', cls:'state-ENTRY_NOW', desc:'The entry signal has fired — multiple short-term indicators have bottomed out and turned upward together. This is the precise moment the system is designed to catch.<br><span style="color:#b0b0bc;font-family:Space Mono,monospace;font-size:10px">Technical: 3+ of 4 sub-daily proxies below 30 and turning ↑. The 4H indicator — the most important in the system — has confirmed.</span>'},
  {k:'ALMOST THERE', state:'NEAR',      cls:'state-NEAR',      desc:'Very close to a trigger. Most short-term indicators are lining up but one or two haven\'t confirmed yet. Stay alert — watch the 4H indicator especially, it\'s the most important trigger.<br><span style="color:#b0b0bc;font-family:Space Mono,monospace;font-size:10px">Technical: 2 of 4 sub-daily proxies below 30 and turning ↑. The 4H — the key entry signal — is approaching but hasn\'t confirmed yet.</span>'},
  {k:'WAITING FOR TRIGGER', state:'AT_FLOOR',  cls:'state-AT_FLOOR',  desc:'The asset is sitting at the cycle floor — the buy zone is active. Now watching for the short-term indicators to turn upward to pinpoint the entry.<br><span style="color:#b0b0bc;font-family:Space Mono,monospace;font-size:10px">Technical: Layer 2 gate open (1W and 2W below 20). The 4H proxy hasn\'t dropped below 30 and turned ↑ yet.</span>'},
  {k:'EARLY SIGNS', state:'TURNING',   cls:'state-TURNING',   desc:'Some short-term indicators are starting to turn up, but it\'s too early to act. Keep an eye on the 4H indicator — that\'s the one that matters most for timing.<br><span style="color:#b0b0bc;font-family:Space Mono,monospace;font-size:10px">Technical: 1 of 4 sub-daily proxies showing upturn. The 4H has not yet dropped below 30 and turned ↑.</span>'},
  {k:'WAIT',      state:'WAIT',      cls:'state-WAIT',      desc:'Nothing happening on the short-term timing layer. The trigger conditions aren\'t close yet.<br><span style="color:#b0b0bc;font-family:Space Mono,monospace;font-size:10px">Technical: Sub-daily proxies above 30 or trending downward. No confluence score. Layer 3 inactive.</span>'},
];
function stateTooltipHTML(l3st, score, l3data){
  // Slim pill labels — short enough to never wrap
  const stateMap = {
    ENTRY_NOW: {cls:'wp-ENTRY_NOW', label:'TRIGGER FIRED', extra:'★'},
    NEAR:      {cls:'wp-NEAR',      label:'ALMOST THERE',  extra:`· ${score}/4`},
    AT_FLOOR:  {cls:'wp-AT_FLOOR',  label:'WAITING FOR TRIGGER', extra:''},
    TURNING:   {cls:'wp-TURNING',   label:'EARLY SIGNS',   extra:`· ${score}/4`},
    WAIT:      {cls:'wp-WAIT',      label:'WAIT',          extra:`· ${score}/4`},
  };
  const s = stateMap[l3st] || stateMap.WAIT;
  const rows = L3_STATES.map(st=>{
    const active = st.state === l3st;
    return '<div class="st-row'+(active?' active-state':'')+'"><span class="st-key '+st.cls+'">'+st.k+'</span><span class="st-desc">'+st.desc+'</span></div>';
  }).join('');

  // 4H rule box — state-aware
  const v4h_tt = l3data ? l3data['4h'].val : null;
  const t4h_tt = l3data ? l3data['4h'].trend : null;
  const fired_tt  = v4h_tt !== null && v4h_tt < 20 && t4h_tt === 'up';
  const armed_tt  = v4h_tt !== null && v4h_tt < 20 && t4h_tt !== 'up';
  const ttCls  = fired_tt ? 'tt-4h-fired' : armed_tt ? 'tt-4h-armed' : 'tt-4h-waiting';
  const ttTitle= fired_tt ? '★ 4H ENTRY TRIGGER — FIRED' : armed_tt ? '★ 4H ENTRY TRIGGER — ARMED' : '★ 4H ENTRY TRIGGER';
  const ttValColor = fired_tt ? 'var(--green)' : armed_tt ? 'var(--amber)' : 'var(--label)';
  const ttStatus   = fired_tt ? '✓ below threshold · ✓ turning up · ENTER' : armed_tt ? 'below threshold ✓ · waiting for ↑' : 'not yet at trigger';
  const ttStatusColor = fired_tt ? 'var(--green)' : armed_tt ? 'var(--amber)' : 'var(--sub)';
  const valStr = v4h_tt !== null ? `${v4h_tt.toFixed(1)} ${t4h_tt==='up'?'↑':'↓'}` : '—';
  const ruleBox = `<div class="tt-4h ${ttCls}">
    <div class="tt-4h-title">${ttTitle}</div>
    <div class="tt-4h-rule">Fires when <strong style="color:var(--text)">4H drops below 20</strong> (or 30 in very bullish conditions) AND <strong style="color:var(--text)">turns ↑</strong>. Upper cycles determine regime.</div>
    <div class="tt-4h-live">
      <span style="color:var(--label)">Now: </span>
      <span style="color:${ttValColor};font-weight:700">${valStr}</span>
      <span style="color:${ttStatusColor}">— ${ttStatus}</span>
    </div>
  </div>`;

  const extraHTML = s.extra ? `<span class="wide-pill-extra">${s.extra}</span>` : '';
  return`<div class="state-wrap">
    <div class="wide-pill ${s.cls}">
      <span class="wide-pill-state">${s.label}</span>
      ${extraHTML}
    </div>
    <div class="state-tooltip"><div class="st-title">LAYER 3 STATES</div>${rows}${ruleBox}</div>
  </div>`;
}

// ── ENTRY PRICE TARGETS ──
let entryTargets = {}; // {ticker: price|null}

const TV_SYMBOLS = {
  BTC:'BTCUSDT', ETH:'ETHUSDT', XRP:'XRPUSDT', QNT:'QNTUSDT', TAO:'TAOUSDT',
  XLM:'XLMUSDT', HBAR:'HBARUSDT', XDC:'XDCUSDT', ALGO:'ALGOUSDT', IOTA:'IOTAUSDT',
  AERO:'AEROUSDT', FLR:'FLRUSDT', ZORA:'ZORAUSDT', CRO:'CROUSDT', CC:'CCUSD'
};
const BN_SYMBOLS = {
  BTC:'BTC_USDT', ETH:'ETH_USDT', XRP:'XRP_USDT', QNT:'QNT_USDT', TAO:'TAO_USDT',
  XLM:'XLM_USDT', HBAR:'HBAR_USDT', XDC:'XDC_USDT', ALGO:'ALGO_USDT', IOTA:'IOTA_USDT',
  AERO:'AERO_USDT', FLR:'FLR_USDT', ZORA:'ZORA_USDT', CRO:'CRO_USDT', CC:null
};

function getTarget(ticker){ return entryTargets[ticker]||null; }
function setTarget(ticker,price){ entryTargets[ticker]=price; saveTargets(); renderAll(); }
function clearTarget(ticker){ saveTargetToWorker(ticker, null); renderAll(); }

function saveTargets(){
  try{ localStorage.setItem('mcat_targets',JSON.stringify(entryTargets)); }catch(e){}
}
function loadTargets(){
  try{
    const s=localStorage.getItem('mcat_targets');
    if(s) entryTargets=JSON.parse(s);
  }catch(e){}
}

function toggleEditPopup(ticker){
  const el=document.getElementById('ep-'+ticker);
  if(!el)return;
  const isOpen=el.classList.contains('open');
  // Close all others first
  document.querySelectorAll('.edit-popup.open').forEach(e=>e.classList.remove('open'));
  if(!isOpen) el.classList.add('open');
}

function buildL1Strip(){
  const g=currentGate;
  const isConfirmed=g.isConfirmed;
  const isOpen=g.isOpen;
  const isWarn=g.isWarn;
  const pillCls=isConfirmed?'open':isOpen?'open':isWarn?'warn':'monitoring';
  const pillTxt=isConfirmed?'✓✓ IN BUY ZONE':isOpen?'✓ IN BUY ZONE':isWarn?'OVERHEATED':'NOT YET';
  const t1Clr=g.v1w<20?'var(--green)':g.v1w>70?'var(--red)':'var(--sub)';
  const t2Clr=g.v2w<20?'var(--green)':g.v2w>70?'var(--red)':'var(--sub)';
  return`<span class="l1-gate-pill ${pillCls}">${pillTxt}</span>
  <div class="l1-vals">
    <div class="l1-val-item"><span class="l1-tf">1W</span><span style="color:${t1Clr}">${g.v1w.toFixed(1)}</span><span class="${g.t1w==='up'?'up':'dn'}">${g.t1w==='up'?'↑':'↓'}</span></div>
    <div class="l1-val-item"><span class="l1-tf">2W</span><span style="color:${t2Clr}">${g.v2w.toFixed(1)}</span><span class="${g.t2w==='up'?'up':'dn'}">${g.t2w==='up'?'↑':'↓'}</span></div>
  </div>`;
}

function buildCard(ticker,isHot=false){
  const a=liveData[ticker];
  const sig=getSignal(a.l2['1w'].val,a.l2['2w'].val);
  const score=l3Score(a.l3);
  const l3st=l3State(a.l3,score);
  const alert=makeAlert(sig,l3st,a.l2,a.l3);

  const maColor=a.ma200_pct!=null?(a.ma200_pct<0?'var(--red)':'var(--green)'):'var(--sub)';
  const maStr=a.ma200_pct!=null?`${a.ma200_pct>0?'+':''}${a.ma200_pct}% vs 200MA`:'no 200MA data';

  // 24hr price change
  const chg24=a.price_change_24h;
  const chgStr=chg24!=null?`<span style="font-family:'Space Mono',monospace;font-size:13px;font-weight:700;margin-left:6px;color:${chg24>=0?'var(--green)':'var(--red)'}">${chg24>=0?'+':''}${chg24.toFixed(1)}%</span>`:'';

  // L1 gate pill for card header
  const g=currentGate;
  const l1PillCls=g.isConfirmed?'open':g.isOpen?'open':g.isWarn?'warn':'monitoring';
  const l1PillTxt=g.isConfirmed?'✓✓ IN BUY ZONE':g.isOpen?'✓ IN BUY ZONE':g.isWarn?'OVERHEATED':'NOT YET';

  const TIER_STYLES={
    REFERENCE:{color:'var(--sub)',   bg:'rgba(122,112,96,0.12)'},
    CORE:     {color:'var(--amber)', bg:'rgba(255,170,0,0.15)'},
    TIER1:    {color:'var(--blue)',  bg:'rgba(85,153,255,0.12)'},
    TIER2:    {color:'var(--cyan)',  bg:'rgba(0,204,221,0.10)'},
    WATCHLIST:{color:'var(--purple)',bg:'rgba(176,136,255,0.12)'},
  };
  const ts=TIER_STYLES[a.tier]||TIER_STYLES.TIER2;
  const tierLabel=a.tier==='TIER1'?'TIER 1':a.tier==='TIER2'?'TIER 2':a.tier;

  const l2rows=['1d','3d','1w','2w'].map(k=>{
    const v=a.l2[k].val,t=a.l2[k].trend,isKey=k==='1w'||k==='2w';
    return`<div class="bar-row">
      <div class="bar-lbl${isKey?' key':''}">${k.toUpperCase()}</div>
      <div class="bar-track"><div class="bar-fill ${fc(v)}" style="width:${v}%"></div></div>
      <div class="bar-val ${cc(v)}">${v.toFixed(1)}</div>
      <div class="bar-arr ${t==='up'?'up':'dn'}">${t==='up'?'↑':'↓'}</div>
    </div>`;
  }).join('');

  const l3cells=['2h','4h','8h','12h'].map(k=>{
    const v=a.l3[k].val,t=a.l3[k].trend,is4h=k==='4h',firing=is4h&&v<20&&t==='up';
    return`<div class="l3-cell${is4h?' key':''}${firing?' firing':''}">
      <div class="l3-top">
        <div class="l3-name${is4h?' key-lbl':''}">${k.toUpperCase()}${is4h?' ★':''}</div>
        <div class="l3-arr ${t==='up'?'up':'dn'}">${t==='up'?'↑':'↓'}</div>
      </div>
      <div class="l3-bar"><div class="l3-fill ${fc(v)}" style="width:${v}%"></div></div>
      <div class="l3-val ${cc(v)}">${v.toFixed(1)}</div>
    </div>`;
  }).join('');

  const dots=[0,1,2,3].map(i=>`<div class="dot ${i<score?'on':'off'}"></div>`).join('');

  // ── ADAPTIVE 4H TRIGGER ──
  // Detect market regime from upper cycles
  const v1w = a.l2['1w'].val, t1w = a.l2['1w'].trend;
  const v2w_val = a.l2['2w'].val, t2w = a.l2['2w'].trend;
  const v3d = a.l2['3d'].val;
  const veryBullish = v2w_val < 20 && t2w === 'up' && t1w === 'up' && v3d < 50 && t2w === 'up';
  const triggerThreshold = veryBullish ? 30 : 20;

  const v4h = a.l3['4h'].val, t4h = a.l3['4h'].trend;
  const fired4h = v4h < triggerThreshold && t4h === 'up';
  const armed4h = v4h < triggerThreshold && t4h !== 'up';
  const trCls   = fired4h ? 'tr-fired' : armed4h ? 'tr-armed' : 'tr-waiting';
  const trBadge = fired4h ? '★ FIRED' : armed4h ? (veryBullish ? 'ARMED · BULL' : 'ARMED') : 'WAITING';
  const bullNote = veryBullish ? ' · BULL MODE' : '';
  const trSub   = fired4h
    ? `below ${triggerThreshold} ✓ · turning ↑ ✓${bullNote}`
    : armed4h
    ? `below ${triggerThreshold} ✓ · waiting for ↑${bullNote}`
    : `needs value <${triggerThreshold} AND turning ↑`;
  // Plain English + technical for center column
  const trPlain = fired4h
    ? 'Trigger zone reached and turning up — entry signal!'
    : armed4h
    ? 'In the trigger zone — waiting for the upturn'
    : 'Waiting for this indicator to reach the trigger zone';
  const trTech = fired4h
    ? `4H proxy below ${triggerThreshold} <span class="tr-arrow tr-arrow-up">✓</span> · turning <span class="tr-arrow tr-arrow-up">↑</span> <span style="color:var(--green);font-weight:700">✓</span> · conditions met`
    : armed4h
    ? `4H proxy below ${triggerThreshold} <span style="color:var(--green);font-weight:700">✓</span> · waiting for <span class="tr-arrow tr-arrow-up">↑</span>`
    : `Needs 4H proxy below <strong>${triggerThreshold}</strong> AND turning <span class="tr-arrow tr-arrow-up">↑</span>`;
  const arrowCls = t4h==='up' ? 'tr-arrow tr-arrow-up' : 'tr-arrow tr-arrow-down';
  const arrowChar = t4h==='up' ? '↑' : '↓';
  const triggerRowHTML = `<div class="trigger-row ${trCls}">
    <div class="tr-lbl">4H ENTRY<br>TRIGGER${veryBullish?' ⚡':''}</div>
    <div class="tr-center">
      <div class="tr-plain">${trPlain}</div>
      <div class="tr-tech">${trTech}</div>
    </div>
    <div class="tr-right">
      <div class="tr-badge">${trBadge}</div>
      <div class="tr-val">${v4h.toFixed(1)} <span class="${arrowCls}">${arrowChar}</span></div>
    </div>
  </div>`;
  const tvSym=TV_SYMBOLS[ticker];
  const bnSym=BN_SYMBOLS[ticker];
  const cgSlug=CG_IDS[ticker];
  const tvBtn=tvSym?`<a class="chart-btn chart-tv" href="https://www.tradingview.com/chart/?symbol=${tvSym}&interval=240" target="_blank">📈 TradingView · 4H</a>`:'';
  const bnBtn=bnSym?`<a class="chart-btn chart-bn" href="https://www.binance.com/en/trade/${bnSym}" target="_blank">🟡 Binance Chart</a>`:'';
  const cgBtn=cgSlug?`<a class="chart-btn chart-cg" href="https://www.coingecko.com/en/coins/${cgSlug}" target="_blank">🦎 CoinGecko</a>`:'';
  const ohlcHtml=(a.high_24h!=null)?`<div class="ohlc-grid">
    <div class="ohlc-pill"><div class="ohlc-lbl">HIGH</div><div class="ohlc-val">${fmt(a.high_24h)}</div></div>
    <div class="ohlc-pill"><div class="ohlc-lbl">LOW</div><div class="ohlc-val">${fmt(a.low_24h)}</div></div>
    <div class="ohlc-pill"><div class="ohlc-lbl">OPEN</div><div class="ohlc-val">${fmt(a.open_24h)}</div></div>
    <div class="ohlc-pill"><div class="ohlc-lbl">CLOSE</div><div class="ohlc-val">${fmt(a.price)}</div></div>
  </div>`:'';
  const chartPopup=`<div class="chart-popup"><div class="chart-hint">OPEN CHART</div>${tvBtn}${bnBtn}${cgBtn}${ohlcHtml}</div>`;

  // Entry target row
  const tgt=getTarget(ticker);
  let targetBoxHTML,targetLblClass,targetHit=false;
  if(tgt===null||tgt===undefined){
    targetBoxHTML=`<span class="target-box target-unset">not set</span>`;
    targetLblClass='target-lbl';
  } else {
    const hitNow=a.price>0&&a.price<=tgt;
    targetHit=hitNow;
    if(hitNow){
      targetBoxHTML=`<span class="target-box target-green">${fmt(tgt)}</span> <span style="font-size:10px;color:var(--green);font-family:'Space Mono',monospace">🎯 TARGET HIT</span>`;
      targetLblClass='target-lbl hit';
    } else {
      targetBoxHTML=`<span class="target-box target-red">${fmt(tgt)}</span>`;
      targetLblClass='target-lbl';
    }
  }

  return`<div class="card${isHot?' hot-card':''}${targetHit?' target-hit-card':''}" data-ticker="${ticker}"
    draggable="true" ondragstart="onDragStart(event)" ondragover="onDragOver(event)"
    ondrop="onDrop(event)" ondragleave="onDragLeave(event)" ondragend="onDragEnd(event)">
    <div class="drag-handle" title="Drag to reorder">⠿</div>
        ${targetHit?'<div style="height:3px;background:linear-gradient(90deg,var(--green),#00ffaa);"></div>':'<div class="stripe stripe-'+sig+'"></div>'}
    <div class="card-head">
      <div class="ticker-row">
        <div class="ticker-left">
          <div class="ticker-wrap">
            <div class="ticker">${ticker}</div>
            ${chartPopup}
          </div>
          <div class="price">${fmt(a.price)}${chgStr}</div>
        </div>
        <div class="sig-wrap">
          ${getExtremeBadge(a)}
          <div class="sig-pill sig-${sig}">${SIG_DISPLAY[sig]||sig.replace('_',' ')}</div>
          ${sigTooltipHTML(sig)}
        </div>
      </div>
      <div class="fullname">${a.fullname}</div>
      <div class="badge-row">
        <span class="ma-badge" style="color:${maColor}">${maStr}</span>
        ${a.limited?'<span class="lim-badge">⚠ LIMITED HISTORY</span>':''}
        <div class="tier-group">
          ${isHot
          ? `<button class="hot-toggle hot-on" onclick="toggleHot('${ticker}',event)" title="Remove from Hot Cards">✕ HOT</button>`
          : `<button class="hot-toggle hot-off" onclick="toggleHot('${ticker}',event)" title="Add to Hot Cards">🔥 HOT</button>`
          }
          <span class="tier-badge" style="color:${ts.color};background:${ts.bg}">${tierLabel}</span>      </div>
    </div>
    </div>
    <div class="divider"></div>
    <div class="l1" style="display:flex;align-items:center;justify-content:space-between;">
      <div class="layer-title" style="color:var(--amber);margin-bottom:0;">
        <span class="layer-title-bar" style="background:var(--amber)"></span>
        LAYER 1 — MASTER GATE
      </div>
      <span class="l1-gate-pill ${l1PillCls}" id="l1-${ticker}">${l1PillTxt}</span>
    </div>
    <div class="l2">
      <div class="layer-title" style="color:var(--blue)">
        <span class="layer-title-bar" style="background:var(--blue)"></span>
        LAYER 2 — DIRECTION
      </div>
      ${l2rows}
      <div class="arr-legend">
        <span><span class="up">↑</span> rising (5d)</span>
        <span><span class="dn">↓</span> falling (5d)</span>
      </div>
    </div>
    <div class="l3">
      <div class="layer-title" style="color:var(--purple)">
        <span class="layer-title-bar" style="background:var(--purple)"></span>
        LAYER 3 — ENTRY PRECISION
      </div>
      <div class="l3-grid">${l3cells}</div>
    </div>
    ${triggerRowHTML}
    <div class="score-row">
      <div style="display:flex;align-items:center;gap:8px;">
        <div style="font-size:9px;font-family:'Space Mono',monospace;color:var(--label)">CONFLUENCE</div>
        <div class="dots">${dots}</div>
        <div style="font-size:10px;font-family:'Space Mono',monospace;color:var(--purple);font-weight:700">${score}/4</div>
      </div>
      ${stateTooltipHTML(l3st,score,a.l3)}
    </div>
    <div class="target-row${targetHit?' hit':''}">
      <span class="${targetLblClass}">ENTRY TARGET</span>
      <div class="target-right">
        ${targetBoxHTML}
        <button class="pencil-btn" title="Set entry target" onclick="toggleEditPopup('${ticker}')">✏️</button>
      </div>
    </div>
    <div class="edit-popup" id="ep-${ticker}">
      <div class="edit-popup-ttl">SET ENTRY TARGET</div>
      <div class="edit-popup-row">
        <input class="edit-input" id="ei-${ticker}" type="number" step="any" placeholder="e.g. 1.15"
          onkeydown="if(event.key==='Enter')commitTarget('${ticker}')">
        <button class="btn-set" onclick="commitTarget('${ticker}')">SET</button>
        <button class="btn-clr" onclick="clearTarget('${ticker}');toggleEditPopup('${ticker}')">✕</button>
      </div>
      <div class="edit-hint">Price will glow green when hit</div>
    </div>
    <div class="alert-row">${alert}</div>
    <button onclick="openAnalyze('${ticker}')" style="width:100%;padding:10px;background:rgba(85,153,255,0.08);
      border:none;border-top:1px solid rgba(85,153,255,0.15);cursor:pointer;
      font-family:'Space Mono',monospace;font-size:10px;font-weight:700;color:var(--blue);
      letter-spacing:1px;transition:all .15s;"
      onmouseover="this.style.background='rgba(85,153,255,0.16)'"
      onmouseout="this.style.background='rgba(85,153,255,0.08)'">
      ◎ ANALYSE
    </button>
  </div>`;
}

function commitTarget(ticker){
  const inp=document.getElementById('ei-'+ticker);
  if(!inp)return;
  const val=parseFloat(inp.value);
  if(isNaN(val)||val<=0){alert('Please enter a valid price.');return;}
  saveTargetToWorker(ticker, val);
  document.querySelectorAll('.edit-popup.open').forEach(e=>e.classList.remove('open'));
  renderAll();
}

// ── RENDER ──
function renderAll(){
  // Hot cards
  const hg=document.getElementById('hot-grid');
  const visHot=hotAssets.filter(t=>!hiddenAssets.includes(t));
  hg.innerHTML=visHot.length
    ? visHot.map(t=>buildCard(t,true)).join('')
    : `<div class="drop-zone" ondragover="event.preventDefault();this.classList.add('drag-active')"
        ondragleave="this.classList.remove('drag-active')"
        ondrop="onDropToHot(event)">DRAG A CARD HERE TO ADD TO HOT CARDS</div>`;

  // Tier grids
  const allTiers=['REFERENCE','CORE','TIER1','TIER2','WATCHLIST'];
  const allGrids={REFERENCE:'ref-grid',CORE:'core-grid',TIER1:'t1-grid',TIER2:'t2-grid',WATCHLIST:'watch-grid'};
  for(const tier of allTiers){
    const grid=document.getElementById(allGrids[tier]);
    if(!grid)continue;
    const cards=Object.keys(liveData)
      .filter(t=>liveData[t].tier===tier&&!hotAssets.includes(t)&&!hiddenAssets.includes(t));
    grid.innerHTML=cards.map(t=>buildCard(t,false)).join('');
  }
  updateSectionHeaders();
}

// ── GATE UI ──
function updateGateUI(g){
  const{total3,v1w,v2w,t1w,t2w}=g;
  const isConfirmed=v1w<mcatPrefs.floor&&v2w<mcatPrefs.floor;
  const isOpen=v1w<mcatPrefs.watch&&v2w<mcatPrefs.watch;
  const isWarnShort=v1w>mcatPrefs.extended||v2w>mcatPrefs.extended;
  currentGate={v1w,v2w,t1w,t2w,isOpen:isOpen||isConfirmed,isWarn:isWarnShort};

  document.getElementById('gate-led').className='gate-led '+(isConfirmed?'open':isOpen?'open':isWarnShort?'warning':'closed');
  const st=document.getElementById('gate-status-text');
  const stepNote = ' <span style="font-size:13px;color:#b0b0bc;font-family:\'Space Mono\',monospace;letter-spacing:0.5px;margin-left:18px;">(step 1 of 3 · see GUIDE for details)</span>';
  if(isConfirmed){st.innerHTML='✓✓ IN BUY ZONE'+stepNote;st.style.color='var(--green)';}
  else if(isOpen){st.innerHTML='✓ IN BUY ZONE'+stepNote;st.style.color='#4ade80';}
  else if(isWarnShort){st.innerHTML='OVERHEATED'+stepNote;st.style.color='var(--red)';}
  else{st.innerHTML='NOT YET — WAITING FOR BUY ZONE'+stepNote;st.style.color='var(--amber)';}

  document.getElementById('gate-1w').textContent=v1w.toFixed(1);
  document.getElementById('gate-2w').textContent=v2w.toFixed(1);
  document.getElementById('gate-1w-trend').innerHTML=`<span class="${t1w==='up'?'up':'dn'}">${t1w==='up'?'↑':'↓'}</span>`;
  document.getElementById('gate-2w-trend').innerHTML=`<span class="${t2w==='up'?'up':'dn'}">${t2w==='up'?'↑':'↓'}</span>`;

  const[cls1w,lbl1w]=subLabel(v1w);
  const[cls2w,lbl2w]=subLabel(v2w);
  const s1=document.getElementById('gate-1w-sub'),s2=document.getElementById('gate-2w-sub');
  s1.className='reading-sub '+cls1w;s1.textContent=lbl1w;
  s2.className='reading-sub '+cls2w;s2.textContent=lbl2w;
  if(total3)document.getElementById('gate-t3').textContent='$'+(total3/1e9).toFixed(0)+'B';

  let desc='';
  const fl=mcatPrefs.floor, wt=mcatPrefs.watch, ex=mcatPrefs.extended;
  if(isConfirmed) desc=`The altcoin market is at the deepest point in its cycle — this is the highest conviction buy window. In July 2024, a similar setup preceded a +100% altcoin market cap move. · Technical: 1W (${v1w.toFixed(1)}) and 2W (${v2w.toFixed(1)}) both confirmed below ${fl}.`;
  else if(isOpen) desc=`The buy zone is active — both indicators are below ${wt}. Good window to start building positions. Watching for deeper confirmation below ${fl}. · Technical: 1W (${v1w.toFixed(1)}) and 2W (${v2w.toFixed(1)}) both below ${wt}.`;
  else if(isWarnShort) desc=`⚠️ The market is overheated — not a buying zone. Consider taking profits or hedging. · Technical: 1W (${v1w.toFixed(1)}) or 2W (${v2w.toFixed(1)}) above ${ex}.`;
  else desc=`Nothing actionable right now — the market hasn't reached the buy zone yet. · Technical: 1W at ${v1w.toFixed(1)}, 2W at ${v2w.toFixed(1)}. Gate opens when both drop below ${wt}, confirmed below ${fl}.`;
  document.getElementById('gate-desc').innerHTML=desc.replace(' · Technical:','<br><span style="color:#b0b0bc;font-family:Space Mono,monospace;font-size:11px">Technical:') + (desc.includes('Technical:') ? '</span>' : '');
  document.getElementById('gate-updated').textContent='Updated '+new Date().toLocaleTimeString();
  // Update all card L1 pills
  const _pc=isConfirmed?'open':isOpen?'open':isWarnShort?'warn':'monitoring';
  const _pt=isConfirmed?'✓✓ IN BUY ZONE':isOpen?'✓ IN BUY ZONE':isWarnShort?'OVERHEATED':'NOT YET';
  document.querySelectorAll('[id^="l1-"]').forEach(el=>{
    el.className='l1-gate-pill '+_pc;
    el.textContent=_pt;
  });
  // Update context strip
  if (typeof updateContextStrip === 'function') updateContextStrip();
  if (typeof ctxTooltipInit === 'function') ctxTooltipInit();
}

// ── COINGECKO FETCH ──
async function fetchCGPrices(){
  const ids=Object.values(CG_IDS).join(',');
  const r=await fetch(cgUrl(`/simple/price?ids=${ids}&vs_currencies=usd`),{headers:cgHeaders()});
  if(!r.ok)throw new Error('CG prices '+r.status);
  return await r.json();
}
async function fetchCGHistory(cgId,days=500){
  const r=await fetch(cgUrl(`/coins/${cgId}/market_chart?vs_currency=usd&days=${days}&interval=daily`),{headers:cgHeaders()});
  if(!r.ok)throw new Error('CG hist '+cgId+' '+r.status);
  return (await r.json()).prices.map(p=>p[1]);
}
async function fetchCGGlobal(){
  const r=await fetch(cgUrl('/global'),{headers:cgHeaders()});
  if(!r.ok)throw new Error('CG global '+r.status);
  return (await r.json()).data;
}
async function computeTotal3Gate(){
  const g=await fetchCGGlobal();
  const total=g.total_market_cap.usd;
  const t3=total-total*g.market_cap_percentage.btc/100-total*g.market_cap_percentage.eth/100;
  const closes=TOTAL3_SEED.map(d=>d.total3);
  const today=new Date().toISOString().slice(0,10);
  if(TOTAL3_SEED[TOTAL3_SEED.length-1].date_str!==today)closes.push(t3);
  else closes[closes.length-1]=t3;
  const n1w=normRolling(calcDPO(closes,20));
  const n2w=normRolling(calcDPO(closes,40));
  return{total3:t3,v1w:Math.round(n1w[n1w.length-1]*10)/10,v2w:Math.round(n2w[n2w.length-1]*10)/10,
    t1w:trend(n1w),t2w:trend(n2w)};
}

// ── DRAG & DROP ──
let dragTicker=null;
function onDragStart(e){dragTicker=e.currentTarget.dataset.ticker;setTimeout(()=>e.currentTarget.classList.add('dragging'),0);e.dataTransfer.effectAllowed='move';}
function onDragEnd(e){e.currentTarget.classList.remove('dragging');}
function onDragOver(e){e.preventDefault();e.currentTarget.classList.add('drag-over');}
function onDragLeave(e){e.currentTarget.classList.remove('drag-over');}
function onDropToHot(e){
  e.preventDefault();e.currentTarget.classList.remove('drag-active');
  if(!dragTicker||hotAssets.includes(dragTicker))return;
  hotAssets.push(dragTicker);renderAll();
}
function onDrop(e){
  e.preventDefault();e.currentTarget.classList.remove('drag-over');
  const target=e.currentTarget.dataset.ticker;
  if(!dragTicker||dragTicker===target)return;
  const dragHot=hotAssets.includes(dragTicker),targetHot=hotAssets.includes(target);
  if(dragHot&&!targetHot){hotAssets=hotAssets.filter(t=>t!==dragTicker);}
  else if(!dragHot&&targetHot){if(!hotAssets.includes(dragTicker))hotAssets.push(dragTicker);}
  renderAll();dragTicker=null;
}
function toggleHot(ticker,e){
  e.stopPropagation();
  if(hotAssets.includes(ticker))hotAssets=hotAssets.filter(t=>t!==ticker);
  else hotAssets.push(ticker);
  renderAll();
}

// ── TIER HEADER TICKER UPDATE ──
const TIER_TICKER_IDS = {
  REFERENCE:'ref-tickers', CORE:'core-tickers',
  TIER1:'t1-tickers', TIER2:'t2-tickers', WATCHLIST:'watch-tickers'
};
function updateSectionHeaders(){
  for(const[tier,elId] of Object.entries(TIER_TICKER_IDS)){
    const el=document.getElementById(elId);
    if(!el)continue;
    const tickers=Object.keys(liveData)
      .filter(t=>liveData[t].tier===tier&&!hotAssets.includes(t)&&!hiddenAssets.includes(t));
    el.textContent=tickers.length?tickers.join(' · '):'— empty —';
  }
  const hotEl=document.getElementById('hot-tickers');
  if(hotEl)hotEl.textContent=hotAssets.filter(t=>!hiddenAssets.includes(t)).join(' · ')||'— empty —';
}

// ── MODAL STATE ──
let modalTier='WATCHLIST';
let modalTicker='';
let modalName='';
let modalSlug='';
let modalCSVData=null;
let modalSkipCSV=false;
const TIER_STYLES_MAP={"CORE": {"color": "var(--amber)", "bg": "rgba(255,170,0,0.15)", "label": "CORE"}, "TIER1": {"color": "var(--blue)", "bg": "rgba(85,153,255,0.12)", "label": "TIER 1"}, "TIER2": {"color": "var(--cyan)", "bg": "rgba(0,204,221,0.10)", "label": "TIER 2"}, "WATCHLIST": {"color": "var(--purple)", "bg": "rgba(176,136,255,0.15)", "label": "WATCHLIST"}, "REFERENCE": {"color": "#a09080", "bg": "rgba(122,112,96,0.15)", "label": "REFERENCE"}};

function tierStepLabel(tier,elId){
  const ts=TIER_STYLES_MAP[tier]||TIER_STYLES_MAP.WATCHLIST;
  return '<span id="'+elId+'" class="modal-step-label" style="background:'+ts.bg+';color:'+ts.color+'">ADDING TO '+ts.label+'</span>';
}
function openAddModal(tier){
  modalTier=tier; modalTicker=''; modalName=''; modalSlug=''; modalCSVData=null; modalSkipCSV=false;
  document.getElementById('inp-ticker').value='';
  document.getElementById('inp-name').value='';
  document.getElementById('inp-slug').value='';
  const res=document.getElementById('csv-result');
  if(res)res.style.display='none';
  const btn=document.getElementById('btn-add');
  if(btn)btn.disabled=true;
  ['modal-step-label','modal-step-label2','modal-step-label3'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){const tmp=document.createElement('div');tmp.innerHTML=tierStepLabel(tier,id);el.replaceWith(tmp.firstChild);}
  });
  showStep(1);
  document.getElementById('modal-overlay').classList.add('open');
}
function showStep(n){
  ['step1','step2','step3'].forEach((id,i)=>{
    document.getElementById(id).style.display=(i+1===n)?'':'none';
  });
}
function autoSlug(){
  const t=document.getElementById('inp-ticker').value.trim().toLowerCase();
  const known={hbar:'hedera-hashgraph',xdc:'xdce-crowd-sale',tao:'bittensor',
    aero:'aerodrome-finance',flr:'flare-networks',xlm:'stellar',qnt:'quant-network',
    xrp:'ripple',btc:'bitcoin',eth:'ethereum',algo:'algorand',iota:'iota',
    cc:'canton-network',zora:'zora',cro:'crypto-com-chain'};
  const slug=known[t]||t.replace(/[^a-z0-9]/g,'-');
  document.getElementById('inp-slug').value=slug;
  updateLinks();
}
function updateLinks(){
  const slug=document.getElementById('inp-slug').value.trim()||'your-coin';
  const ticker=document.getElementById('inp-ticker').value.trim().toUpperCase()||'COIN';
  const dl=document.getElementById('link-direct');
  const sl=document.getElementById('link-search');
  if(dl){dl.href='https://www.coingecko.com/en/coins/'+slug+'/historical_data';dl.textContent='coingecko.com/en/coins/'+slug+'/historical_data';}
  if(sl){sl.href='https://www.coingecko.com/en/search?query='+ticker;sl.textContent='coingecko.com/en/search?query='+ticker;}
}
function goStep1(){showStep(1);}
function goStep2(){
  const ticker=document.getElementById('inp-ticker').value.trim().toUpperCase();
  const name=document.getElementById('inp-name').value.trim();
  const slug=document.getElementById('inp-slug').value.trim().toLowerCase();
  if(!ticker){alert('Please enter a ticker symbol.');return;}
  if(!name){alert('Please enter the full asset name.');return;}
  if(!slug){alert('Please enter the CoinGecko slug.');return;}
  if(liveData[ticker]){alert(ticker+' is already on the dashboard.');return;}
  modalTicker=ticker; modalName=name; modalSlug=slug;
  updateLinks();
  showStep(2);
}
function goStep3(skip){
  modalSkipCSV=skip;
  if(skip){finalizeAdd();return;}
  const res=document.getElementById('csv-result');
  if(res)res.style.display='none';
  const btn=document.getElementById('btn-add');
  if(btn)btn.disabled=true;
  showStep(3);
}
function validateCSV(input){
  const file=input.files[0];
  if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    const rawText=e.target.result;
    const lines=rawText.trim().split('\n').filter(l=>l.trim());
    const header=lines[0].toLowerCase();
    const resultEl=document.getElementById('csv-result');
    resultEl.style.display='block';
    if(!header.includes('price')||(!header.includes('snapped_at')&&!header.includes('date'))){
      resultEl.className='csv-err';
      resultEl.innerHTML='❌ Invalid file format — expected CoinGecko CSV with date and price columns.<br>Please re-download from CoinGecko.';
      document.getElementById('btn-add').disabled=true;
      return;
    }
    const dataLines=lines.slice(1).filter(l=>l.trim());
    const rowCount=dataLines.length;
    function parseRow(line){
      const parts=line.split(',');
      return{date:parts[0]?parts[0].trim().slice(0,10):'?',price:parts[1]?parseFloat(parts[1]):null};
    }
    const first=parseRow(dataLines[0]);
    const last=parseRow(dataLines[dataLines.length-1]);
    const lastPrice=last.price;
    if(rowCount<30){
      resultEl.className='csv-err';
      resultEl.innerHTML='⚠️ Only '+rowCount+' rows found — very limited history.';
      document.getElementById('btn-add').disabled=true;
    } else {
      resultEl.className='csv-ok';
      resultEl.innerHTML=
        '<span style="color:var(--green)">✅ File looks good</span>\n\n'+
        'Rows:       '+rowCount+' daily closes\n'+
        'Date range: '+first.date+' → '+last.date+'\n'+
        'Last price: $'+(lastPrice?lastPrice.toFixed(6):'?')+'\n\n'+
        '<span style="color:var(--sub)">Verify last price matches CoinGecko current price.\nIf correct, click Add Card.</span>';
      modalCSVData={rawText, rowCount, firstDate:first.date, lastDate:last.date, lastPrice};
      document.getElementById('btn-add').disabled=false;
    }
  };
  reader.readAsText(file);
}
function finalizeAdd(){
  const tier=modalTier;
  const ticker=modalTicker;
  liveData[ticker]={
    fullname:modalName, tier:tier, hot:false,
    price:0, ma200_pct:null,
    limited:!modalCSVData||(modalCSVData&&modalCSVData.rowCount<200),
    nrows:modalCSVData?modalCSVData.rowCount:0,
    signal:'MONITOR', cgId:modalSlug,
    l2:{'1d':{val:50,trend:'flat'},'3d':{val:50,trend:'flat'},'1w':{val:50,trend:'flat'},'2w':{val:50,trend:'flat'}},
    l3:{'2h':{val:50,trend:'flat'},'4h':{val:50,trend:'flat'},'8h':{val:50,trend:'flat'},'12h':{val:50,trend:'flat'}},
    score:0, l3_state:'WAIT',
    alert:'⏳ Card added — fetching live data...',
    csvText:modalCSVData?modalCSVData.rawText:null,
  };
  CG_IDS[ticker]=modalSlug;
  closeModal();
  renderAll();
  updateSectionHeaders();
  fetchAndUpdateAsset(ticker);
}
function closeModal(){
  document.getElementById('modal-overlay').classList.remove('open');
}
function openModal(){openAddModal('TIER1');}

// ── MOVE MODAL ──
let moveTicker=null;
let moveDest=null;
const TIERS_MOVABLE=['CORE','TIER1','TIER2','WATCHLIST'];
const TIER_LABELS={CORE:'CORE',TIER1:'TIER 1',TIER2:'TIER 2',WATCHLIST:'WATCHLIST'};

function openMoveModal(sourceTier){
  moveTicker=null; moveDest=null;
  // Build asset list
  const list=document.getElementById('move-asset-list');
  const assets=Object.keys(liveData).filter(t=>liveData[t].tier===sourceTier);
  list.innerHTML=assets.map(t=>`<div class="modal-asset-chip" id="mchip-${t}" onclick="selectMoveAsset('${t}')">${t}</div>`).join('');
  // Build tier radios
  const radios=document.getElementById('move-tier-radios');
  radios.innerHTML=TIERS_MOVABLE.filter(t=>t!==sourceTier).map(t=>`
    <label style="display:flex;align-items:center;gap:10px;cursor:pointer;padding:8px 12px;
      background:var(--bg3);border:1px solid var(--border);border-radius:7px;transition:all .15s;"
      onclick="selectMoveDest('${t}');" id="mrad-${t}">
      <span style="font-family:'Space Mono',monospace;font-size:11px;color:#b0b0bc">${TIER_LABELS[t]}</span>
    </label>`).join('');
  document.getElementById('btn-confirm-move').disabled=true;
  document.getElementById('move-modal-overlay').classList.add('open');
}
function selectMoveAsset(ticker){
  moveTicker=ticker;
  document.querySelectorAll('#move-asset-list .modal-asset-chip').forEach(el=>{
    el.classList.toggle('sel',el.id==='mchip-'+ticker);
  });
  document.getElementById('btn-confirm-move').disabled=!(moveTicker&&moveDest);
}
function selectMoveDest(tier){
  moveDest=tier;
  document.querySelectorAll('#move-tier-radios label').forEach(el=>{
    const isThis=el.id==='mrad-'+tier;
    el.style.borderColor=isThis?'var(--blue)':'var(--border)';
    el.style.background=isThis?'rgba(85,153,255,0.1)':'var(--bg3)';
    el.querySelector('span').style.color=isThis?'var(--blue)':'#b0b0bc';
  });
  document.getElementById('btn-confirm-move').disabled=!(moveTicker&&moveDest);
}
function confirmMove(){
  if(!moveTicker||!moveDest)return;
  liveData[moveTicker].tier=moveDest;
  closeMoveModal();
  renderAll();
  updateSectionHeaders();
}
function closeMoveModal(){
  document.getElementById('move-modal-overlay').classList.remove('open');
}

// ── DELETE MODAL ──
let deleteSelected=[];
let deleteSourceTier=null;

function openDeleteModal(sourceTier){
  deleteSelected=[];
  deleteSourceTier=sourceTier;
  const list=document.getElementById('delete-asset-list');
  const assets=Object.keys(liveData).filter(t=>liveData[t].tier===sourceTier);
  list.innerHTML=assets.map(t=>`<div class="modal-asset-chip" id="dchip-${t}" onclick="toggleDeleteAsset('${t}')">${t}</div>`).join('');
  document.getElementById('delete-confirm-box').style.display='none';
  document.getElementById('btn-confirm-delete').disabled=true;
  document.getElementById('delete-modal-overlay').classList.add('open');
}
function toggleDeleteAsset(ticker){
  if(deleteSelected.includes(ticker)){
    deleteSelected=deleteSelected.filter(t=>t!==ticker);
  } else {
    deleteSelected.push(ticker);
  }
  document.querySelectorAll('#delete-asset-list .modal-asset-chip').forEach(el=>{
    el.classList.toggle('sel',deleteSelected.includes(el.id.replace('dchip-','')));
  });
  const box=document.getElementById('delete-confirm-box');
  const btn=document.getElementById('btn-confirm-delete');
  if(deleteSelected.length>0){
    box.style.display='block';
    box.innerHTML='⚠️ About to permanently delete:<br><br>'+deleteSelected.map(t=>`<strong style="color:var(--red)">${t}</strong> — ${liveData[t].fullname}`).join('<br>')+'<br><br>This cannot be undone.';
    btn.disabled=false;
    btn.textContent=`Delete ${deleteSelected.length} Asset${deleteSelected.length>1?'s':''}`;
  } else {
    box.style.display='none';
    btn.disabled=true;
    btn.textContent='Delete Selected';
  }
}
function confirmDelete(){
  deleteSelected.forEach(t=>{
    delete liveData[t];
    delete CG_IDS[t];
    hotAssets=hotAssets.filter(x=>x!==t);
    entryTargets[t]=null;
  });
  closeDeleteModal();
  renderAll();
  updateSectionHeaders();
}
function closeDeleteModal(){
  document.getElementById('delete-modal-overlay').classList.remove('open');
  deleteSelected=[];
}

// ── SETTINGS ──────────────────────────────────────────────────────────────────
// settingsOverrides: {ticker: {fullname, cgId, tv, bn}} — loaded from Worker/localStorage
let settingsOverrides = {};

function applySettingsOverrides() {
  for (const [ticker, ov] of Object.entries(settingsOverrides)) {
    if (!liveData[ticker]) continue;
    if (ov.fullname) liveData[ticker].fullname = ov.fullname;
    if (ov.cgId)     CG_IDS[ticker] = ov.cgId;
    if (ov.tv  !== undefined && ov.tv  !== null) TV_SYMBOLS[ticker] = ov.tv;
    if (ov.bn  !== undefined && ov.bn  !== null) BN_SYMBOLS[ticker] = ov.bn;
  }
}

async function loadSettingsFromWorker() {
  if (!PROXY_URL) return loadSettingsFromLocal();
  try {
    const r = await fetch(PROXY_URL + '?action=getSettings');
    if (!r.ok) throw new Error('status ' + r.status);
    const data = await r.json();
    settingsOverrides = data || {};
    saveSettingsToLocal(); // mirror locally
    applySettingsOverrides();
  } catch(e) {
    console.warn('Settings Worker fetch failed, using local:', e.message);
    loadSettingsFromLocal();
  }
}

async function loadTargetsFromWorker() {
  if (!PROXY_URL) return loadTargets();
  try {
    const r = await fetch(PROXY_URL + '?action=getTargets');
    if (!r.ok) throw new Error('status ' + r.status);
    const data = await r.json();
    entryTargets = data || {};
    saveTargets(); // mirror locally
  } catch(e) {
    console.warn('Targets Worker fetch failed, using local:', e.message);
    loadTargets();
  }
}

function saveSettingsToLocal() {
  try { localStorage.setItem('mcat_settings', JSON.stringify(settingsOverrides)); } catch(e) {}
}
function loadSettingsFromLocal() {
  try {
    const s = localStorage.getItem('mcat_settings');
    if (s) { settingsOverrides = JSON.parse(s); applySettingsOverrides(); }
  } catch(e) {}
}

async function saveSettingToWorker(ticker, fullname, cgId, tv, bn) {
  const payload = { ticker, fullname: fullname||null, cgId: cgId||null, tv: tv||null, bn: bn||null };
  if (!PROXY_URL) {
    settingsOverrides[ticker] = payload;
    saveSettingsToLocal();
    return true;
  }
  try {
    const r = await fetch(PROXY_URL + '?action=saveSetting', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    if (!r.ok) throw new Error('status ' + r.status);
    settingsOverrides[ticker] = payload;
    saveSettingsToLocal();
    return true;
  } catch(e) {
    console.warn('Save setting failed:', e.message);
    return false;
  }
}

async function saveTargetToWorker(ticker, price) {
  if (!PROXY_URL) { setTarget(ticker, price); return; }
  try {
    await fetch(PROXY_URL + '?action=setTarget', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ticker, price })
    });
    entryTargets[ticker] = price;
    saveTargets();
  } catch(e) {
    console.warn('Save target failed:', e.message);
    entryTargets[ticker] = price;
    saveTargets();
  }
}

// Settings modal UI
function openSettingsModal() {
  // Populate prefs tab
  populatePrefsForm();
  // Populate assets tab
  const tbody = document.getElementById('settings-tbody');
  const tickers = Object.keys(liveData).sort();
  tbody.innerHTML = tickers.map(t => {
    const ov = settingsOverrides[t] || {};
    const defFullname = liveData[t].fullname || '';
    const defCgId     = CG_IDS[t] || '';
    const defTv       = TV_SYMBOLS[t] || '';
    const defBn       = BN_SYMBOLS[t] || '';
    return `<tr>
      <td><span class="settings-ticker-lbl">${t}</span></td>
      <td><input class="settings-input" id="si-fn-${t}" type="text" value="${ov.fullname || defFullname}" placeholder="${defFullname}" oninput="markChanged(this)"></td>
      <td><input class="settings-input" id="si-cg-${t}" type="text" value="${ov.cgId || defCgId}" placeholder="${defCgId}" oninput="markChanged(this)"></td>
      <td><input class="settings-input" id="si-tv-${t}" type="text" value="${ov.tv !== null && ov.tv !== undefined ? ov.tv : defTv}" placeholder="${defTv||'e.g. XRPUSDT'}" oninput="markChanged(this)"></td>
      <td><input class="settings-input" id="si-bn-${t}" type="text" value="${ov.bn !== null && ov.bn !== undefined ? ov.bn : defBn}" placeholder="${defBn||'e.g. XRP_USDT'}" oninput="markChanged(this)"></td>
    </tr>`;
  }).join('');
  document.getElementById('settings-status').textContent = '';
  document.getElementById('settings-status').className = 'settings-status';
  document.getElementById('settings-modal-overlay').classList.add('open');
}

function markChanged(el) { el.classList.add('changed'); }

function closeSettingsModal() {
  document.getElementById('settings-modal-overlay').classList.remove('open');
}

// ── SETTINGS TAB SWITCHER ──
function switchSettingsTab(tab) {
  ['prefs','assets'].forEach(t => {
    document.getElementById('stab-'+t).classList.toggle('active', t===tab);
    document.getElementById('stab-'+t+'-btn').classList.toggle('active', t===tab);
  });
}

// ── PREFERENCES STATE ──
const PREF_DEFAULTS = {
  strategy:   'daily',
  bullMode:   false,
  floor:      20,
  watch:      25,
  extended:   80,
  trigger4h:  20,
  showWave:   true,
  showMA:     true,
  compact:    false,
  showRef:    true,
  refresh:    60,
  cgKey:      '',
  signalDate: '2026-02-13',
  rightTranslation: false
};
let mcatPrefs = { ...PREF_DEFAULTS };

function loadPrefsFromLocal() {
  try {
    const s = localStorage.getItem('mcat_prefs');
    if (s) { mcatPrefs = { ...PREF_DEFAULTS, ...JSON.parse(s) }; }
  } catch(e) {}
  applyPrefs();
}

function savePrefsToLocal() {
  try { localStorage.setItem('mcat_prefs', JSON.stringify(mcatPrefs)); } catch(e) {}
}

function applyPrefs() {
  // Strategy
  currentStrategy = mcatPrefs.strategy;
  ['daily','weekly','intraday'].forEach(s => {
    const el = document.getElementById('pstrat-'+s);
    if(el) el.classList.toggle('active', s === mcatPrefs.strategy);
  });
  // Bull mode — updates the global veryBullish-override flag
  window._bullModeOverride = mcatPrefs.bullMode;
  // Signal date + right translation sync
  if(mcatPrefs.signalDate) MQS_STATE.signalDate = mcatPrefs.signalDate;
  // Display toggles
  const waveEls = document.querySelectorAll('.wave-section');
  waveEls.forEach(el => el.style.display = mcatPrefs.showWave ? '' : 'none');
  const maEls = document.querySelectorAll('.ma-badge');
  maEls.forEach(el => el.style.display = mcatPrefs.showMA ? '' : 'none');
  const l3grids = document.querySelectorAll('.l3-grid');
  l3grids.forEach(el => el.style.display = mcatPrefs.compact ? 'none' : '');
  const refCards = document.querySelectorAll('.tier-reference');
  refCards.forEach(el => el.style.display = mcatPrefs.showRef ? '' : 'none');
  // Refresh interval
  if(window._refreshTimer) clearInterval(window._refreshTimer);
  if(mcatPrefs.refresh > 0) {
    window._refreshTimer = setInterval(() => { if(typeof fetchAllLive === 'function') fetchAllLive(); },
      mcatPrefs.refresh * 60 * 1000);
  }
}

function prefChanged() { /* marks form dirty — save btn stays enabled */ }

function setPrefStrategy(s) {
  mcatPrefs.strategy = s;
  currentStrategy = s;
  ['daily','weekly','intraday'].forEach(id => {
    const el = document.getElementById('pstrat-'+id);
    if(el) el.classList.toggle('active', id===s);
  });
}

function validateThresholds() {
  const floor    = parseInt(document.getElementById('pref-floor').value)    || 0;
  const watch    = parseInt(document.getElementById('pref-watch').value)    || 0;
  const extended = parseInt(document.getElementById('pref-extended').value) || 0;
  const t4h      = parseInt(document.getElementById('pref-4h').value)       || 0;
  const errEl    = document.getElementById('pref-thresh-err');
  const saveBtn  = document.getElementById('pref-save-btn');
  const valid    = floor < watch && watch < extended && t4h <= floor
                   && floor >= 10 && watch <= 35 && extended <= 95 && t4h >= 10;
  errEl.classList.toggle('visible', !valid);
  ['pref-floor','pref-watch','pref-extended','pref-4h'].forEach(id => {
    document.getElementById(id).classList.toggle('err', !valid);
  });
  saveBtn.disabled = !valid;
  return valid;
}

function populatePrefsForm() {
  document.getElementById('pref-floor').value         = mcatPrefs.floor;
  document.getElementById('pref-watch').value         = mcatPrefs.watch;
  document.getElementById('pref-extended').value      = mcatPrefs.extended;
  document.getElementById('pref-4h').value            = mcatPrefs.trigger4h;
  document.getElementById('pref-bull-mode').checked   = mcatPrefs.bullMode;
  document.getElementById('pref-show-wave').checked   = mcatPrefs.showWave;
  document.getElementById('pref-show-ma').checked     = mcatPrefs.showMA;
  document.getElementById('pref-compact').checked     = mcatPrefs.compact;
  document.getElementById('pref-show-ref').checked    = mcatPrefs.showRef;
  document.getElementById('pref-refresh').value       = mcatPrefs.refresh;
  document.getElementById('pref-cg-key').value        = mcatPrefs.cgKey || '';
  document.getElementById('pref-signal-date').value   = mcatPrefs.signalDate || '2026-02-13';
  document.getElementById('pref-right-trans').checked  = mcatPrefs.rightTranslation || false;
  document.getElementById('pref-right-trans-label').textContent = mcatPrefs.rightTranslation ? 'ON ✓' : 'OFF';
  setPrefStrategy(mcatPrefs.strategy);
  validateThresholds();
}

function savePreferences() {
  if (!validateThresholds()) return;
  mcatPrefs.strategy  = currentStrategy;
  mcatPrefs.bullMode  = document.getElementById('pref-bull-mode').checked;
  mcatPrefs.floor     = parseInt(document.getElementById('pref-floor').value);
  mcatPrefs.watch     = parseInt(document.getElementById('pref-watch').value);
  mcatPrefs.extended  = parseInt(document.getElementById('pref-extended').value);
  mcatPrefs.trigger4h = parseInt(document.getElementById('pref-4h').value);
  mcatPrefs.showWave  = document.getElementById('pref-show-wave').checked;
  mcatPrefs.showMA    = document.getElementById('pref-show-ma').checked;
  mcatPrefs.compact   = document.getElementById('pref-compact').checked;
  mcatPrefs.showRef   = document.getElementById('pref-show-ref').checked;
  mcatPrefs.refresh   = parseInt(document.getElementById('pref-refresh').value) || 0;
  mcatPrefs.cgKey     = document.getElementById('pref-cg-key').value.trim();
  mcatPrefs.signalDate = document.getElementById('pref-signal-date').value || '2026-02-13';
  mcatPrefs.rightTranslation = document.getElementById('pref-right-trans').checked;
  // Sync signal date to MQS_STATE
  MQS_STATE.signalDate = mcatPrefs.signalDate;
  savePrefsToLocal();
  applyPrefs();
  renderAll();
  const statusEl = document.getElementById('pref-status');
  statusEl.textContent = '✓ Saved';
  statusEl.className = 'settings-status ok';
  setTimeout(() => { statusEl.textContent = ''; statusEl.className = 'settings-status'; }, 2500);
}

function resetPreferences() {
  if (!confirm('Reset all preferences to defaults?')) return;
  mcatPrefs = { ...PREF_DEFAULTS };
  savePrefsToLocal();
  populatePrefsForm();
  applyPrefs();
  renderAll();
  const statusEl = document.getElementById('pref-status');
  statusEl.textContent = '✓ Reset to defaults';
  statusEl.className = 'settings-status ok';
  setTimeout(() => { statusEl.textContent = ''; statusEl.className = 'settings-status'; }, 2500);
}

async function saveAllSettings() {
  const tickers = Object.keys(liveData).sort();
  const statusEl = document.getElementById('settings-status');
  statusEl.textContent = 'Saving...';
  statusEl.className = 'settings-status';
  let errors = 0;

  for (const t of tickers) {
    const fnEl = document.getElementById('si-fn-'+t);
    const cgEl = document.getElementById('si-cg-'+t);
    const tvEl = document.getElementById('si-tv-'+t);
    const bnEl = document.getElementById('si-bn-'+t);
    if (!fnEl) continue;
    // Only save if something changed for this ticker
    const anyChanged = [fnEl,cgEl,tvEl,bnEl].some(el => el.classList.contains('changed'));
    if (!anyChanged) continue;
    const ok = await saveSettingToWorker(t, fnEl.value.trim(), cgEl.value.trim(), tvEl.value.trim(), bnEl.value.trim());
    if (ok) {
      [fnEl,cgEl,tvEl,bnEl].forEach(el => el.classList.remove('changed'));
    } else {
      errors++;
    }
  }

  // Re-apply all overrides to live runtime objects
  applySettingsOverrides();
  renderAll();

  if (errors === 0) {
    statusEl.textContent = '✓ All changes saved';
    statusEl.className = 'settings-status ok';
  } else {
    statusEl.textContent = `⚠ ${errors} failed — saved locally as fallback`;
    statusEl.className = 'settings-status err';
  }
}

// ── FETCH SINGLE ASSET ──
async function fetchAndUpdateAsset(ticker){
  const cgId=CG_IDS[ticker];
  if(!cgId)return;
  try{
    if(PROXY_URL){
      const days=365;
      const closes=await fetchCGHistory(cgId,days);
      if(closes.length<30)return;
      const price=closes[closes.length-1];
      liveData[ticker].price=price;
      if(closes.length>=200){
        const ma200=closes.slice(-200).reduce((a,b)=>a+b,0)/200;
        liveData[ticker].ma200_pct=Math.round((price-ma200)/ma200*100*10)/10;
      }
      const dpores=assetDPOs(closes);
      if(dpores){liveData[ticker].l2=dpores.l2;liveData[ticker].l3=dpores.l3;}
    } else {
      const url=cgUrl('/simple/price?ids='+cgId+'&vs_currencies=usd');
      const r=await fetch(url,{headers:cgHeaders()});
      if(!r.ok)return;
      const data=await r.json();
      if(data[cgId]&&data[cgId].usd)liveData[ticker].price=data[cgId].usd;
    }
    renderAll();
    updateSectionHeaders();
  }catch(ex){console.warn('fetchAndUpdateAsset '+ticker+':',ex.message);}
}

// ── MAIN REFRESH ──
// ── PIPELINE DATA FETCH (reads macro data from Cloudflare KV via Worker) ──
async function fetchPipelineData(){
  if(!PROXY_URL) return;
  try{
    const r = await fetch(PROXY_URL + '?action=getLiveData');
    if(!r.ok) throw new Error('Pipeline fetch: ' + r.status);
    const data = await r.json();
    if(!data || !data.macro) return;

    pipelineData = data;

    // Wire macro indicators into MQS_STATE
    const m = data.macro;
    if(m.vix && m.vix.value != null){
      MQS_STATE.vix = m.vix.value;
    }
    if(m.btc && m.btc.above_ma200 != null){
      MQS_STATE.btcAbove200ma = m.btc.above_ma200;
      MQS_STATE.btcMa200Pct = m.btc.pct_from_ma200 || 0;
    }
    if(m.spx){
      MQS_STATE.spxAbove200ma = m.spx.above_ma200 || false;
      MQS_STATE.spxMa200Pct = m.spx.pct_from_ma200 || 0;
      // Co-bottom = SPX below 200MA
      MQS_STATE.spxCoBottom = !m.spx.above_ma200;
    }
    if(m.usdjpy){
      MQS_STATE.yenUnwind = m.usdjpy.yen_unwind || false;
    }
    if(m.m2){
      MQS_STATE.m2Expanding = m.m2.expanding || false;
      MQS_STATE.m2Contracting = m.m2.contracting || false;
    }

    MQS_STATE.dataSource = 'LIVE';
    MQS_STATE.lastUpdated = data.last_updated;

    // Wire 1D/1W/2W DPO data into liveData from pipeline
    if(data.asset_dpo_1d){
      for(const [ticker, dpo] of Object.entries(data.asset_dpo_1d)){
        if(liveData[ticker] && dpo){
          if(!liveData[ticker].l2) liveData[ticker].l2 = {};
          // 1D DPO (period 7)
          if(dpo.value != null){
            if(!liveData[ticker].l2['1d']) liveData[ticker].l2['1d'] = {};
            liveData[ticker].l2['1d'].val = dpo.value;
            liveData[ticker].l2['1d'].pipeline = true;
          }
          // 1W DPO (period 20)
          if(dpo.dpo_1w != null){
            if(!liveData[ticker].l2['1w']) liveData[ticker].l2['1w'] = {};
            liveData[ticker].l2['1w'].val = dpo.dpo_1w;
            liveData[ticker].l2['1w'].pipeline = true;
          }
          // 2W DPO (period 40)
          if(dpo.dpo_2w != null){
            if(!liveData[ticker].l2['2w']) liveData[ticker].l2['2w'] = {};
            liveData[ticker].l2['2w'].val = dpo.dpo_2w;
            liveData[ticker].l2['2w'].pipeline = true;
          }
        }
      }
    }

    // Store swing signals from pipeline for direct access
    if(data.swing_signals){
      window._pipelineSwingSignals = data.swing_signals;
    }

    // Store BTC 1D DPO in macro
    if(m.btc_1d_dpo && m.btc_1d_dpo.value != null){
      MQS_STATE.btc1dDpo = m.btc_1d_dpo.value;
    }

    updateMqsDisplay();
    console.log('Pipeline data loaded:', data.mqs?.tier, 'VIX:', m.vix?.value,
      'BTC 1D DPO:', m.btc_1d_dpo?.value,
      'Swing signals:', Object.entries(data.swing_signals || {}).filter(([k,v]) => v.state?.startsWith('ACTIVE')).map(([k]) => k).join(',') || 'none');
  } catch(ex){
    console.warn('Pipeline fetch failed (using seed):', ex.message);
  }
}

// ── OHLC fetch — runs on chained timer, separate from main refresh ──
let _ohlcRunning = false;
async function fetchOHLC(){
  if(_ohlcRunning) return; // guard against overlap
  _ohlcRunning = true;
  console.log('OHLC fetch starting...');
  const cache = {};
  let ok = 0;
  for(const[ticker,cgId]of Object.entries(CG_IDS)){
    if(!liveData[ticker]) continue;
    try{
      await new Promise(r=>setTimeout(r,2000)); // 2s stagger
      const ohlcUrl = cgUrl('/coins/'+cgId+'/ohlc?vs_currency=usd&days=1');
      const res = await fetch(ohlcUrl, {headers:cgHeaders()});
      if(res.ok){
        const od = await res.json();
        if(od && od.length > 0){
          const high = Math.max(...od.map(c=>c[2]));
          const low = Math.min(...od.map(c=>c[3]));
          const open = od[0][1];
          liveData[ticker].high_24h = high;
          liveData[ticker].low_24h = low;
          liveData[ticker].open_24h = open;
          cache[ticker] = { high, low, open, ts: Date.now() };
          ok++;
        }
      }
    }catch(ex){ console.warn('OHLC '+ticker+':', ex.message); }
  }
  // Merge with existing cache (keep old values for assets that failed)
  try{
    const existing = JSON.parse(localStorage.getItem('mcat_ohlc_cache')||'{}');
    const merged = { ...existing, ...cache };
    localStorage.setItem('mcat_ohlc_cache', JSON.stringify(merged));
  }catch(ex){ console.warn('OHLC cache save:', ex.message); }
  console.log(`OHLC fetch done: ${ok}/${Object.keys(CG_IDS).length} updated`);
  _ohlcRunning = false;
}

async function refreshAll(silent=false){
  const ico=document.getElementById('refresh-ico');
  const dot=document.getElementById('status-dot');
  const stxt=document.getElementById('status-text');
  ico.classList.add('spinning');dot.className='status-dot fetching';stxt.textContent='Fetching...';
  let errors=0,updated=0;

  try{const g=await computeTotal3Gate();updateGateUI(g);}
  catch(ex){console.warn('TOTAL3:',ex.message);errors++;
    updateGateUI({total3:null,v1w:21.3,v2w:22.1,t1w:'down',t2w:'down'});}

  if(PROXY_URL){
    // ── FULL HISTORICAL MODE (proxy available) ──
    for(const[ticker,cgId]of Object.entries(CG_IDS)){
      try{
        stxt.textContent='Fetching '+ticker+'...';
        if(updated > 0) await new Promise(r=>setTimeout(r,2000)); // stagger CoinGecko calls
        const days=365;
        const closes=await fetchCGHistory(cgId,days);
        if(closes.length<30){errors++;continue;}
        const price=closes[closes.length-1];
        liveData[ticker].price=price;
        // Store last 90 days for Fibonacci calculations
        priceHistory[ticker] = closes.slice(-90);
        if(closes.length>=200){
          const ma200=closes.slice(-200).reduce((a,b)=>a+b,0)/200;
          liveData[ticker].ma200_pct=Math.round((price-ma200)/ma200*100*10)/10;
        }
        const dpores=assetDPOs(closes);
        if(dpores){liveData[ticker].l2=dpores.l2;liveData[ticker].l3=dpores.l3;}
        updated++;
      }catch(ex){console.warn(ticker+':',ex.message);errors++;}
    }
    // Fetch 24hr price change for all assets
    try{
      const ids=Object.values(CG_IDS).join(',');
      const chgUrl=cgUrl('/simple/price?ids='+ids+'&vs_currencies=usd&include_24hr_change=true');
      const chgR=await fetch(chgUrl,{headers:cgHeaders()});
      if(chgR.ok){
        const chgData=await chgR.json();
        for(const[ticker,cgId]of Object.entries(CG_IDS)){
          if(chgData[cgId]&&chgData[cgId].usd_24h_change!=null)
            liveData[ticker].price_change_24h=Math.round(chgData[cgId].usd_24h_change*10)/10;
        }
      }
    }catch(ex){console.warn('24hr change fetch:',ex.message);}
    // OHLC fetched separately via chained timer — see fetchOHLC()
    // Load cached OHLC from localStorage on first pass
    if(!window._ohlcLoaded){
      try{
        const cached=JSON.parse(localStorage.getItem('mcat_ohlc_cache')||'{}');
        for(const[ticker,d]of Object.entries(cached)){
          if(liveData[ticker]){
            liveData[ticker].high_24h=d.high;
            liveData[ticker].low_24h=d.low;
            liveData[ticker].open_24h=d.open;
          }
        }
        window._ohlcLoaded=true;
        console.log('OHLC loaded from cache');
      }catch(ex){console.warn('OHLC cache load:',ex.message);}
    }
    // Chain OHLC fetch 3 minutes after main refresh completes
    if(window._ohlcTimer) clearTimeout(window._ohlcTimer);
    window._ohlcTimer=setTimeout(()=>fetchOHLC(),180000);
  } else {
    // ── PRICE-ONLY MODE (no proxy) ──
    stxt.textContent='Fetching live prices...';
    try{
      const ids=Object.values(CG_IDS).join(',');
      const url=cgUrl('/simple/price?ids='+ids+'&vs_currencies=usd&include_24hr_change=true');
      const r=await fetch(url,{headers:cgHeaders()});
      if(!r.ok) throw new Error('price fetch '+r.status);
      const prices=await r.json();
      for(const[ticker,cgId]of Object.entries(CG_IDS)){
        if(!liveData[ticker])continue;
        const p=prices[cgId];
        if(p&&p.usd){
          liveData[ticker].price=p.usd;
          if(p.usd_24h_change!=null) liveData[ticker].price_change_24h=Math.round(p.usd_24h_change*10)/10;
          updated++;
        }
        else errors++;
      }
    }catch(ex){
      console.warn('Price fetch failed:',ex.message);
      errors+=Object.keys(CG_IDS).length;
    }
  }

  renderAll();

  // ── Update MQS_STATE from live BTC data ──
  if (liveData['BTC'] && liveData['BTC'].ma200_pct != null) {
    MQS_STATE.btcMa200Pct = liveData['BTC'].ma200_pct;
    MQS_STATE.btcAbove200ma = liveData['BTC'].ma200_pct > 0;
    if (updated > 0) MQS_STATE.dataSource = 'LIVE';
    updateMqsDisplay();
  }

  // ── Fetch macro data from pipeline (KV) ──
  await fetchPipelineData();
  if(MQS_STATE.dataSource === 'LIVE') updated = Math.max(updated, 1);

  ico.classList.remove('spinning');
  const now=new Date();
  dot.className=errors===0?'status-dot live':(updated>0?'status-dot stale':'status-dot error');
  if(errors===0){
    stxt.textContent='Live · '+now.toLocaleTimeString();
  } else if(updated===0){
    stxt.textContent='No live data — showing seed values';
    // Show the data warning banner
    const wb=document.getElementById('data-warning');
    if(wb)wb.style.display='flex';
  } else {
    stxt.textContent=updated+' live · '+errors+' using seed';
    const wb=document.getElementById('data-warning');
    if(wb){wb.style.display='flex';wb.querySelector('.dw-msg').textContent=errors+' asset(s) could not fetch live data and are showing seed values from Feb 21, 2026.';}
  }
  document.getElementById('footer-time').textContent='Last updated: '+now.toLocaleString();
  if(!silent)document.getElementById('loading-overlay').style.display='none';
  // Flash "MARKET CONDITIONS" label after overlay clears
  setTimeout(()=>{
    const msTitle = document.querySelector('.ms-title');
    if (msTitle) { msTitle.classList.remove('flash'); void msTitle.offsetWidth; msTitle.classList.add('flash'); }
  }, 100);
  // If all failed on first load, show warning immediately
  if(!silent && updated===0 && errors>0){
    const wb=document.getElementById('data-warning');
    if(wb)wb.style.display='flex';
  }
}


// ── ANALYSE ENGINE ──
let currentAnalyzeTicker = null;
let currentStrategy = 'daily';
const STRATEGY_LABELS = {
  weekly: 'Long-Term (Weekly) — check once a week, big picture only',
  daily: 'Small Timeframe (Daily) — check each morning, ~3 signals/month',
  intraday: 'Active Intraday — monitoring throughout the day for a specific trade'
};

function setStrategy(s, btn){
  currentStrategy = s;
  document.querySelectorAll('.strategy-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if(currentAnalyzeTicker){
    renderAnalyze(currentAnalyzeTicker);
    renderVerdict(currentAnalyzeTicker);
    renderNarrativeLayers(currentAnalyzeTicker);
    renderSwingSignal(currentAnalyzeTicker);
  }
}

function buildAnalyzeChartPopup(ticker, a){
  const popup = document.getElementById('an-chart-popup');
  if(!popup) return;
  const tvSym = TV_SYMBOLS[ticker];
  const bnSym = BN_SYMBOLS[ticker];
  const cgSlug = CG_IDS[ticker];
  const tvBtn = tvSym ? `<a class="chart-btn chart-tv" href="https://www.tradingview.com/chart/?symbol=${tvSym}&interval=240" target="_blank">📈 TradingView · 4H</a>` : '';
  const bnBtn = bnSym ? `<a class="chart-btn chart-bn" href="https://www.binance.com/en/trade/${bnSym}" target="_blank">🟡 Binance Chart</a>` : '';
  const cgBtn = cgSlug ? `<a class="chart-btn chart-cg" href="https://www.coingecko.com/en/coins/${cgSlug}" target="_blank">🦎 CoinGecko</a>` : '';
  const ohlcHtml = (a && a.high_24h != null) ? `<div class="ohlc-grid">
    <div class="ohlc-pill"><div class="ohlc-lbl">HIGH</div><div class="ohlc-val">${fmt(a.high_24h)}</div></div>
    <div class="ohlc-pill"><div class="ohlc-lbl">LOW</div><div class="ohlc-val">${fmt(a.low_24h)}</div></div>
    <div class="ohlc-pill"><div class="ohlc-lbl">OPEN</div><div class="ohlc-val">${fmt(a.open_24h)}</div></div>
    <div class="ohlc-pill"><div class="ohlc-lbl">CLOSE</div><div class="ohlc-val">${fmt(a.price)}</div></div>
  </div>` : '';
  popup.innerHTML = `<div class="chart-hint">OPEN CHART</div>${tvBtn}${bnBtn}${cgBtn}${ohlcHtml}`;
}

function openAnalyze(ticker){
  currentAnalyzeTicker = ticker;
  document.getElementById('analyze-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
  document.getElementById('an-ticker').textContent = ticker;
  const a = liveData[ticker];
  document.getElementById('an-price').textContent = a ? fmt(a.price) : '';
  // Build chart popup for header
  buildAnalyzeChartPopup(ticker, a);
  // Sync dropdown
  const sel = document.getElementById('an-asset-select');
  if(sel) sel.value = ticker;
  renderAnalyze(ticker);
  renderVerdict(ticker);
  renderNarrativeLayers(ticker);
  renderSwingSignal(ticker);
  renderFreshness();
}

function switchAnalyzeAsset(ticker){
  if(!liveData[ticker]) return;
  currentAnalyzeTicker = ticker;
  document.getElementById('an-ticker').textContent = ticker;
  document.getElementById('an-price').textContent = fmt(liveData[ticker].price);
  buildAnalyzeChartPopup(ticker, liveData[ticker]);
  renderAnalyze(ticker);
  renderVerdict(ticker);
  renderNarrativeLayers(ticker);
  renderSwingSignal(ticker);
}

function toggleLayer(n){
  document.getElementById('an-layer-'+n).classList.toggle('open');
}

function closeAnalyze(){
  document.getElementById('analyze-overlay').classList.remove('open');
  document.body.style.overflow = '';
  currentAnalyzeTicker = null;
}

// ── WAVE PANEL RENDERING ──
function generateWavePath(val, trend, timeframe){
  // Generate a realistic-looking wave path based on current value and trend
  // val: 0-100, trend: 'up'|'down'
  // Returns an SVG path string in a 320x50 viewBox
  // y=11 is extended zone (>80), y=38 is confirmed floor (<20), y=35.75 is watch zone (<25), y midpoint=24.5
  // Map val: 0->47, 50->24.5, 100->2 (inverted, high val = top of svg)
  const yNow = 47 - (val/100)*45; // current y position (right edge)

  // Generate wave history leading to current position
  // Number of full wave cycles shown depends on timeframe
  const cycles = {'2h':3,'4h':2.5,'8h':2,'12h':1.8,'1w':1.2,'2w':0.8}[timeframe]||2;
  const amplitude = {'2h':18,'4h':20,'8h':20,'12h':20,'1w':18,'2w':16}[timeframe]||18;

  // Build points: start at x=0, end at x=320 with current y
  const pts = [];
  const nPts = 12;
  for(let i=0;i<=nPts;i++){
    const t = i/nPts;
    const x = t*320;
    // Wave with slight drift toward current position
    const baseY = 24.5; // midpoint
    const wave = Math.sin(t * Math.PI * 2 * cycles) * amplitude;
    // Blend toward current y at end
    const blend = t * t; // quadratic blend
    const y = (1-blend)*(baseY + wave) + blend*yNow;
    pts.push([x, Math.max(3,Math.min(47,y))]);
  }

  // Build smooth cubic bezier path
  let d = `M${pts[0][0].toFixed(1)},${pts[0][1].toFixed(1)}`;
  for(let i=1;i<pts.length;i++){
    const p0=pts[i-1], p1=pts[i];
    const cpx = (p0[0]+p1[0])/2;
    d += ` C${cpx.toFixed(1)},${p0[1].toFixed(1)} ${cpx.toFixed(1)},${p1[1].toFixed(1)} ${p1[0].toFixed(1)},${p1[1].toFixed(1)}`;
  }
  return {path:d, yEnd:yNow};
}

function buildWaveRowHTML(tf, val, trend, opts={}){
  const {isTrigger=false, fired=false, armed=false, isCycle=false} = opts;
  const {path, yEnd} = generateWavePath(val, trend, tf);

  // Color
  let color, lblColor;
  if(isCycle){
    // 1W/2W: cyan normally, gold if >75 and rising
    color = (val>75&&trend==='up') ? '#ffd700' : '#00ccdd';
    lblColor = color;
  } else if(isTrigger){
    color = fired ? '#00dd88' : armed ? '#ffaa00' : '#888';
    lblColor = color;
  } else {
    // 2H/8H/12H: color by zone
    color = val<30 ? '#00dd88' : val>70 ? '#ff5050' : '#ffaa00';
    lblColor = color;
  }

  const label = tf.toUpperCase() + (isTrigger ? '★' : '');
  const arrCls = trend==='up' ? 'arr-up' : 'arr-dn';
  const arrSym = trend==='up' ? '↑' : '↓';

  // Glow for fired trigger
  const glowPath = (isTrigger && fired) ? `<path d="${path}" stroke="${color}" stroke-width="9" fill="none" opacity="0.1"/>` : '';
  // Ring for fired trigger
  const ring = (isTrigger && fired) ? `<circle cx="320" cy="${yEnd.toFixed(1)}" r="9" fill="none" stroke="${color}" stroke-width="1.5" opacity="0.35"/>` : '';
  const dotR = (isTrigger && fired) ? 5 : 4;

  return `<div class="wave-row">
  <div class="wave-lbl" style="color:${lblColor}">${label}</div>
  <div class="wave-track">
    <svg class="wave-svg" viewBox="0 0 320 50" preserveAspectRatio="none">
      <line x1="0" y1="35.75" x2="320" y2="35.75" stroke="#4ade80" stroke-dasharray="3,4" stroke-width="0.8" opacity="0.35"/>
      <line x1="0" y1="38" x2="320" y2="38" stroke="#00dd88" stroke-dasharray="4,3" stroke-width="1" opacity="0.55"/>
      <line x1="0" y1="11" x2="320" y2="11" stroke="#ff5050" stroke-dasharray="4,4" stroke-width="1.2" opacity="0.75"/>
      ${glowPath}
      <path d="${path}" stroke="${color}" stroke-width="${isTrigger&&fired?2.5:2.2}" fill="none" opacity="${isTrigger&&fired?1:0.85}"/>
      <circle cx="320" cy="${yEnd.toFixed(1)}" r="${dotR}" fill="${color}"/>
      ${ring}
    </svg>
  </div>
  <div class="wave-val" style="color:${lblColor}">${val.toFixed(1)}</div>
  <div class="wave-arr ${arrCls}">${arrSym}</div>
</div>`;
}

function renderWavePanel(ticker, a){
  const l2=a.l2, l3=a.l3;
  const g=currentGate;
  const v1w=l2['1w'].val,t1w=l2['1w'].trend;
  const v2w=l2['2w'].val,t2w=l2['2w'].trend;
  const v4h=l3['4h'].val,t4h=l3['4h'].trend;
  const v2h=l3['2h'].val,t2h=l3['2h'].trend;
  const v8h=l3['8h'].val,t8h=l3['8h'].trend;
  const v12h=l3['12h'].val,t12h=l3['12h'].trend;

  const veryBullish=v2w<20&&t2w==='up'&&t1w==='up';
  const trigThresh=veryBullish?30:20;
  const fired4h=v4h<trigThresh&&t4h==='up';
  const armed4h=v4h<trigThresh&&t4h!=='up';

  let html='';
  html+=buildWaveRowHTML('2h',v2h,t2h);
  html+=buildWaveRowHTML('4h',v4h,t4h,{isTrigger:true,fired:fired4h,armed:armed4h});
  html+=buildWaveRowHTML('8h',v8h,t8h);
  html+=buildWaveRowHTML('12h',v12h,t12h);
  html+='<div class="wave-divider"></div>';
  html+=buildWaveRowHTML('1w',g.v1w,g.t1w,{isCycle:true});
  html+=buildWaveRowHTML('2w',g.v2w,g.t2w,{isCycle:true});

  document.getElementById('an-wave-grid').innerHTML=html;
}

function renderAnalyze(ticker){
  const a = liveData[ticker];
  if(!a) return;

  const l2 = a.l2, l3 = a.l3;

  // ── WAVE PANEL ──
  renderWavePanel(ticker, a);

  const v1w = l2['1w'].val, t1w = l2['1w'].trend;
  const v2w = l2['2w'].val, t2w = l2['2w'].trend;
  const v3d = l2['3d'].val, t3d = l2['3d'].trend;
  const v1d = l2['1d'].val, t1d = l2['1d'].trend;
  const v4h = l3['4h'].val, t4h = l3['4h'].trend;
  const v2h = l3['2h'].val, t2h = l3['2h'].trend;

  // Market regime — bull mode can be forced via prefs or auto-detected
  const veryBullish = window._bullModeOverride || (v2w < mcatPrefs.floor && t2w === 'up' && t1w === 'up');
  const trigger4hThresh = veryBullish ? mcatPrefs.watch : mcatPrefs.trigger4h;
  const fired4h = v4h < trigger4hThresh && t4h === 'up';
  const armed4h = v4h < trigger4hThresh && t4h !== 'up';

  // ── NARRATIVE ──
  const regimeStr = veryBullish
    ? 'The 2W cycle is rising from below 20 — its strongest possible state, historically producing significant bull runs. '
    : v2w < 40 && t2w === 'up'
    ? 'The 2W cycle is rising from a low level, indicating a constructive market environment. '
    : v2w > 80
    ? 'The 2W cycle is elevated above 80 — this is the caution zone. '
    : '';

  const w1str = `The 1W cycle is at ${v1w.toFixed(0)} and ${t1w === 'up' ? 'rising' : 'falling'}`;
  const w2str = `the 2W cycle is at ${v2w.toFixed(0)} and ${t2w === 'up' ? 'rising' : 'falling'}`;
  const w1dstr = `The 1D cycle is at ${v1d.toFixed(0)} and ${t1d === 'up' ? 'rising' : 'falling'}`;
  const w4hstr = `the 4H trigger is at ${v4h.toFixed(0)} and ${t4h === 'up' ? 'turning upward' : 'still falling'}`;

  let triggerNarr = '';
  if(fired4h){
    triggerNarr = `The 4H entry trigger has FIRED — it dropped below ${trigger4hThresh} and reversed upward. This is the precise entry signal HK's system calls for. `;
  } else if(armed4h){
    triggerNarr = `The 4H trigger is ARMED — it's below ${trigger4hThresh} but hasn't reversed upward yet. The setup is loaded. Wait for the ↑ turn to confirm entry. `;
  } else {
    triggerNarr = `The 4H trigger is WAITING at ${v4h.toFixed(0)} — not yet at the entry zone. Watch for it to drop below ${trigger4hThresh} and reverse. `;
  }

  const stratSuffix = currentStrategy === 'weekly'
    ? 'For your weekly strategy, focus on the 1W and 2W cycle positions and ignore daily noise.'
    : currentStrategy === 'intraday'
    ? 'For active intraday trading, monitor the 4H and 2H closely throughout the session.'
    : 'For daily monitoring, check each morning and act when the 4H trigger fires.';

  const narrative = `${regimeStr}${w1str}, ${w2str}, confirming the medium-term trend direction. ${w1dstr}. ${triggerNarr}${stratSuffix}`;
  const narrativeEl = document.getElementById('an-narrative');
  if(narrativeEl) narrativeEl.textContent = narrative;

  // Bull market note
  const bullNoteEl = document.getElementById('an-bull-note');
  if(bullNoteEl){
    if(veryBullish && fired4h && v4h > 20){
      bullNoteEl.style.display = 'block';
      bullNoteEl.textContent = `⚡ Strong Bull Mode: The 4H trigger fired at ${v4h.toFixed(0)} without reaching 20. This is valid — when the 2W cycle rises from below 20 with 1W aligned, the market doesn't need a full reset before continuing higher. Historical precedent: same pattern in Nov 2024 and Jan 2021 both preceded significant rallies.`;
    } else {
      bullNoteEl.style.display = 'none';
    }
  }

  // ── CHECKLIST ──
  const checks = [
    {
      pass: v2w < mcatPrefs.floor && t2w === 'up',
      warn: v2w < mcatPrefs.watch,
      label: `2W Cycle at floor and rising`,
      detail: `2W is at ${v2w.toFixed(0)} and ${t2w === 'up' ? 'rising ↑' : 'falling ↓'}. Needs: below ${mcatPrefs.floor} and rising.`
    },
    {
      pass: t1w === 'up',
      warn: v1w < 40,
      label: '1W Cycle rising',
      detail: `1W is at ${v1w.toFixed(0)} and ${t1w === 'up' ? 'rising ↑ ✓' : 'falling ↓ — waiting for reversal'}.`
    },
    {
      pass: t3d === 'up',
      warn: v3d < 35,
      label: '3D Cycle rising',
      detail: `3D is at ${v3d.toFixed(0)} and ${t3d === 'up' ? 'rising ↑ ✓' : 'falling ↓'}.`
    },
    {
      pass: t1d === 'up',
      warn: v1d < 35,
      label: '1D Cycle rising or reversing',
      detail: `1D is at ${v1d.toFixed(0)} and ${t1d === 'up' ? 'rising ↑ ✓' : 'falling ↓ — waiting for turn'}.`
    },
    {
      pass: fired4h,
      warn: armed4h,
      label: `4H Trigger fired (below ${trigger4hThresh} + turning ↑)`,
      detail: `4H is at ${v4h.toFixed(0)}, ${t4h === 'up' ? 'turning ↑' : 'still falling ↓'}. Threshold: ${trigger4hThresh}${veryBullish ? ' (bull mode)' : ' (standard)'}.`
    },
    {
      pass: v2h < 25 && t2h === 'up',
      warn: v2h < 35,
      label: '2H Sub-daily Proxy reversing upward (confirmation)',
      detail: `2H proxy is at ${v2h.toFixed(0)} and ${t2h === 'up' ? 'rising ↑ ✓' : 'falling ↓'}. Used to confirm 4H signal.`
    }
  ];

  const passCount = checks.filter(c => c.pass).length;
  const warnCount = checks.filter(c => !c.pass && c.warn).length;

  const checkHTML = checks.map(c => {
    let cls, icon;
    if(c.pass){ cls = 'check-pass'; icon = '✅'; }
    else if(c.warn){ cls = 'check-warn'; icon = '⏳'; }
    else{ cls = 'check-fail'; icon = '⭕'; }
    return `<div class="check-row ${cls}">
      <div class="check-icon">${icon}</div>
      <div class="check-content">
        <div class="check-title">${c.label}</div>
        <div class="check-detail">${c.detail}</div>
      </div>
    </div>`;
  }).join('');

  document.getElementById('an-checklist').innerHTML = checkHTML;
  const pct = Math.round(passCount / checks.length * 100);
  document.getElementById('an-progress-label').textContent = `${passCount} of ${checks.length} conditions met`;
  const progHeader = document.getElementById('an-progress-header');
  if(progHeader) progHeader.textContent = `${passCount} of ${checks.length} met`;
  if(progHeader) progHeader.style.color = passCount >= checks.length ? 'var(--green)' : passCount >= 3 ? 'var(--amber)' : 'var(--sub)';
  document.getElementById('an-progress-bar').style.width = pct + '%';

  // ── ACTION ──
  const actionEl = document.getElementById('an-action');
  const actionLbl = document.getElementById('an-action-label');
  const actionTitle = document.getElementById('an-action-title');
  const actionSub = document.getElementById('an-action-sub');
  const actionDesc = document.getElementById('an-action-desc');
  const sig = a ? a.signal : '';
  const isConfirmedFloor = sig === 'ACCUMULATE_CONFIRMED';
  const isWatchFloor = sig === 'ACCUMULATE_WATCH';
  function getSubLine(fired4h, armed4h){
    if(isConfirmedFloor && fired4h) return 'Floor confirmed (<20) · 4H fired ↑ — all 3 layers aligned. Enter.';
    if(isConfirmedFloor && armed4h) return 'Floor confirmed (<20) · 4H at floor, waiting for ↑ turn — trigger imminent.';
    if(isConfirmedFloor) return 'Floor confirmed below 20 — only Layer 3 trigger remaining. Stay alert.';
    if(isWatchFloor && fired4h) return 'Watch zone active (<25) · 4H fired — partial signal. Await floor confirmation below 20.';
    if(isWatchFloor && armed4h) return 'Watch zone active (<25) · 4H armed — await both floor confirmation below 20 and ↑ turn.';
    if(isWatchFloor) return 'Entering the buy zone (<25) — need both indicators to confirm below 20 before full conviction.';
    if(sig==='EXTENDED') return 'Overheated — the cycle is stretched high. Not a buying zone. Consider reducing exposure and waiting for reset.';
    if(sig==='MONITOR') return 'Not yet — indicators are mid-range with no setup developing. Watch for them to drop toward 30.';
    return '';
  }

  if(v2w > 80 || v1w > 80){
    actionEl.className = 'analyze-action action-caution';
    actionLbl.textContent = 'CAUTION';
    actionTitle.textContent = 'NOT A BUY ZONE — CYCLE ELEVATED';
    actionSub.textContent = '';
    actionDesc.textContent = `The ${v2w > 80 ? '2W' : '1W'} cycle is above 80 — this is where HK recommends reducing exposure, not adding. Consider scaling out of existing positions. Wait for cycles to reset before looking for new entries.`;
  // Action thresholds: FIRED requires 4H trigger + >=4/6 checks (2W floor, 1W rising, 3D rising, 1D rising, 4H fired, 2H confirming)
  // ARMED requires >=3/6. DEVELOPING requires >=3/6 without armed. These are intentionally separate from checks.length
  // so adding new checks doesn't silently lower the bar — update these numbers deliberately if checks array changes.
  } else if(fired4h && passCount >= 4){
    actionEl.className = 'analyze-action action-fired';
    actionLbl.textContent = 'ACTION';
    actionTitle.textContent = '★ ENTRY SIGNAL ACTIVE';
    actionSub.textContent = getSubLine(true, false);
    actionDesc.textContent = `All major conditions are met. The 4H trigger has fired and upper cycles are aligned. This is the highest-confidence entry window. ${currentStrategy === 'weekly' ? 'For your weekly strategy, this is a valid entry point — size appropriately.' : currentStrategy === 'intraday' ? 'Monitor the 2H and 30M for precise entry timing within this window.' : 'Consider entering a position now. Set your exit target before entering.'}`;
  } else if(armed4h && passCount >= 3){
    actionEl.className = 'analyze-action action-armed';
    actionLbl.textContent = 'WAIT FOR ENTRY';
    actionTitle.textContent = 'ARMED — Waiting for 4H to turn ↑';
    actionSub.textContent = getSubLine(false, true);
    actionDesc.textContent = `Setup is loaded — the 4H is below ${trigger4hThresh} but hasn't reversed upward yet. Stay alert. The signal could fire in the next few candles. Don't chase — wait for the confirmed ↑ turn.`;
  } else if(passCount >= 3){
    actionEl.className = 'analyze-action action-armed';
    actionLbl.textContent = 'WATCH';
    actionTitle.textContent = 'DEVELOPING — Conditions Building';
    actionSub.textContent = getSubLine(false, false);
    actionDesc.textContent = `${passCount} of ${checks.length} conditions are met. The setup is building but not ready. Watch for the 4H trigger to reach below ${trigger4hThresh} as the final confirmation. Check back ${currentStrategy === 'weekly' ? 'next week' : currentStrategy === 'intraday' ? 'in a few hours' : 'tomorrow morning'}.`;
  } else {
    actionEl.className = 'analyze-action action-wait';
    actionLbl.textContent = 'WAIT';
    actionTitle.textContent = 'NOT YET — Monitor and Wait';
    actionSub.textContent = getSubLine(false, false);
    actionDesc.textContent = `Only ${passCount} of ${checks.length} conditions are met. The cycle isn't set up for a high-probability entry yet. ${v2w > 60 ? 'The 2W cycle needs to reset lower before an entry zone develops.' : 'Watch for the upper cycles to align as the market develops.'}`;
  }
}

// ── VERDICT CARD RENDERER ──
function renderVerdict(ticker){
  const a = liveData[ticker];
  if(!a) return;
  const mqs = getMqsTier();
  const tier = mqs.tier;
  const conf = computeConfidence();
  const isAlt = ticker !== 'BTC';
  const isBtc = ticker === 'BTC';

  // Cycle state
  const signalDate = new Date(MQS_STATE.signalDate);
  const today = new Date();
  const cycleDay = Math.floor((today - signalDate) / (1000*60*60*24));
  // Zone 2 = both 1W and 2W oscillators below 20 (the buy zone)
  const zoneOpen = a.l2['1w'].val < 20 && a.l2['2w'].val < 20;

  // 4H trigger state
  const v4h = a.l3['4h'].val, t4h = a.l3['4h'].trend;
  const veryBullish = window._bullModeOverride || (a.l2['2w'].val < mcatPrefs.floor && a.l2['2w'].trend === 'up' && a.l2['1w'].trend === 'up');
  const thresh4h = veryBullish ? mcatPrefs.watch : mcatPrefs.trigger4h;
  const fired4h = v4h < thresh4h && t4h === 'up';
  const armed4h = v4h < thresh4h && t4h !== 'up';
  const triggerState = fired4h ? 'FIRED' : armed4h ? 'ARMED' : 'WAITING';

  // Determine verdict
  const assetData = BACKTEST_TABLES.per_asset_post2022[ticker]?.[tier];
  const aggData = BACKTEST_TABLES.aggregate[tier];
  const hasHistory = assetData && assetData.n >= 3;
  const ev = hasHistory ? assetData.ev_90d : aggData.ev_90d;
  const hit = hasHistory ? assetData.hit_90d : aggData.hit_90d;

  let verdict = 'ACCUMULATE', verdictColor = 'green';
  if(!zoneOpen){ verdict = 'WAIT'; verdictColor = 'neutral'; }
  // Calm GREEN CAUTION only for alts — BTC in Calm GREEN is still positive (+155% EV)
  else if(isAlt && tier === 'GREEN' && mqs.rule === 7 && MQS_STATE.vix < 45){
    verdict = 'CAUTION'; verdictColor = 'amber';
  }
  else if(ev < 0){ verdict = 'CAUTION'; verdictColor = 'red'; }
  else if(tier === 'RED'){ verdictColor = 'amber'; }

  // Sizing
  let sizing;
  const confLevel = conf.score >= 3 ? 'conf_high' : 'conf_low';
  if(tier === 'GREEN' && MQS_STATE.vix >= 45){
    sizing = (isBtc ? BTC_SIZING : ALT_SIZING)['GREEN_CAP'];
  } else if(tier === 'GREEN'){
    sizing = (isBtc ? BTC_SIZING : ALT_SIZING)['GREEN_CALM'];
  } else {
    sizing = (isBtc ? BTC_SIZING : ALT_SIZING)[tier];
  }
  const sizingStr = sizing ? (sizing[confLevel] || sizing.low || '—') : '—';

  // Card color
  const card = document.getElementById('an-verdict-card');
  card.className = 'verdict-card verdict-' + tier.toLowerCase();

  // Title + subtitle
  const confLabel = conf.score >= 3 ? 'High' : conf.score >= 2 ? 'Moderate' : 'Low';
  document.getElementById('an-verdict-title').textContent = `${ticker} — ${verdict} (${confLabel} Confidence)`;
  document.getElementById('an-verdict-subtitle').textContent = `Suggested allocation: ${sizingStr} of intended position`;

  // Pills
  const tierPillCls = tier === 'RED' ? 'pill-red' : tier === 'AMBER' ? 'pill-amber' : 'pill-green';
  const zonePillCls = zoneOpen ? 'pill-green' : 'pill-neutral';
  const trigPillCls = triggerState === 'FIRED' ? 'pill-green' : triggerState === 'ARMED' ? 'pill-amber pill-pulse' : 'pill-neutral';

  document.getElementById('an-verdict-pills').innerHTML = `
    <div class="verdict-pill ${tierPillCls}">
      <div class="verdict-pill-label">TIER</div>
      <div class="verdict-pill-val">${tier}</div>
    </div>
    <div class="verdict-pill pill-neutral">
      <div class="verdict-pill-label">CYCLE DAY</div>
      <div class="verdict-pill-val">${cycleDay} of ${MQS_STATE.cycleLength}</div>
    </div>
    <div class="verdict-pill ${zonePillCls}">
      <div class="verdict-pill-label">ZONE 2</div>
      <div class="verdict-pill-val">${zoneOpen ? 'OPEN' : 'CLOSED'}</div>
    </div>
    <div class="verdict-pill ${trigPillCls}">
      <div class="verdict-pill-label">4H TRIGGER</div>
      <div class="verdict-pill-val">${triggerState}</div>
    </div>
    <div class="verdict-pill pill-neutral">
      <div class="verdict-pill-label">CONFIDENCE</div>
      <div class="verdict-pill-val">${conf.score} / ${conf.max}</div>
    </div>`;

  // Warnings
  const warnEl = document.getElementById('an-verdict-warning');
  const vix = MQS_STATE.vix;
  if(vix >= 18 && vix <= 22){
    warnEl.style.display = 'block';
    warnEl.className = 'verdict-warning warn-boundary';
    if(vix < 20){
      warnEl.textContent = `⚠️ VIX at ${vix.toFixed(1)} — near the 20 threshold. Tier may flip to RED if VIX closes above 20.`;
    } else {
      warnEl.textContent = `⚠️ VIX at ${vix.toFixed(1)} — near the 20 threshold. Tier may upgrade to AMBER if VIX closes below 20.`;
    }
  } else if(MQS_STATE.dataSource === 'SEED'){
    warnEl.style.display = 'block';
    warnEl.className = 'verdict-warning warn-stale';
    warnEl.textContent = '⚠️ Using seed data — macro indicators (VIX, SPX, M2) are not live. Connect the data pipeline for accurate readings.';
  } else {
    warnEl.style.display = 'none';
  }
}

function computeConfidence(){
  const a = liveData[currentAnalyzeTicker];
  const dpoBothBelow20 = a && a.l2['1w'].val < 20 && a.l2['2w'].val < 20;
  const rtConfirmed = mcatPrefs.rightTranslation || false;
  return {
    score: (dpoBothBelow20 ? 1 : 0) + (MQS_STATE.btcAbove200ma ? 1 : 0) + (MQS_STATE.spxAbove200ma ? 1 : 0) + (rtConfirmed ? 1 : 0),
    max: 4,
    components: {
      dpo_both_below_20: dpoBothBelow20,
      btc_above_200ma: MQS_STATE.btcAbove200ma,
      spx_above_200ma: MQS_STATE.spxAbove200ma,
      right_translation: rtConfirmed
    }
  };
}

// ── FIVE-LAYER NARRATIVE COMPOSER ──
function renderNarrativeLayers(ticker){
  const a = liveData[ticker];
  if(!a) return;
  const mqs = getMqsTier();
  const tier = mqs.tier;
  const isAlt = ticker !== 'BTC';
  const isBtc = ticker === 'BTC';
  const vix = MQS_STATE.vix;
  const btcPct = MQS_STATE.btcMa200Pct;
  const spxAbove = MQS_STATE.spxAbove200ma;
  const spxPct = MQS_STATE.spxMa200Pct;

  // Asset-specific data
  const assetData = BACKTEST_TABLES.per_asset_post2022[ticker]?.[tier];
  const aggData = BACKTEST_TABLES.aggregate[tier];
  const hasHistory = assetData && assetData.n >= 3;
  const ev = hasHistory ? assetData.ev_90d : aggData.ev_90d;
  const hit = hasHistory ? assetData.hit_90d : aggData.hit_90d;

  // Cycle info
  const signalDate = new Date(MQS_STATE.signalDate);
  const today = new Date();
  const cycleDay = Math.floor((today - signalDate) / (1000*60*60*24));
  // Zone 2 = both 1W and 2W oscillators below 20
  const zoneOpen = a.l2['1w'].val < 20 && a.l2['2w'].val < 20;
  const sigDateStr = signalDate.toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});

  // 4H state
  const v4h = a.l3['4h'].val, t4h = a.l3['4h'].trend;
  const veryBullish = window._bullModeOverride || (a.l2['2w'].val < mcatPrefs.floor && a.l2['2w'].trend === 'up' && a.l2['1w'].trend === 'up');
  const thresh4h = veryBullish ? mcatPrefs.watch : mcatPrefs.trigger4h;
  const fired4h = v4h < thresh4h && t4h === 'up';
  const armed4h = v4h < thresh4h && t4h !== 'up';

  // ── LAYER 1: Market Safety Gate ──
  let l1 = '';
  if(tier === 'RED'){
    l1 = `<p>Market conditions are cautious. The VIX (fear index) is at <strong>${vix.toFixed(1)}</strong>, and Bitcoin is <strong>${Math.abs(btcPct).toFixed(1)}% below</strong> its 200-day moving average, which means we're in a bearish regime for BTC.`;
    l1 += spxAbove
      ? ` The S&P 500 is healthy at <strong>${spxPct.toFixed(1)}% above</strong> its 200-day average — traditional markets are not confirming the crypto weakness.`
      : ` The S&P 500 is also stressed at <strong>${Math.abs(spxPct).toFixed(1)}% below</strong> its 200-day average — both stocks and crypto are selling off together.`;
    l1 += `</p><div class="narrative-highlight nh-red">In RED conditions since 2022, ${isAlt ? 'altcoins' : 'BTC'} ${hasHistory ? `${ticker} has returned an average of <strong>${ev.toFixed(1)}%</strong> over 90 days with a <strong>${hit}%</strong> success rate` : `have averaged <strong>${ev.toFixed(1)}%</strong> over 90 days with a <strong>${hit}%</strong> success rate`}.${ev < 10 ? ` This is modest — RED is not ${ticker}'s strongest environment.` : ''}${hit >= 80 ? ' Reliability is high despite the cautious environment.' : ''}</div>`;
  } else if(tier === 'AMBER'){
    l1 = `<p>Market conditions are moderately stressed but improving. `;
    if(mqs.rule === 6) l1 += `VIX is low at <strong>${vix.toFixed(1)}</strong>, but BTC remains <strong>${Math.abs(btcPct).toFixed(1)}% below</strong> its 200-day average — fear is contained but the bull cycle hasn't confirmed yet.`;
    else if(mqs.rule === 5) l1 += `VIX is elevated at <strong>${vix.toFixed(1)}</strong>, suggesting market fear, but conditions have not reached extreme levels.`;
    else l1 += `VIX is at <strong>${vix.toFixed(1)}</strong>. ${mqs.description}.`;
    l1 += `</p>`;
    if(isAlt){
      l1 += `<div class="narrative-highlight nh-amber"><strong>AMBER is historically the strongest environment for altcoin accumulation.</strong> Since 2022, altcoins in AMBER have delivered positive returns <strong>${BACKTEST_TABLES.alt_overlay.amber_alt_hit}%</strong> of the time. ${hasHistory ? `${ticker} specifically has averaged <strong>${ev.toFixed(1)}%</strong> over 90 days with a <strong>${hit}%</strong> success rate.` : `Aggregate altcoin performance: <strong>${aggData.ev_90d.toFixed(1)}%</strong> EV, <strong>${aggData.hit_90d}%</strong> hit rate.`}</div>`;
    } else {
      l1 += `<div class="narrative-highlight nh-amber">${hasHistory ? `BTC in AMBER has averaged <strong>${ev.toFixed(1)}%</strong> over 90 days with a <strong>${hit}%</strong> success rate.` : 'Moderate conditions for BTC accumulation.'}</div>`;
    }
  } else { // GREEN
    if(vix >= 45){
      l1 = `<p>This is a <strong>rare capitulation event</strong>. Extreme fear (VIX at <strong>${vix.toFixed(1)}</strong>) has historically produced the most powerful buying opportunities across all assets. This is the highest-conviction signal the system generates.</p>`;
      l1 += `<div class="narrative-highlight nh-green"><strong>Capitulation GREEN:</strong> Historical EV of <strong>+111.7%</strong> with <strong>100% hit rate</strong> across all observed events.</div>`;
    } else {
      l1 = `<p>Market conditions are calm — low fear (VIX at <strong>${vix.toFixed(1)}</strong>), BTC above its 200-day average. While this is traditionally labeled the best environment, there is an important caveat for altcoins.</p>`;
      if(isAlt){
        l1 += `<div class="narrative-highlight nh-amber"><strong>⚠️ Calm GREEN Warning for Altcoins:</strong> Since 2022, altcoin DPO cycle lows in calm markets have actually underperformed, averaging <strong>${BACKTEST_TABLES.alt_overlay.calm_green_alt_ev.toFixed(1)}%</strong> with only a <strong>${BACKTEST_TABLES.alt_overlay.calm_green_alt_hit}%</strong> success rate. These may be late-cycle pullbacks rather than genuine accumulation opportunities. Consider favoring BTC over alts, or reducing position sizes.</div>`;
      }
    }
  }
  document.getElementById('an-layer1-text').innerHTML = l1;

  // ── LAYER 2: The Cycle ──
  let l2 = `<p>${ticker}'s DPO cycle fired a buy signal on <strong>${sigDateStr}</strong>. We are currently on <strong>Day ${cycleDay}</strong> of the cycle.`;
  if(zoneOpen){
    l2 += ` The accumulation window (Zone 2) is <strong style="color:var(--green)">OPEN</strong> — both the 1W (${a.l2['1w'].val.toFixed(0)}) and 2W (${a.l2['2w'].val.toFixed(0)}) oscillators are below 20. Entries during Zone 2 historically capture the majority of the cycle's upside.</p>`;
  } else {
    l2 += ` The accumulation window (Zone 2) is <strong style="color:var(--sub)">CLOSED</strong> — the 1W and 2W oscillators have risen above 20. Zone 2 reopens when both drop back below 20.</p>`;
  }
  const v1w = a.l2['1w'].val, v2w = a.l2['2w'].val;
  l2 += `<p>Current readings: 1W at <strong>${v1w.toFixed(0)}</strong> (${a.l2['1w'].trend === 'up' ? '↑ rising' : '↓ falling'}), 2W at <strong>${v2w.toFixed(0)}</strong> (${a.l2['2w'].trend === 'up' ? '↑ rising' : '↓ falling'}).</p>`;
  document.getElementById('an-layer2-text').innerHTML = l2;

  // ── LAYER 3: The Trigger ──
  let l3 = '';
  if(fired4h){
    l3 = `<div class="narrative-highlight nh-green"><strong>4H Trigger has FIRED</strong> — the oscillator confirmed a reversal from oversold conditions. This is the highest-conviction entry signal. Historical data shows entries at FIRED status capture the most favorable risk/reward.</div>`;
    l3 += `<p>The 4H oscillator is at <strong>${v4h.toFixed(0)}</strong> and turning upward. Combined with aligned upper cycles, this is the precise entry signal HK's system calls for.</p>`;
  } else if(armed4h){
    l3 = `<div class="narrative-highlight nh-amber"><strong>4H Trigger is ARMED</strong> — the oscillator has crossed below ${thresh4h} and conditions are setting up for a reversal. Historically, ARMED status precedes the final low by 3–7 days.</div>`;
    l3 += `<p>The 4H is at <strong>${v4h.toFixed(0)}</strong> but hasn't reversed upward yet. You can begin building a small position now or wait for FIRED confirmation. The setup is loaded.</p>`;
  } else {
    l3 = `<p>The 4-hour trigger has <strong>not yet activated</strong>. The short-term oscillator is at <strong>${v4h.toFixed(0)}</strong>, still above the ${thresh4h} threshold. Wait for ARMED status before considering entry.</p>`;
    l3 += `<div class="narrative-highlight nh-blue">Watch for the 4H to drop below <strong>${thresh4h}</strong> — that signals the entry setup is loading. When it then turns upward (↑), the trigger fires.</div>`;
  }
  document.getElementById('an-layer3-text').innerHTML = l3;

  // ── LAYER 4: Asset Intelligence ──
  let l4 = '';
  if(hasHistory){
    const ad = assetData;
    l4 = `<p><strong>${ticker}</strong> performance in <strong>${tier}</strong> conditions (post-2022):</p>`;
    l4 += `<table class="perf-table"><thead><tr><th>METRIC</th><th>VALUE</th></tr></thead><tbody>`;
    l4 += `<tr><td>Expected return (90d)</td><td class="${ad.ev_90d >= 0 ? 'perf-pos' : 'perf-neg'}">${ad.ev_90d >= 0 ? '+' : ''}${ad.ev_90d.toFixed(1)}%</td></tr>`;
    l4 += `<tr><td>Success rate</td><td>${ad.hit_90d}%</td></tr>`;
    l4 += `<tr><td>Sample size</td><td>n=${ad.n}</td></tr>`;
    if(ad.worst != null) l4 += `<tr><td>Worst outcome</td><td class="perf-neg">${ad.worst}%</td></tr>`;
    if(ad.best != null) l4 += `<tr><td>Best outcome</td><td class="perf-pos">+${ad.best}%</td></tr>`;
    l4 += `</tbody></table>`;

    // Multi-horizon timing
    const mh = BACKTEST_TABLES.multi_horizon[tier];
    if(mh){
      l4 += `<p><strong>Typical path:</strong> `;
      if(tier === 'RED') l4 += `RED entries typically show flat or negative returns in the first 30-60 days (30d: ${mh.d30}%, 60d: ${mh.d60}%), then accelerate (90d: ${mh.d90}%). <strong>Patience is required.</strong>`;
      else if(tier === 'AMBER') l4 += `AMBER entries tend to deliver more immediate results (30d: +${mh.d30}%, 60d: +${mh.d60}%, 90d: +${mh.d90}%). Steady gains from the start.`;
      l4 += `</p>`;
    }
  } else {
    l4 = `<div class="narrative-highlight nh-amber"><strong>⚠️ Insufficient historical data</strong> — ${ticker} does not have enough backtested events for asset-specific analysis. Using aggregate altcoin performance.</div>`;
    l4 += `<table class="perf-table"><thead><tr><th>METRIC</th><th>AGGREGATE ALTS (${tier})</th></tr></thead><tbody>`;
    l4 += `<tr><td>Expected return (90d)</td><td class="${aggData.ev_90d >= 0 ? 'perf-pos' : 'perf-neg'}">${aggData.ev_90d >= 0 ? '+' : ''}${aggData.ev_90d.toFixed(1)}%</td></tr>`;
    l4 += `<tr><td>Success rate</td><td>${aggData.hit_90d}%</td></tr>`;
    l4 += `<tr><td>Sample size</td><td>n=${aggData.n}</td></tr>`;
    l4 += `</tbody></table>`;
  }

  // Peer comparison
  const peerRank = getPeerRanking(ticker, tier);
  if(peerRank) l4 += `<p>${peerRank}</p>`;
  document.getElementById('an-layer4-text').innerHTML = l4;

  // ── LAYER 5: Risk Context ──
  const conf = computeConfidence();
  const confLevel = conf.score >= 3 ? 'conf_high' : 'conf_low';
  let sizingObj;
  if(tier === 'GREEN' && vix >= 45) sizingObj = (isBtc ? BTC_SIZING : ALT_SIZING)['GREEN_CAP'];
  else if(tier === 'GREEN') sizingObj = (isBtc ? BTC_SIZING : ALT_SIZING)['GREEN_CALM'];
  else sizingObj = (isBtc ? BTC_SIZING : ALT_SIZING)[tier];
  const sizingStr = sizingObj ? (sizingObj[confLevel] || sizingObj.low || '—') : '—';

  let l5 = `<p><strong>Position sizing rationale:</strong> The suggested <strong>${sizingStr}</strong> allocation reflects <strong>${tier}</strong> conditions with <strong>${conf.score}/${conf.max}</strong> confidence points.`;
  if(conf.score < 3) l5 += ` Confidence is below maximum — consider staying toward the <strong>lower end</strong> of the sizing range.`;
  l5 += `</p>`;

  // Drawdown expectation
  const mh = BACKTEST_TABLES.multi_horizon[tier];
  if(mh && tier === 'RED'){
    l5 += `<p><strong>Expected drawdown:</strong> In RED conditions, entries typically experience flat or slightly negative returns (around <strong>${mh.d30}%</strong>) in the first 30 days before recovery begins at 60-90 days. This is normal and not a signal to sell.</p>`;
  }

  // VIX boundary
  if(vix >= 18 && vix <= 22){
    l5 += `<div class="narrative-highlight nh-amber">`;
    if(vix < 20){
      l5 += `<strong>VIX Boundary Alert:</strong> VIX is currently at ${vix.toFixed(1)}, near the 20 threshold. If VIX rises above 20, the tier will change to <strong>RED</strong>, which would reduce the recommended position size. Monitor this closely.`;
    } else {
      l5 += `<strong>VIX Boundary Alert:</strong> VIX is currently at ${vix.toFixed(1)}, near the 20 threshold. If VIX drops below 20, the tier will upgrade to <strong>AMBER</strong>, which would improve the outlook and increase recommended position sizing.`;
    }
    l5 += `</div>`;
  }

  // Confidence components
  l5 += `<p style="margin-top:10px;font-size:11px;color:var(--sub)"><strong>Confidence breakdown:</strong> `;
  l5 += `DPO both &lt;20: ${conf.components.dpo_both_below_20 ? '✅' : '⭕'} · `;
  l5 += `BTC above 200MA: ${conf.components.btc_above_200ma ? '✅' : '⭕'} · `;
  l5 += `SPX above 200MA: ${conf.components.spx_above_200ma ? '✅' : '⭕'} · `;
  l5 += `Right translation: ${conf.components.right_translation ? '✅ confirmed' : '⏳ pending (toggle in Settings)'}</p>`;

  document.getElementById('an-layer5-text').innerHTML = l5;
}

function getPeerRanking(ticker, tier){
  const peers = BACKTEST_TABLES.per_asset_post2022;
  const ranked = [];
  for(const [t, data] of Object.entries(peers)){
    if(data[tier] && data[tier].n >= 3){
      ranked.push({ticker: t, ev: data[tier].ev_90d});
    }
  }
  if(ranked.length < 2) return null;
  ranked.sort((a,b) => b.ev - a.ev);
  const myIdx = ranked.findIndex(r => r.ticker === ticker);
  const top3 = ranked.slice(0, 3).map(r => `${r.ticker} (+${r.ev.toFixed(1)}%)`).join(', ');
  if(myIdx >= 0){
    return `In the current ${tier} environment, the strongest historical performers are: <strong>${top3}</strong>. ${ticker} ranks <strong>#${myIdx+1}</strong> of ${ranked.length} tracked assets.`;
  }
  return `In the current ${tier} environment, the strongest historical performers are: <strong>${top3}</strong>.`;
}

// ── SWING SIGNAL RENDERER ──
function renderSwingSignal(ticker){
  const layer = document.getElementById('an-swing-layer');
  const tag = document.getElementById('an-swing-tag');
  const status = document.getElementById('an-swing-status');
  const content = document.getElementById('an-swing-content');
  if(!layer || !content) return;

  const a = liveData[ticker];
  if(!a || !a.l2) { content.innerHTML = '<span style="color:var(--sub)">No data available</span>'; return; }

  // Get 1D DPO value (from seed data)
  const v1d = a.l2['1d'] ? a.l2['1d'].val : null;
  if(v1d === null) { content.innerHTML = '<span style="color:var(--sub)">1D DPO data not available</span>'; return; }

  // BTC 1D DPO
  const btc = liveData['BTC'];
  const btc1d = btc && btc.l2 && btc.l2['1d'] ? btc.l2['1d'].val : null;
  const btcCobottom = btc1d !== null && btc1d < 20;

  // MQS tier
  const mqs = getMqsTier();
  const tier = mqs.tier;
  const isGreen = tier === 'GREEN';
  const inBuyZone = v1d < 20;

  // Exit rule
  const exitRule = SWING_EXIT_RULES[ticker] || 'fixed-14';
  const isTrend = exitRule.startsWith('trend');
  const exitLabel = isTrend ? 'TRENDING — hold until 1D DPO > 80' : exitRule === 'fixed-21' ? 'INTERMEDIATE — take profit at 21 days' : 'FAST EXIT — take profit at 14 days';

  // Backtest data
  const bt = SWING_BACKTEST[ticker] || null;
  const cob = SWING_BTC_COBOTTOM[ticker] || null;

  // Determine state
  let state, conf;
  if(!inBuyZone){
    state = 'INACTIVE';
    conf = null;
  } else if(isGreen){
    state = 'BLOCKED';
    conf = null;
  } else if(btcCobottom){
    state = 'ACTIVE_HIGH';
    conf = 'HIGH';
  } else {
    state = 'ACTIVE_STD';
    conf = 'STANDARD';
  }

  // Tag styling
  if(state === 'INACTIVE'){
    tag.className = 'swing-layer-tag tag-inactive';
    status.style.color = 'var(--sub)';
    status.textContent = 'INACTIVE';
    layer.classList.remove('open');
  } else if(state === 'BLOCKED'){
    tag.className = 'swing-layer-tag tag-blocked';
    status.style.color = 'var(--amber)';
    status.textContent = 'BLOCKED';
    layer.classList.remove('open');
  } else if(state === 'ACTIVE_HIGH'){
    tag.className = 'swing-layer-tag tag-active';
    status.style.color = 'var(--green)';
    status.textContent = 'HIGH CONF ✓';
    layer.classList.add('open');
  } else {
    tag.className = 'swing-layer-tag tag-active';
    status.style.color = 'var(--purple)';
    status.textContent = 'STANDARD';
    layer.classList.add('open');
  }

  // Build HTML
  let html = '';
  function row(key, val, cls){ return `<div class="swing-row"><span class="swing-key">${key}</span><span class="swing-val ${cls}">${val}</span></div>`; }

  if(state === 'INACTIVE'){
    html += row('1D DPO', `${v1d.toFixed(1)} — not in buy zone`, 'swing-val-neutral');
    html += `<div class="swing-highlight sh-neutral">No swing signal. The 1D cycle is mid-range at ${v1d.toFixed(0)}. Watch for 1D DPO to drop below 20 to activate.</div>`;
  } else if(state === 'BLOCKED'){
    html += row('1D DPO', `${v1d.toFixed(1)} — IN BUY ZONE ✓`, 'swing-val-green');
    html += row('MQS GATE', `${tier} ✗ — swing blocked`, 'swing-val-amber');
    html += `<div class="swing-highlight sh-amber"><strong>Signal active but blocked.</strong> The 1D DPO is in the buy zone at ${v1d.toFixed(0)}, but MQS is GREEN — swing signals are skipped in calm markets. The research shows these are often late-cycle pullbacks rather than genuine opportunities. Wait for AMBER/RED conditions or use the accumulation signal instead.</div>`;
  } else {
    // ACTIVE (HIGH or STANDARD)
    html += row('1D DPO', `${v1d.toFixed(1)} — IN BUY ZONE ✓`, 'swing-val-green');
    if(btc1d !== null){
      html += row('BTC 1D DPO', btcCobottom ? `${btc1d.toFixed(1)} — CO-BOTTOMING ✓` : `${btc1d.toFixed(1)} — not confirming`, btcCobottom ? 'swing-val-green' : 'swing-val-amber');
    }
    html += row('MQS GATE', `${tier} ✓`, 'swing-val-green');
    html += row('CONFIDENCE', conf === 'HIGH' ? 'HIGH — BTC confirming' : 'STANDARD — BTC not co-bottoming', conf === 'HIGH' ? 'swing-val-purple' : 'swing-val-neutral');
    html += row('EXIT RULE', exitLabel, 'swing-val-white');

    const sizing = conf === 'HIGH' ? 'Full position' : 'Half position';
    const sizingCls = conf === 'HIGH' ? 'swing-val-green' : 'swing-val-amber';
    // HBAR reduced sizing
    const isHbar = ticker === 'HBAR';
    html += row('SIZING', isHbar ? 'Reduced (see warning)' : sizing, isHbar ? 'swing-val-amber' : sizingCls);

    // Narrative highlight
    const evStr = bt ? `Historical 14d EV: +${bt.ev14}%, hit rate: ${bt.hit14}%.` : '';
    const exitNarr = isTrend ? `This is a trending asset — hold until 1D DPO crosses above 80 rather than a fixed exit.` : `This is a fast-exit asset — take profit at ${exitRule === 'fixed-21' ? '21' : '14'} days.`;
    if(conf === 'HIGH'){
      html += `<div class="swing-highlight sh-green"><strong>SWING ENTRY — HIGH CONFIDENCE.</strong> ${ticker}'s 1D cycle is oversold while BTC confirms. ${tier} tier allows swing trades. ${evStr} ${exitNarr}</div>`;
    } else {
      html += `<div class="swing-highlight sh-amber"><strong>SWING ENTRY — standard confidence.</strong> ${ticker}'s 1D cycle is oversold but BTC is not confirming. Consider half-size position. ${evStr}</div>`;
    }

    // EV grid
    if(bt){
      html += `<div class="swing-ev-grid">
        <div class="swing-ev-card"><div class="swing-ev-label">7-DAY EV</div><div class="swing-ev-val" style="color:${bt.ev7 > 0 ? 'var(--green)' : 'var(--red)'}">+${bt.ev7}%</div></div>
        <div class="swing-ev-card"><div class="swing-ev-label">14-DAY EV</div><div class="swing-ev-val" style="color:${bt.ev14 > 0 ? 'var(--green)' : 'var(--red)'}">+${bt.ev14}%</div></div>
        <div class="swing-ev-card"><div class="swing-ev-label">HIT RATE</div><div class="swing-ev-val" style="color:${bt.hit14 >= 65 ? 'var(--green)' : 'var(--amber)'}">${bt.hit14}%</div></div>
      </div>`;
    }

    // HBAR warning
    if(isHbar){
      html += `<div class="hbar-swing-warning">⚠️ <strong>HBAR Quality Warning:</strong> HBAR accumulation signals have historically underperformed. The 1D swing signal works (+2.7% avg at 14d) but is below average. Consider reduced sizing.</div>`;
    }
  }

  content.innerHTML = html;
}

// ── DATA FRESHNESS RENDERER ──
function renderFreshness(){
  const dot = document.getElementById('an-freshness-dot');
  const text = document.getElementById('an-freshness-text');
  if(!dot || !text) return;

  if(pipelineData && pipelineData.last_updated){
    const updated = new Date(pipelineData.last_updated);
    const ageHours = (Date.now() - updated.getTime()) / (1000*60*60);
    if(ageHours < 24){
      dot.className = 'freshness-dot fresh';
      text.textContent = `Live · Updated ${updated.toLocaleString()} · VIX: Yahoo Finance · Crypto: CoinGecko`;
    } else if(ageHours < 48){
      dot.className = 'freshness-dot stale';
      text.textContent = `Stale — last updated ${updated.toLocaleString()}. Consider refreshing.`;
    } else {
      dot.className = 'freshness-dot outdated';
      text.innerHTML = `<strong>DATA OUTDATED</strong> — last updated ${updated.toLocaleString()}. Refresh required.`;
    }
  } else {
    dot.className = 'freshness-dot';
    dot.style.background = 'var(--blue)';
    text.innerHTML = `Data source: <span class="freshness-seed">SEED</span> (hardcoded) · Connect the data pipeline for live macro readings`;
  }
}

// ── PRICE TARGETS ENGINE ──
function openTargets(){
  if(!currentAnalyzeTicker) return;
  const ticker = currentAnalyzeTicker;
  const a = liveData[ticker];
  document.getElementById('targets-overlay').classList.add('open');
  document.getElementById('tg-ticker').textContent = ticker;
  document.getElementById('tg-price').textContent = a ? fmt(a.price) : '';
  renderTargets(ticker);
}

function closeTargets(){
  document.getElementById('targets-overlay').classList.remove('open');
}

function renderTargets(ticker){
  const a = liveData[ticker];
  if(!a || !a.price) return;

  const price = a.price;
  const hist = priceHistory[ticker];

  // ── SWING HIGH/LOW from 90-day history ──
  let swingLow = price, swingHigh = price;
  if(hist && hist.length >= 30){
    const window90 = hist.slice(-90);
    swingLow = Math.min(...window90);
    swingHigh = Math.max(...window90);
  }

  document.getElementById('tg-swing-low').textContent = fmt(swingLow);
  document.getElementById('tg-swing-high').textContent = fmt(swingHigh);
  document.getElementById('tg-current').textContent = fmt(price);

  const range = swingHigh - swingLow;
  const pctFromLow = range > 0 ? (price - swingLow) / range : 0.5;

  // ── FIBONACCI EXTENSIONS (upside from low→high) ──
  const fib1272up = swingLow + range * 1.272;
  const fib1618up = swingLow + range * 1.618;
  const fib2618up = swingLow + range * 2.618;

  // ── FIBONACCI RETRACEMENTS (downside from high→low) ──
  const fib382dn = swingHigh - range * 0.382;
  const fib500dn = swingHigh - range * 0.500;
  const fib618dn = swingHigh - range * 0.618;

  // ── PREVIOUS CYCLE HIGH/LOW (simplified: 1.5x and 0.7x of swing) ──
  const prevCycleRes = swingHigh * 1.05; // approximate prior resistance
  const bearLine = swingLow * 0.85;      // approximate bear market support

  // ── BUILD UPSIDE TARGETS ──
  const upTargets = [
    { price: fib1272up, tags: ['FIB 1.272'], dist: pctStr(price, fib1272up) },
    { price: fib1618up, tags: ['FIB 1.618'], dist: pctStr(price, fib1618up) },
    { price: fib2618up, tags: ['FIB 2.618'], dist: pctStr(price, fib2618up) },
    { price: prevCycleRes, tags: ['PREV HIGH ZONE'], dist: pctStr(price, prevCycleRes) }
  ].filter(t => t.price > price)
   .sort((a,b) => a.price - b.price);

  // ── BUILD DOWNSIDE TARGETS ──
  const dnTargets = [
    { price: fib382dn, tags: ['FIB 0.382'], dist: pctStr(price, fib382dn) },
    { price: fib500dn, tags: ['FIB 0.500'], dist: pctStr(price, fib500dn) },
    { price: fib618dn, tags: ['FIB 0.618'], dist: pctStr(price, fib618dn) },
    { price: bearLine, tags: ['BEAR LINE'], dist: pctStr(price, bearLine) }
  ].filter(t => t.price < price)
   .sort((a,b) => b.price - a.price);

  // Check confluence (within 3% of each other)
  function addConfluence(targets){
    return targets.map((t, i) => {
      const near = targets.filter((t2, j) => j !== i && Math.abs(t2.price - t.price)/t.price < 0.03);
      const conf = near.length >= 2 ? 'high' : near.length === 1 ? 'med' : null;
      return {...t, conf};
    });
  }

  const upWithConf = addConfluence(upTargets);
  const dnWithConf = addConfluence(dnTargets);

  // ── RENDER UPSIDE ──
  document.getElementById('tg-upside').innerHTML = upWithConf.slice(0,4).map(t => `
    <div class="target-item target-up">
      <div class="target-price">${fmt(t.price)}</div>
      <div class="target-tags">
        ${t.tags.map(tag => `<span class="target-tag tag-fib">${tag}</span>`).join('')}
      </div>
      ${t.conf === 'high' ? '<span class="confluence-badge conf-high">★ HIGH</span>' :
        t.conf === 'med'  ? '<span class="confluence-badge conf-med">◆ MED</span>' : ''}
      <div class="target-dist">${t.dist}</div>
    </div>`).join('');

  // ── RENDER DOWNSIDE ──
  document.getElementById('tg-downside').innerHTML = dnWithConf.slice(0,4).map(t => `
    <div class="target-item target-dn">
      <div class="target-price">${fmt(t.price)}</div>
      <div class="target-tags">
        ${t.tags.map(tag => `<span class="target-tag tag-fib">${tag}</span>`).join('')}
      </div>
      ${t.conf === 'high' ? '<span class="confluence-badge conf-high">★ HIGH</span>' :
        t.conf === 'med'  ? '<span class="confluence-badge conf-med">◆ MED</span>' : ''}
      <div class="target-dist">${t.dist}</div>
    </div>`).join('');

  // ── TIMING NOTE ──
  const l2 = a.l2;
  const v1w = l2['1w'].val, v2w_v = l2['2w'].val;
  const cyclePhase = v1w < 20 ? 'early — significant upside window likely ahead'
    : v1w < 50 ? 'mid-cycle — upside targets active, monitor for exhaustion above 80'
    : v1w > 80 ? 'elevated — begin scaling out as targets are reached'
    : 'advancing toward cycle peak';

  document.getElementById('tg-timing').innerHTML = `
    <strong>Cycle timing context:</strong> The 1W cycle is at ${v1w.toFixed(0)} — ${cyclePhase}. 
    Upside targets are most reliable when entered from below and confirmed by the 4H trigger firing. 
    Begin scaling out of positions when price reaches the first target zone AND the 1D cycle crosses above 80. 
    <br><br><strong>Note:</strong> Price targets shown use 90-day Fibonacci extensions. 
    Confluence zones (★ HIGH) where two or more methods agree are the highest-probability reaction points.`;
}

function pctStr(from, to){
  const pct = ((to - from) / from * 100);
  return (pct > 0 ? '+' : '') + pct.toFixed(1) + '%';
}

// Price history store (populated during fetch)
const priceHistory = {};

// ── INIT ──
window.addEventListener('load',async()=>{
  loadPrefsFromLocal();           // load prefs first — thresholds needed before renderAll
  initFromSeed();
  await loadSettingsFromWorker();
  await loadTargetsFromWorker();
  renderAll();
  updateSectionHeaders();
  updateGateUI({total3:811722971449,v1w:21.3,v2w:22.1,t1w:'down',t2w:'down'});
  updateMqsDisplay();  // Wire MQS_STATE → all 5 display surfaces
  await refreshAll(false);
});
// Refresh interval now controlled by mcatPrefs.refresh — set in applyPrefs() on load

// ── Context strip tooltip positioning ──
function ctxTooltipInit() {
  document.querySelectorAll('.ctx-seg').forEach(seg => {
    const tt = seg.querySelector('.ctx-tt');
    if (!tt) return;
    let hideTimer = null;

    function showTT() {
      clearTimeout(hideTimer);
      document.querySelectorAll('.ctx-tt').forEach(t => t.style.display = 'none');
      const rect = seg.getBoundingClientRect();
      tt.style.display = 'block';
      const ttRect = tt.getBoundingClientRect();
      let left = rect.left + (rect.width / 2) - (ttRect.width / 2);
      if (left < 12) left = 12;
      if (left + ttRect.width > window.innerWidth - 12) {
        left = window.innerWidth - ttRect.width - 12;
      }
      tt.style.left = left + 'px';
      tt.style.top = (rect.bottom + 10) + 'px';
    }

    function hideTT() {
      hideTimer = setTimeout(() => { tt.style.display = 'none'; }, 250);
    }

    seg.addEventListener('mouseenter', showTT);
    seg.addEventListener('mouseleave', hideTT);
    tt.addEventListener('mouseenter', () => clearTimeout(hideTimer));
    tt.addEventListener('mouseleave', hideTT);
  });
}
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', ctxTooltipInit);
} else {
  setTimeout(ctxTooltipInit, 100);
}

</script>


<!-- ── ANALYSE OVERLAY ── -->
<div class="analyze-overlay" id="analyze-overlay">
  <div class="analyze-back">
    <button class="analyze-back-btn" onclick="closeAnalyze()">← BACK TO DASHBOARD</button>
    <div class="analyze-header-center">
      <div class="ticker-wrap" style="padding-bottom:0;">
        <span class="analyze-asset-id" id="an-ticker"></span>
        <div class="chart-popup" id="an-chart-popup"></div>
      </div>
      <span class="analyze-asset-price" id="an-price"></span>
    </div>
    <div class="analyze-header-right"></div>
  </div>
  <div class="analyze-body">

    <!-- Strategy Selector (kept from original) -->
    <div class="analyze-strategy-wrap">
      <div class="analyze-strategy-label">STRATEGY MODE</div>
      <div class="strategy-btns">
        <button class="strategy-btn" data-strategy="weekly" onclick="setStrategy('weekly',this)">LONG-TERM · Weekly</button>
        <button class="strategy-btn active" data-strategy="daily" onclick="setStrategy('daily',this)">SMALL TF · Daily ★</button>
        <button class="strategy-btn" data-strategy="intraday" onclick="setStrategy('intraday',this)">ACTIVE · Intraday</button>
      </div>
    </div>

    <!-- SECTION 1: THE VERDICT (above the fold) -->
    <div class="verdict-card" id="an-verdict-card">
      <div class="verdict-header">
        <select class="verdict-asset-select" id="an-asset-select" onchange="switchAnalyzeAsset(this.value)">
          <optgroup label="CORE">
            <option value="XRP">XRP</option>
            <option value="QNT">QNT</option>
            <option value="TAO">TAO</option>
            <option value="CC">CC</option>
          </optgroup>
          <optgroup label="TIER 1">
            <option value="XLM">XLM</option>
            <option value="HBAR">HBAR</option>
            <option value="XDC">XDC</option>
            <option value="ALGO">ALGO</option>
            <option value="IOTA">IOTA</option>
            <option value="AERO">AERO</option>
          </optgroup>
          <optgroup label="TIER 2">
            <option value="FLR">FLR</option>
          </optgroup>
          <optgroup label="REFERENCE">
            <option value="BTC">BTC</option>
            <option value="ETH">ETH</option>
          </optgroup>
        </select>
        <div>
          <div class="verdict-title" id="an-verdict-title">Loading…</div>
          <div class="verdict-subtitle" id="an-verdict-subtitle"></div>
        </div>
      </div>
      <div class="verdict-pills" id="an-verdict-pills"></div>
      <div class="verdict-warning" id="an-verdict-warning" style="display:none"></div>
    </div>

    <!-- Checklist (kept from original) -->
    <div class="narrative-layer" id="an-checklist-layer">
      <div class="narrative-layer-header" onclick="document.getElementById('an-checklist-layer').classList.toggle('open')">
        <span class="narrative-layer-num" style="background:rgba(0,221,136,0.12);color:var(--green);">✓</span>
        <span class="narrative-layer-title">Entry Conditions</span>
        <span id="an-progress-header" style="font-size:11px;font-family:'Courier New',monospace;font-weight:700;color:#b0b0bc;">0 of 6 met</span>
        <span class="narrative-layer-chevron">▾</span>
      </div>
      <div class="narrative-layer-body">
        <div id="an-checklist"></div>
        <div class="checklist-progress">
          <div class="progress-label" id="an-progress-label">0 of 6 conditions met</div>
          <div class="progress-bar-wrap">
            <div class="progress-bar-fill" id="an-progress-bar" style="width:0%"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Action (kept from original) -->
    <div class="analyze-action" id="an-action">
      <div class="action-label" id="an-action-label">ACTION</div>
      <div class="action-title" id="an-action-title">Loading…</div>
      <div class="action-sub" id="an-action-sub"></div>
      <div class="action-desc" id="an-action-desc"></div>
    </div>

    <!-- Wave Panel (collapsible, starts open) -->
    <div class="wave-panel-wrap open" id="an-wave-panel">
      <div class="wave-panel-title" onclick="document.getElementById('an-wave-panel').classList.toggle('open')" style="cursor:pointer;">
        <span class="wpt-left">CYCLE POSITIONS</span>
        <span style="display:flex;align-items:center;gap:12px;">
          <span class="wpt-right">SHORT → LONG</span>
          <span class="wave-panel-chevron">▾</span>
        </span>
      </div>
      <div class="wave-panel-body">
        <div class="wave-grid" id="an-wave-grid"><!-- populated by renderAnalyze --></div>
        <div class="wave-legend">
        <div class="legend-item">
          <div class="legend-line" style="border-top:1.5px dashed rgba(0,221,136,0.6)"></div>
          FLOOR &lt;20
        </div>
        <div class="legend-item">
          <div class="legend-line" style="border-top:1.5px dashed rgba(74,222,128,0.45)"></div>
          WATCH &lt;25
        </div>
        <div class="legend-item">
          <div class="legend-line" style="border-top:1.5px dashed rgba(255,80,80,0.9)"></div>
          EXTENDED &gt;80
        </div>
        <div class="legend-item" style="margin-left:auto;color:var(--green)">
          ★ = 4H trigger
        </div>
      </div>
      </div>
    </div>

    <!-- SECTION 2: THE WHY — Five-Layer Narrative -->
    <div id="an-narrative-layers">
      <!-- Layer 1: Market Safety Gate -->
      <div class="narrative-layer" id="an-layer-1">
        <div class="narrative-layer-header" onclick="toggleLayer(1)">
          <span class="narrative-layer-num nl-1">L1</span>
          <span class="narrative-layer-title">Market Safety Gate (MQS Tier)</span>
          <span class="narrative-layer-chevron">▾</span>
        </div>
        <div class="narrative-layer-body">
          <div class="narrative-text" id="an-layer1-text">Loading…</div>
        </div>
      </div>

      <!-- Layer 2: The Cycle -->
      <div class="narrative-layer" id="an-layer-2">
        <div class="narrative-layer-header" onclick="toggleLayer(2)">
          <span class="narrative-layer-num nl-2">L2</span>
          <span class="narrative-layer-title">The Cycle — Why Now</span>
          <span class="narrative-layer-chevron">▾</span>
        </div>
        <div class="narrative-layer-body">
          <div class="narrative-text" id="an-layer2-text">Loading…</div>
        </div>
      </div>

      <!-- Layer 3: The Trigger -->
      <div class="narrative-layer" id="an-layer-3">
        <div class="narrative-layer-header" onclick="toggleLayer(3)">
          <span class="narrative-layer-num nl-3">L3</span>
          <span class="narrative-layer-title">The Trigger — Precision Timing</span>
          <span class="narrative-layer-chevron">▾</span>
        </div>
        <div class="narrative-layer-body">
          <div class="narrative-text" id="an-layer3-text">Loading…</div>
        </div>
      </div>

      <!-- Layer 4: Asset Intelligence -->
      <div class="narrative-layer" id="an-layer-4">
        <div class="narrative-layer-header" onclick="toggleLayer(4)">
          <span class="narrative-layer-num nl-4">L4</span>
          <span class="narrative-layer-title">Asset Intelligence — Historical Performance</span>
          <span class="narrative-layer-chevron">▾</span>
        </div>
        <div class="narrative-layer-body">
          <div class="narrative-text" id="an-layer4-text">Loading…</div>
        </div>
      </div>

      <!-- Layer 5: Risk Context -->
      <div class="narrative-layer" id="an-layer-5">
        <div class="narrative-layer-header" onclick="toggleLayer(5)">
          <span class="narrative-layer-num nl-5">L5</span>
          <span class="narrative-layer-title">Risk Context — Position Sizing</span>
          <span class="narrative-layer-chevron">▾</span>
        </div>
        <div class="narrative-layer-body">
          <div class="narrative-text" id="an-layer5-text">Loading…</div>
        </div>
      </div>
    </div>

    <!-- Swing Signal -->
    <div class="swing-layer" id="an-swing-layer">
      <div class="swing-layer-header" onclick="document.getElementById('an-swing-layer').classList.toggle('open')">
        <span class="swing-layer-tag" id="an-swing-tag">SWING</span>
        <span class="swing-layer-title">Swing Signal (1D Cycle)</span>
        <span class="swing-layer-status" id="an-swing-status">INACTIVE</span>
        <span class="swing-layer-chevron">▾</span>
      </div>
      <div class="swing-layer-body" id="an-swing-body">
        <div id="an-swing-content">Loading…</div>
      </div>
    </div>

    <!-- Price Targets Button -->
    <button class="btn-price-targets" onclick="openTargets()">
      <div class="bpt-left">
        <div class="bpt-title">Price Targets →</div>
        <div class="bpt-sub">FIBONACCI · CONFLUENCE · SUPPORT ZONES</div>
      </div>
      <div class="bpt-arrow">›</div>
    </button>

    <!-- SECTION 3: DATA FRESHNESS FOOTER -->
    <div class="data-freshness" id="an-freshness">
      <span class="freshness-dot" id="an-freshness-dot"></span>
      <span id="an-freshness-text">Data source: SEED (hardcoded)</span>
    </div>

  </div>
</div>

<!-- ── PRICE TARGETS OVERLAY ── -->
<div class="targets-overlay" id="targets-overlay">
  <div class="analyze-back">
    <button class="analyze-back-btn" onclick="closeTargets()">← Back to Analysis</button>
    <span class="analyze-asset-id" id="tg-ticker"></span>
    <span class="analyze-asset-price" id="tg-price"></span>
  </div>
  <div class="targets-body">

    <!-- Swing Basis -->
    <div class="swing-basis" id="tg-swing-basis">
      <div class="swing-item">
        <div class="swing-item-label">SWING LOW (90D)</div>
        <div class="swing-item-val swing-low-val" id="tg-swing-low">—</div>
      </div>
      <div class="swing-item">
        <div class="swing-item-label">SWING HIGH (90D)</div>
        <div class="swing-item-val swing-high-val" id="tg-swing-high">—</div>
      </div>
      <div class="swing-item">
        <div class="swing-item-label">CURRENT PRICE</div>
        <div class="swing-item-val swing-current-val" id="tg-current">—</div>
      </div>
    </div>

    <!-- Upside targets -->
    <div class="targets-section-label">▲ UPSIDE TARGETS</div>
    <div id="tg-upside"></div>

    <!-- Downside targets -->
    <div class="targets-section-label">▼ DOWNSIDE SUPPORT</div>
    <div id="tg-downside"></div>

    <!-- Timing note -->
    <div class="timing-note" id="tg-timing"></div>

  </div>
</div>

<div id="loading-overlay" style="position:fixed;inset:0;background:rgba(20,20,20,0.88);z-index:999;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;">
  <div style="width:34px;height:34px;border:3px solid #2e2e2e;border-top-color:var(--amber);
    border-radius:50%;animation:spin .8s linear infinite;"></div>
  <div style="font-family:'Space Mono',monospace;font-size:12px;color:#8a8a9a;">
    Dr. Bob's MCAT v5.0 · Fetching Live Data...
  </div>
</div>
</body>
</html>